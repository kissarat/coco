<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>api.views.profile &mdash; mypinnings 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="mypinnings 1.0 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">mypinnings 1.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for api.views.profile</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot; API views responsible for returing and updating the profile info&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">web</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">api.utils</span> <span class="kn">import</span> <span class="n">api_response</span><span class="p">,</span> <span class="n">save_api_request</span><span class="p">,</span> <span class="n">api_response</span><span class="p">,</span> \
    <span class="n">photo_id_to_url</span>
<span class="kn">from</span> <span class="nn">api.views.base</span> <span class="kn">import</span> <span class="n">BaseAPI</span>
<span class="kn">from</span> <span class="nn">api.views.social</span> <span class="kn">import</span> <span class="n">share</span><span class="p">,</span> <span class="n">get_comments_to_photo</span>
<span class="kn">from</span> <span class="nn">api.entities</span> <span class="kn">import</span> <span class="n">UserProfile</span>

<span class="kn">from</span> <span class="nn">mypinnings</span> <span class="kn">import</span> <span class="n">auth</span>
<span class="kn">from</span> <span class="nn">mypinnings</span> <span class="kn">import</span> <span class="n">session</span>
<span class="kn">from</span> <span class="nn">mypinnings.database</span> <span class="kn">import</span> <span class="n">connect_db</span>
<span class="kn">from</span> <span class="nn">mypinnings.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">mypinnings.media</span> <span class="kn">import</span> <span class="n">store_image_from_filename</span>

<span class="kn">from</span> <span class="nn">api.models.user</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">api.models.album</span> <span class="kn">import</span> <span class="n">Album</span>
<span class="kn">from</span> <span class="nn">api.models.picture</span> <span class="kn">import</span> <span class="n">Picture</span>


<span class="n">db</span> <span class="o">=</span> <span class="n">connect_db</span><span class="p">()</span>


<div class="viewcode-block" id="BaseUserProfile"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.BaseUserProfile">[docs]</a><span class="k">class</span> <span class="nc">BaseUserProfile</span><span class="p">(</span><span class="n">BaseAPI</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    General class which holds list of fields used by user profile methods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;about&#39;</span><span class="p">,</span> <span class="s">&#39;city&#39;</span><span class="p">,</span> <span class="s">&#39;country&#39;</span><span class="p">,</span> <span class="s">&#39;hometown&#39;</span><span class="p">,</span>
                        <span class="s">&#39;about&#39;</span><span class="p">,</span> <span class="s">&#39;email&#39;</span><span class="p">,</span> <span class="s">&#39;pic_id&#39;</span><span class="p">,</span> <span class="s">&#39;bg_id&#39;</span><span class="p">,</span> <span class="s">&#39;website&#39;</span><span class="p">,</span> <span class="s">&#39;facebook&#39;</span><span class="p">,</span>
                        <span class="s">&#39;twitter&#39;</span><span class="p">,</span> <span class="s">&#39;getlist_privacy_level&#39;</span><span class="p">,</span> <span class="s">&#39;private&#39;</span><span class="p">,</span>
                        <span class="s">&#39;bgx&#39;</span><span class="p">,</span> <span class="s">&#39;bgy&#39;</span><span class="p">,</span> <span class="s">&#39;show_views&#39;</span><span class="p">,</span> <span class="s">&#39;views&#39;</span><span class="p">,</span> <span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="s">&#39;zip&#39;</span><span class="p">,</span>
                        <span class="s">&#39;linkedin&#39;</span><span class="p">,</span> <span class="s">&#39;gplus&#39;</span><span class="p">,</span> <span class="s">&#39;headerbgy&#39;</span><span class="p">,</span> <span class="s">&#39;headerbgx&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_birthday_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;birthday_year&#39;</span><span class="p">,</span> <span class="s">&#39;birthday_month&#39;</span><span class="p">,</span>
                                 <span class="s">&#39;birthday_day&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;csid_from_client&#39;</span><span class="p">,</span> <span class="s">&#39;logintoken&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;project_id&#39;</span><span class="p">,</span> <span class="s">&#39;os_type&#39;</span><span class="p">,</span> <span class="s">&#39;version_id&#39;</span><span class="p">,</span><span class="s">&#39;format_type&#39;</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="BaseUserProfile.format_birthday"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.BaseUserProfile.format_birthday">[docs]</a>    <span class="k">def</span> <span class="nf">format_birthday</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Composes birthday response, returning year, day and month</span>
<span class="sd">        as separate response fields</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;birthday&#39;</span><span class="p">]:</span>
            <span class="n">response</span><span class="p">[</span><span class="s">&#39;birthday_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;birthday&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">year</span>
            <span class="n">response</span><span class="p">[</span><span class="s">&#39;birthday_day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;birthday&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">day</span>
            <span class="n">response</span><span class="p">[</span><span class="s">&#39;birthday_month&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;birthday&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">month</span>
        <span class="k">return</span> <span class="n">response</span>
</div>
<div class="viewcode-block" id="BaseUserProfile.is_request_valid"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.BaseUserProfile.is_request_valid">[docs]</a>    <span class="k">def</span> <span class="nf">is_request_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if all required parameters are sent from the client.</span>
<span class="sd">        Also checks if no extra arguments was passed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request_data</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">request_data</span><span class="p">:</span>
            <span class="c"># Checking if current field is among the fields we have in the db</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="ow">and</span>
                    <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_birthday_fields</span> <span class="ow">and</span>
                    <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required</span> <span class="ow">and</span>
                    <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_fields</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

</div></div>
<div class="viewcode-block" id="SetPrivacy"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.SetPrivacy">[docs]</a><span class="k">class</span> <span class="nc">SetPrivacy</span><span class="p">(</span><span class="n">BaseUserProfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows to set privacy level of the profile.</span>

<span class="sd">    :link: /api/profile/userinfo/update</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="SetPrivacy.POST"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.SetPrivacy.POST">[docs]</a>    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Updates profile with fields sent from the client,</span>
<span class="sd">        returns saved fields.</span>

<span class="sd">        :param str csid_from_client: csid from client key</span>
<span class="sd">        :param str getlist_privacy_level/private: controls privacy level</span>
<span class="sd">        :param str logintoken: logintoken</span>
<span class="sd">        :response_data: Returns api response with &#39;getlist_privacy_level/private.&#39;</span>
<span class="sd">        :to test: curl --data &quot;logintoken=UaNxct7bJZ&amp;twitter=1&amp;csid_from_client=1&quot; http://localhost:8080/api/profile/userinfo/update</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request_data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>

        <span class="c"># Adding field to the list of required fields</span>
        <span class="c"># self.required.append(&#39;getlist_privacy_level&#39;)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_request_valid</span><span class="p">(</span><span class="n">request_data</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">status</span><span class="o">=</span><span class="mi">405</span><span class="p">,</span>
                                <span class="n">error_code</span><span class="o">=</span><span class="s">&quot;Required args are missing&quot;</span><span class="p">)</span>

        <span class="n">csid_from_client</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;csid_from_client&#39;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">privacy_level</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;getlist_privacy_level&#39;</span><span class="p">)</span>
        <span class="n">private</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;private&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">privacy_level</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;getlist_privacy_level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">privacy_level</span>
        <span class="k">if</span> <span class="n">private</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;private&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">private</span>

        <span class="n">status</span><span class="p">,</span> <span class="n">response_or_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate_by_token</span><span class="p">(</span>
            <span class="n">request_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;logintoken&#39;</span><span class="p">))</span>
        <span class="c"># Login was not successful</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response_or_user</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;users&#39;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&#39;id = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">response_or_user</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]),</span>
                      <span class="o">**</span><span class="n">data</span><span class="p">)</span>

        <span class="n">csid_from_server</span> <span class="o">=</span> <span class="n">response_or_user</span><span class="p">[</span><span class="s">&#39;seriesid&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                            <span class="n">csid_from_client</span><span class="o">=</span><span class="n">csid_from_client</span><span class="p">,</span>
                            <span class="n">csid_from_server</span><span class="o">=</span><span class="n">csid_from_server</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="UserInfoUpdate"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.UserInfoUpdate">[docs]</a><span class="k">class</span> <span class="nc">UserInfoUpdate</span><span class="p">(</span><span class="n">BaseUserProfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines a class responsible for updating user data, inside the profile</span>

<span class="sd">    :link: /api/profile/userinfo/update</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="UserInfoUpdate.POST"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.UserInfoUpdate.POST">[docs]</a>    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;  Updates profile with fields sent from the client,</span>
<span class="sd">        returns saved fields.</span>

<span class="sd">        :param str csid_from_client: Csid string from client</span>
<span class="sd">        :param str logintoken: Logintoken</span>
<span class="sd">        :param str &lt;field&gt;: The field which will be changed</span>
<span class="sd">        :response_data: returns changed field</span>
<span class="sd">        :to test: curl --data &quot;logintoken=UaNxct7bJZ&amp;twitter=1&amp;csid_from_client=1&quot; http://localhost:8080/api/profile/userinfo/update</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request_data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_request_valid</span><span class="p">(</span><span class="n">request_data</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">status</span><span class="o">=</span><span class="mi">405</span><span class="p">,</span>
                                <span class="n">error_code</span><span class="o">=</span><span class="s">&quot;Required args are missing&quot;</span><span class="p">)</span>
        <span class="n">csid_from_client</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;csid_from_client&#39;</span><span class="p">)</span>

        <span class="n">status</span><span class="p">,</span> <span class="n">response_or_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate_by_token</span><span class="p">(</span>
            <span class="n">request_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;logintoken&#39;</span><span class="p">))</span>
        <span class="c"># Login was not successful</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response_or_user</span>
        <span class="n">to_insert</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">birthday</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">request_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_birthday_fields</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">birthday</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="n">error_code</span> <span class="o">=</span> <span class="s">&quot;Birthday date incomplete&quot;</span>
            <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">status</span><span class="o">=</span><span class="mi">405</span><span class="p">,</span> <span class="n">error_code</span><span class="o">=</span><span class="n">error_code</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">birthday</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">to_insert</span><span class="p">[</span><span class="s">&#39;birthday&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">birthday</span><span class="p">),</span>
                                                      <span class="s">&quot;%Y-</span><span class="si">%d</span><span class="s">-%m&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">to_insert</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_insert</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;users&#39;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&#39;id = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">response_or_user</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]),</span>
                      <span class="o">**</span><span class="n">to_insert</span><span class="p">)</span>
        <span class="n">csid_from_server</span> <span class="o">=</span> <span class="n">response_or_user</span><span class="p">[</span><span class="s">&#39;seriesid&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request_data</span><span class="p">,</span>
                            <span class="n">csid_from_client</span><span class="o">=</span><span class="n">csid_from_client</span><span class="p">,</span>
                            <span class="n">csid_from_server</span><span class="o">=</span><span class="n">csid_from_server</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="GetProfileInfo"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.GetProfileInfo">[docs]</a><span class="k">class</span> <span class="nc">GetProfileInfo</span><span class="p">(</span><span class="n">BaseUserProfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Allows to render profile information, by token</span>

<span class="sd">    :url: /api/profile/userinfo/get</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="GetProfileInfo.POST"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.GetProfileInfo.POST">[docs]</a>    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param str csid_from_client: Csid string from client</span>
<span class="sd">        :param str logintoken: Logintoken</span>

<span class="sd">        :response_data: &#39;id&#39;, &#39;name&#39;, &#39;about&#39;, &#39;city&#39;, &#39;country&#39;,&#39;hometown&#39;, &#39;about&#39;, &#39;email&#39;, &#39;pic&#39;, &#39;website&#39;, &#39;facebook&#39;, &#39;twitter&#39;, &#39;getlist_privacy_level&#39;, &#39;private&#39;, &#39;bg&#39;, &#39;bgx&#39;, &#39;bgy&#39;, &#39;show_views&#39;, &#39;views&#39;, &#39;username&#39;, &#39;zip&#39;, &#39;linkedin&#39;, &#39;gplus&#39;, &#39;bg_resized_url&#39;, &#39;headerbgy&#39;, &#39;headerbgx&#39;</span>
<span class="sd">        :to test: curl --data &quot;logintoken=UaNxct7bJZ&amp;csid_from_client=123&quot; http://localhost:8080/api/profile/userinfo/get</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request_data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_request_valid</span><span class="p">(</span><span class="n">request_data</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">status</span><span class="o">=</span><span class="mi">405</span><span class="p">,</span>
                                <span class="n">error_code</span><span class="o">=</span><span class="s">&quot;Required args are missing&quot;</span><span class="p">)</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">response_or_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate_by_token</span><span class="p">(</span>
            <span class="n">request_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;logintoken&#39;</span><span class="p">))</span>

        <span class="c"># User id contains error code</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response_or_user</span>

        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="n">response_or_user</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">}</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;resized_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">photo_id_to_url</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;pic_id&#39;</span><span class="p">])</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;bg_resized_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">photo_id_to_url</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;bg_id&#39;</span><span class="p">])</span>
        <span class="n">csid_from_client</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;csid_from_client&#39;</span><span class="p">)</span>
        <span class="n">csid_from_server</span> <span class="o">=</span> <span class="n">response_or_user</span><span class="p">[</span><span class="s">&#39;seriesid&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_birthday</span><span class="p">(</span><span class="n">response_or_user</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">response</span><span class="p">,</span>
                            <span class="n">csid_from_client</span><span class="o">=</span><span class="n">csid_from_client</span><span class="p">,</span>
                            <span class="n">csid_from_server</span><span class="o">=</span><span class="n">csid_from_server</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="ProfileInfo"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.ProfileInfo">[docs]</a><span class="k">class</span> <span class="nc">ProfileInfo</span><span class="p">(</span><span class="n">BaseUserProfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns public profile information</span>

<span class="sd">    :url: /api/profile/userinfo/info</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ProfileInfo.POST"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.ProfileInfo.POST">[docs]</a>    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param str csid_from_client: Csid string from client</span>
<span class="sd">        :param str logintoken: Logintoken</span>
<span class="sd">        :param str username: Username</span>
<span class="sd">        :param str username: id</span>
<span class="sd">        :response_data: &#39;id&#39;, &#39;name&#39;, &#39;about&#39;, &#39;city&#39;, &#39;country&#39;,&#39;hometown&#39;, &#39;about&#39;, &#39;email&#39;, &#39;pic&#39;, &#39;website&#39;, &#39;facebook&#39;, &#39;twitter&#39;, &#39;getlist_privacy_level&#39;, &#39;private&#39;, &#39;bg&#39;, &#39;bgx&#39;, &#39;bgy&#39;, &#39;show_views&#39;, &#39;views&#39;, &#39;username&#39;, &#39;zip&#39;, &#39;linkedin&#39;, &#39;gplus&#39;, &#39;bg_resized_url&#39;, &#39;headerbgy&#39;, &#39;headerbgx&#39;</span>

<span class="sd">        :to test:</span>
<span class="sd">        - curl --data &quot;csid_from_client=11&amp;id=78&amp;logintoken=RxPu7fLYgv&quot; http://localhost:8080/api/profile/userinfo/info</span>
<span class="sd">        - curl --data &quot;csid_from_client=11&amp;username=Oleg&amp;logintoken=RxPu7fLYgv&quot; http://localhost:8080/api/profile/userinfo/info</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request_data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">logintoken</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;logintoken&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_request_valid</span><span class="p">(</span><span class="n">request_data</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">status</span><span class="o">=</span><span class="mi">405</span><span class="p">,</span>
                                <span class="n">error_code</span><span class="o">=</span><span class="s">&quot;Required args are missing&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">profile</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
            <span class="n">error_code</span> <span class="o">=</span> <span class="s">&quot;This function requires either profile or user_id&quot;</span>
            <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">status</span><span class="o">=</span><span class="mi">405</span><span class="p">,</span>
                                <span class="n">error_code</span><span class="o">=</span><span class="n">error_code</span><span class="p">)</span>

        <span class="n">status</span><span class="p">,</span> <span class="n">response_or_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate_by_token</span><span class="p">(</span><span class="n">logintoken</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">status</span><span class="o">=</span><span class="mi">405</span><span class="p">,</span>
                                <span class="n">error_code</span><span class="o">=</span><span class="s">&quot;You need to log in first&quot;</span><span class="p">)</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="o">.</span><span class="n">query_user</span><span class="p">(</span><span class="n">profile</span><span class="o">=</span><span class="n">profile</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">status</span><span class="o">=</span><span class="mi">405</span><span class="p">,</span>
                                <span class="n">error_code</span><span class="o">=</span><span class="s">&quot;User was not found&quot;</span><span class="p">)</span>
        <span class="n">followers</span> <span class="o">=</span> <span class="n">UserProfile</span>\
            <span class="o">.</span><span class="n">query_followed_by</span><span class="p">(</span><span class="n">profile_owner</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                               <span class="n">current_user</span><span class="o">=</span><span class="n">response_or_user</span><span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">])</span>
        <span class="n">user</span><span class="o">.</span><span class="n">follower_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">followers</span><span class="p">)</span>

        <span class="n">follow</span> <span class="o">=</span> <span class="n">UserProfile</span>\
            <span class="o">.</span><span class="n">query_following</span><span class="p">(</span><span class="n">profile_owner</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                             <span class="n">current_user</span><span class="o">=</span><span class="n">response_or_user</span><span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">])</span>
        <span class="n">user</span><span class="o">.</span><span class="n">follow_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">follow</span><span class="p">)</span>

        <span class="n">csid_from_client</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;csid_from_client&#39;</span><span class="p">)</span>
        <span class="n">csid_from_server</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">to_serializable_dict</span><span class="p">(),</span>
                            <span class="n">csid_from_client</span><span class="o">=</span><span class="n">csid_from_client</span><span class="p">,</span>
                            <span class="n">csid_from_server</span><span class="o">=</span><span class="n">csid_from_server</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="ProfileInfo.get_user_info"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.ProfileInfo.get_user_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_user_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;users&#39;</span><span class="p">,</span>
                          <span class="nb">vars</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="n">profile</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">},</span>
                          <span class="n">where</span><span class="o">=</span><span class="s">&quot;username=$username or id=$id&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">list</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">user</span><span class="p">[</span><span class="s">&#39;pic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">photo_id_to_url</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;pic&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="p">:</span> <span class="n">user</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_birthday</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</div></div>
<div class="viewcode-block" id="UpdateProfileViews"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.UpdateProfileViews">[docs]</a><span class="k">class</span> <span class="nc">UpdateProfileViews</span><span class="p">(</span><span class="n">BaseUserProfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Responsible for updating count of pofile views</span>

<span class="sd">    :link: /api/profile/updateviews/&lt;username&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="UpdateProfileViews.POST"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.UpdateProfileViews.POST">[docs]</a>    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">profile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param str csid_from_client: Csid string from client</span>
<span class="sd">        :param str profile: must be in url</span>
<span class="sd">        :response_data: returns a dict with &#39;status&#39; key</span>
<span class="sd">        :to test: curl --data &quot;csid_from_client=11&amp;logintoken=RxPu7fLYgv&quot; http://localhost:8080/api/profile/updateviews/oleg</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request_data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_request_valid</span><span class="p">(</span><span class="n">request_data</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">status</span><span class="o">=</span><span class="mi">405</span><span class="p">,</span>
                                <span class="n">error_code</span><span class="o">=</span><span class="s">&quot;Required args are missing&quot;</span><span class="p">)</span>

        <span class="c"># Checking if user has a valid logintoken</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">response_or_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate_by_token</span><span class="p">(</span>
            <span class="n">request_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;logintoken&#39;</span><span class="p">))</span>
        <span class="c"># Login was not successful</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response_or_user</span>

        <span class="n">db</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;users&#39;</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&#39;user = $username&#39;</span><span class="p">,</span>
                  <span class="nb">vars</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;username&#39;</span><span class="p">:</span> <span class="n">profile</span><span class="p">},</span>
                  <span class="n">views</span><span class="o">=</span><span class="n">web</span><span class="o">.</span><span class="n">SQLLiteral</span><span class="p">(</span><span class="s">&#39;views + 1&#39;</span><span class="p">))</span>

        <span class="n">csid_from_client</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;csid_from_client&#39;</span><span class="p">)</span>
        <span class="n">csid_from_server</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span> <span class="s">&quot;success&quot;</span><span class="p">},</span>
                            <span class="n">csid_from_client</span><span class="o">=</span><span class="n">csid_from_client</span><span class="p">,</span>
                            <span class="n">csid_from_server</span><span class="o">=</span><span class="n">csid_from_server</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="ManageGetList"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.ManageGetList">[docs]</a><span class="k">class</span> <span class="nc">ManageGetList</span><span class="p">(</span><span class="n">BaseAPI</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :link: /api/profile/mgl</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ManageGetList.POST"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.ManageGetList.POST">[docs]</a>    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manage list of user products: sharing, add, remove</span>

<span class="sd">        Method for image_id_share_list must additional receive next</span>
<span class="sd">        :param str csid_from_client: Csid string from client</span>
<span class="sd">        :param str logintoken: Logintoken</span>
<span class="sd">        :param str social_network: e.g. facebook</span>
<span class="sd">        :response_data: returns added/removed/shared getlists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request_data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">input</span><span class="p">(</span>
            <span class="n">image_id_remove_list</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">image_id_share_list</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">image_id_add_list</span><span class="o">=</span><span class="p">[],</span>
        <span class="p">)</span>

        <span class="c"># Setting default status code as 200</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="c"># Setting empty error</span>
        <span class="n">error_code</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="n">save_api_request</span><span class="p">(</span><span class="n">request_data</span><span class="p">)</span>
        <span class="n">login_token</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;logintoken&quot;</span><span class="p">)</span>

        <span class="n">status_success</span><span class="p">,</span> <span class="n">response_or_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate_by_token</span><span class="p">(</span><span class="n">login_token</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status_success</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response_or_user</span>

        <span class="n">csid_from_client</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;csid_from_client&#39;</span><span class="p">)</span>

        <span class="n">access_token</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;access_token&quot;</span><span class="p">)</span>
        <span class="n">social_network</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;social_network&quot;</span><span class="p">)</span>

        <span class="n">image_id_add_list</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;image_id_add_list&quot;</span><span class="p">))</span>
        <span class="n">add_list_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_id_add_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">add_list_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">response_or_user</span><span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">],</span>
                                       <span class="n">image_id_add_list</span><span class="p">)</span>

        <span class="n">image_id_remove_list</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span>
                                   <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;image_id_remove_list&quot;</span><span class="p">))</span>
        <span class="n">remove_list_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_id_remove_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">remove_list_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">response_or_user</span><span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">],</span>
                                             <span class="n">image_id_remove_list</span><span class="p">)</span>

        <span class="n">image_id_share_list</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;image_id_share_list&quot;</span><span class="p">))</span>
        <span class="n">share_list_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_id_share_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Check input social data for posting</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">access_token</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">social_network</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">400</span>
                <span class="n">error_code</span> <span class="o">=</span> <span class="s">&quot;Invalid input data&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">share_list_result</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">error_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharing</span><span class="p">(</span><span class="n">access_token</span><span class="p">,</span> <span class="n">social_network</span><span class="p">,</span>
                                                                 <span class="n">image_id_share_list</span><span class="p">)</span>

        <span class="n">csid_from_server</span> <span class="o">=</span> <span class="n">response_or_user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;seriesid&#39;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;added&quot;</span><span class="p">:</span> <span class="n">add_list_result</span><span class="p">,</span>
            <span class="s">&quot;removed&quot;</span><span class="p">:</span> <span class="n">remove_list_result</span><span class="p">,</span>
            <span class="s">&quot;shared&quot;</span><span class="p">:</span> <span class="n">share_list_result</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
                                <span class="n">error_code</span><span class="o">=</span><span class="n">error_code</span><span class="p">,</span>
                                <span class="n">csid_from_client</span><span class="o">=</span><span class="n">csid_from_client</span><span class="p">,</span>
                                <span class="n">csid_from_server</span><span class="o">=</span><span class="n">csid_from_server</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</div>
<div class="viewcode-block" id="ManageGetList.add"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.ManageGetList.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">add_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add new products to user profile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">add_list_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">add_list</span><span class="p">:</span>
            <span class="n">user_product</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s">&quot;pin_id&quot;</span><span class="p">:</span> <span class="n">pin</span><span class="p">}</span>
            <span class="n">exist_product</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="s">&#39;user_prefered_pins&#39;</span><span class="p">,</span>
                <span class="n">where</span><span class="o">=</span><span class="n">web</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">sqlwhere</span><span class="p">(</span><span class="n">user_product</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exist_product</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">add_list_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&#39;user_prefered_pins&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">pin_id</span><span class="o">=</span><span class="n">pin</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">add_list_result</span>
</div>
<div class="viewcode-block" id="ManageGetList.remove"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.ManageGetList.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">remove_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove products from user profile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">remove_list_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">remove_list</span><span class="p">:</span>
            <span class="n">user_product</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;user_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s">&quot;pin_id&quot;</span><span class="p">:</span> <span class="n">pin</span><span class="p">}</span>
            <span class="n">exist_product</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
                <span class="s">&#39;user_prefered_pins&#39;</span><span class="p">,</span>
                <span class="n">where</span><span class="o">=</span><span class="n">web</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">sqlwhere</span><span class="p">(</span><span class="n">user_product</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exist_product</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">remove_list_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                    <span class="s">&#39;user_prefered_pins&#39;</span><span class="p">,</span>
                    <span class="n">where</span><span class="o">=</span><span class="n">web</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">sqlwhere</span><span class="p">(</span><span class="n">user_product</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">remove_list_result</span>
</div>
<div class="viewcode-block" id="ManageGetList.sharing"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.ManageGetList.sharing">[docs]</a>    <span class="k">def</span> <span class="nf">sharing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">access_token</span><span class="p">,</span> <span class="n">social_network</span><span class="p">,</span> <span class="n">share_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Share products from user profile</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">share_list_result</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">error_code</span> <span class="o">=</span> <span class="n">share</span><span class="p">(</span><span class="n">access_token</span><span class="p">,</span>
                                                      <span class="n">share_list</span><span class="p">,</span>
                                                      <span class="n">social_network</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">share_list_result</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">error_code</span>

</div></div>
<div class="viewcode-block" id="ChangePassword"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.ChangePassword">[docs]</a><span class="k">class</span> <span class="nc">ChangePassword</span><span class="p">(</span><span class="n">BaseAPI</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :link: /api/profile/pwd</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="ChangePassword.POST"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.ChangePassword.POST">[docs]</a>    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Change user password and get/store new logintoken</span>
<span class="sd">        :param str csid_from_client: Csid string from client</span>
<span class="sd">        :param str logintoken: Logintoken</span>
<span class="sd">        :param str old_password: current password of the user</span>
<span class="sd">        :param str new_password, new_password2: The new password typed 2 times</span>

<span class="sd">        :response_data: new clinet token</span>
<span class="sd">        :to test:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request_data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>
        <span class="n">save_api_request</span><span class="p">(</span><span class="n">request_data</span><span class="p">)</span>
        <span class="n">client_token</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;logintoken&quot;</span><span class="p">)</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">response_or_user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate_by_token</span><span class="p">(</span><span class="n">client_token</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">response_or_user</span>

        <span class="n">old_password</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;old_password&quot;</span><span class="p">)</span>
        <span class="n">new_password</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;new_password&quot;</span><span class="p">)</span>
        <span class="n">new_password2</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;new_password2&quot;</span><span class="p">)</span>

        <span class="n">pw_salt</span> <span class="o">=</span> <span class="n">response_or_user</span><span class="p">[</span><span class="s">&#39;pw_salt&#39;</span><span class="p">]</span>
        <span class="n">pw_hash</span> <span class="o">=</span> <span class="n">response_or_user</span><span class="p">[</span><span class="s">&#39;pw_hash&#39;</span><span class="p">]</span>

        <span class="n">status</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">passwords_validation</span><span class="p">(</span><span class="n">pw_salt</span><span class="p">,</span> <span class="n">pw_hash</span><span class="p">,</span>
                                                  <span class="n">old_password</span><span class="p">,</span> <span class="n">new_password</span><span class="p">,</span>
                                                  <span class="n">new_password2</span><span class="p">,</span>
                                                  <span class="n">response_or_user</span><span class="p">[</span><span class="s">&quot;username&quot;</span><span class="p">],</span>
                                                  <span class="n">response_or_user</span><span class="p">[</span><span class="s">&quot;email&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
            <span class="n">new_password_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_password</span><span class="p">(</span><span class="n">pw_salt</span><span class="p">,</span> <span class="n">new_password</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s">&#39;users&#39;</span><span class="p">,</span> <span class="n">pw_hash</span><span class="o">=</span><span class="n">new_password_hash</span><span class="p">,</span>
                      <span class="nb">vars</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">response_or_user</span><span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">]},</span> <span class="n">where</span><span class="o">=</span><span class="s">&quot;id=$id&quot;</span><span class="p">)</span>

            <span class="c"># re_login user with new password</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get_session</span><span class="p">()</span>
            <span class="n">auth</span><span class="o">.</span><span class="n">login_user</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">response_or_user</span><span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">])</span>

            <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;users&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">response_or_user</span><span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">]},</span>
                             <span class="n">where</span><span class="o">=</span><span class="s">&#39;id=$id&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">new_client_token</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;logintoken&#39;</span><span class="p">)</span>
            <span class="n">csid_from_server</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;seriesid&#39;</span><span class="p">)</span>
            <span class="n">csid_from_client</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;csid_from_client&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&quot;client_token&quot;</span><span class="p">:</span> <span class="n">new_client_token</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">csid_from_client</span><span class="p">,</span>
                                    <span class="n">csid_from_server</span><span class="o">=</span><span class="n">csid_from_server</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;users&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">response_or_user</span><span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">]},</span>
                             <span class="n">where</span><span class="o">=</span><span class="s">&#39;id=$id&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">csid_from_server</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;seriesid&#39;</span><span class="p">)</span>
            <span class="n">csid_from_client</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;csid_from_client&quot;</span><span class="p">)</span>

            <span class="n">response</span> <span class="o">=</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                                    <span class="n">status</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
                                    <span class="n">error_code</span><span class="o">=</span><span class="n">error</span><span class="p">,</span>
                                    <span class="n">csid_from_client</span><span class="o">=</span><span class="n">csid_from_client</span><span class="p">,</span>
                                    <span class="n">csid_from_server</span><span class="o">=</span><span class="n">csid_from_server</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>
</div>
<div class="viewcode-block" id="ChangePassword.passwords_validation"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.ChangePassword.passwords_validation">[docs]</a>    <span class="k">def</span> <span class="nf">passwords_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pw_salt</span><span class="p">,</span> <span class="n">pw_hash</span><span class="p">,</span> <span class="n">old_pwd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                             <span class="n">new_pwd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">new_pwd2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">uname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                             <span class="n">email</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if new password match with confirmation.</span>
<span class="sd">        Check relevance old password.</span>
<span class="sd">        Check empty field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_pwd</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_denied</span><span class="p">(</span><span class="s">&quot;New password is empty&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">old_pwd</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_denied</span><span class="p">(</span><span class="s">&quot;Old password is empty&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_pwd</span> <span class="o">!=</span> <span class="n">new_pwd2</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_denied</span><span class="p">(</span><span class="s">&quot;Passwords do not match&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">old_pwd</span><span class="p">))</span> <span class="o">+</span> <span class="n">pw_salt</span><span class="p">))</span> <span class="o">!=</span> <span class="n">pw_hash</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">access_denied</span><span class="p">(</span><span class="s">&quot;Incorrect old password&quot;</span><span class="p">)</span>

        <span class="n">pwd_status</span><span class="p">,</span> <span class="n">error_code</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">check_password</span><span class="p">(</span><span class="n">uname</span><span class="p">,</span> <span class="n">new_pwd</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pwd_status</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">error_code</span>

        <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&quot;Success&quot;</span>
</div>
<div class="viewcode-block" id="ChangePassword.create_password"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.ChangePassword.create_password">[docs]</a>    <span class="k">def</span> <span class="nf">create_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pw_salt</span><span class="p">,</span> <span class="n">new_pwd</span><span class="p">):</span>
        <span class="n">new_pwd_hash</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">new_pwd</span><span class="p">))</span>
        <span class="n">new_pwd_hash</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">new_pwd_hash</span> <span class="o">+</span> <span class="n">pw_salt</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">new_pwd_hash</span>

</div></div>
<div class="viewcode-block" id="QueryBoards"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.QueryBoards">[docs]</a><span class="k">class</span> <span class="nc">QueryBoards</span><span class="p">(</span><span class="n">BaseAPI</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class responsible for getting boards of a given user</span>

<span class="sd">    :link: /api/profile/userinfo/boards</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="QueryBoards.POST"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.QueryBoards.POST">[docs]</a>    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns all boards associated with a given user</span>

<span class="sd">        :param str csid_from_client: Csid string from client</span>
<span class="sd">        :param str user_id: id of the queried user</span>
<span class="sd">        :param str current_user_id: id of current user</span>
<span class="sd">        :response_data: returns all boards of a given user as a list</span>
<span class="sd">        :to test: curl --data &quot;user_id=2&amp;csid_from_client=1&quot; http://localhost:8080/api/profile/userinfo/boards</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request_data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>
        <span class="n">csid_from_client</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;csid_from_client&#39;</span><span class="p">)</span>
        <span class="n">csid_from_server</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">current_user_id</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;current_user_id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user_id&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">status</span><span class="o">=</span><span class="mi">405</span><span class="p">,</span>
                                <span class="n">error_code</span><span class="o">=</span><span class="s">&quot;Missing user_id&quot;</span><span class="p">)</span>
        <span class="n">boards_query</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        SELECT b.id, b.name, b.description, bf.follower_id is not null</span>
<span class="s">        as is_following FROM boards b</span>
<span class="s">        LEFT JOIN boards_followers bf on bf.board_id = b.id</span>
<span class="s">        and bf.follower_id = $cid WHERE b.user_id=$uid;</span>
<span class="s">        &quot;&quot;&quot;</span>
        <span class="n">boards_tmp</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">boards_query</span><span class="p">,</span>
                              <span class="nb">vars</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;uid&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span> <span class="s">&#39;cid&#39;</span><span class="p">:</span> <span class="n">current_user_id</span><span class="p">})</span>

        <span class="n">boards</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">board</span> <span class="ow">in</span> <span class="n">boards_tmp</span><span class="p">:</span>
            <span class="n">pins_from_board</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;pins&#39;</span><span class="p">,</span>
                               <span class="n">where</span><span class="o">=</span><span class="s">&#39;board_id=$board_id&#39;</span><span class="p">,</span>
                               <span class="nb">vars</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;board_id&#39;</span><span class="p">:</span> <span class="n">board</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]})</span>
            <span class="n">board</span><span class="p">[</span><span class="s">&#39;pins_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pin_from_board</span> <span class="ow">in</span> <span class="n">pins_from_board</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pin_from_board</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">board</span><span class="p">[</span><span class="s">&#39;pins_ids&#39;</span><span class="p">]:</span>
                    <span class="n">board</span><span class="p">[</span><span class="s">&#39;pins_ids&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pin_from_board</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>
            <span class="n">boards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">boards</span><span class="p">,</span>
                            <span class="n">csid_from_server</span><span class="o">=</span><span class="n">csid_from_server</span><span class="p">,</span>
                            <span class="n">csid_from_client</span><span class="o">=</span><span class="n">csid_from_client</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="QueryPins"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.QueryPins">[docs]</a><span class="k">class</span> <span class="nc">QueryPins</span><span class="p">(</span><span class="n">BaseAPI</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Responsible for getting pins of a given user</span>

<span class="sd">    :url: /api/profile/userinfo/pins</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="QueryPins.POST"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.QueryPins.POST">[docs]</a>    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Returns all pins associated with a given user</span>

<span class="sd">        :param str csid_from_client: Csid string from client</span>
<span class="sd">        :param str user_id: id of the queried user</span>
<span class="sd">        :response_data: Returns list of pins of a current user</span>

<span class="sd">        :to test: curl --data &quot;user_id=78&amp;csid_from_client=1&quot; http://localhost:8080/api/profile/userinfo/pins</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">        select tags.tags, pins.*, users.pic_id as user_pic,</span>
<span class="s">        users.username as user_username, users.name as user_name,</span>
<span class="s">        count(distinct p1) as repin_count,</span>
<span class="s">        count(distinct l1) as like_count</span>
<span class="s">        from users</span>
<span class="s">        left join pins on pins.user_id = users.id</span>
<span class="s">        left join tags on tags.pin_id = pins.id</span>
<span class="s">        left join pins p1 on p1.repin = pins.id</span>
<span class="s">        left join likes l1 on l1.pin_id = pins.id</span>
<span class="s">        where users.id = $id</span>
<span class="s">        group by tags.tags, pins.id, users.id</span>
<span class="s">        order by timestamp desc&#39;&#39;&#39;</span>

        <span class="n">request_data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>
        <span class="n">csid_from_client</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;csid_from_client&#39;</span><span class="p">)</span>
        <span class="n">csid_from_server</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;user_id&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">status</span><span class="o">=</span><span class="mi">405</span><span class="p">,</span>
                                <span class="n">error_code</span><span class="o">=</span><span class="s">&quot;Missing user_id&quot;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">})</span>

        <span class="n">pins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_row</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">pins_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">owned_pins_counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">current_row</span> <span class="ow">or</span> <span class="n">current_row</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="n">current_row</span> <span class="o">=</span> <span class="n">row</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">tags</span>
                <span class="n">current_row</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
                    <span class="n">current_row</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>

                <span class="n">current_row_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">current_row</span><span class="o">.</span><span class="n">timestamp</span><span class="p">)</span>

                <span class="n">pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_row</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">current_row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;repin&quot;</span><span class="p">):</span>
                    <span class="n">owned_pins_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tag</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">tags</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_row</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
                    <span class="n">current_row</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">pins_counter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;total&quot;</span><span class="p">:</span> <span class="n">pins_counter</span><span class="p">,</span>
            <span class="s">&quot;total_owned&quot;</span><span class="p">:</span> <span class="n">owned_pins_counter</span>
        <span class="p">}</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;page&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">page</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">items_per_page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;items_per_page&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">items_per_page</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">items_per_page</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">data</span><span class="p">[</span><span class="s">&#39;pages_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pins</span><span class="p">))</span> <span class="o">/</span>
                                            <span class="nb">float</span><span class="p">(</span><span class="n">items_per_page</span><span class="p">))</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;pages_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;pages_count&#39;</span><span class="p">])</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">page</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;items_per_page&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">items_per_page</span>

            <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">page</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">items_per_page</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">items_per_page</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;pins_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pins</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&#39;pins_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pins</span>

        <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                            <span class="n">csid_from_server</span><span class="o">=</span><span class="n">csid_from_server</span><span class="p">,</span>
                            <span class="n">csid_from_client</span><span class="o">=</span><span class="n">csid_from_client</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="TestUsernameOrEmail"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.TestUsernameOrEmail">[docs]</a><span class="k">class</span> <span class="nc">TestUsernameOrEmail</span><span class="p">(</span><span class="n">BaseAPI</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if given username or email is already added to database.</span>
<span class="sd">    in case if a username</span>

<span class="sd">    :link: /api/profile/test-username</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="TestUsernameOrEmail.POST"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.TestUsernameOrEmail.POST">[docs]</a>    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param str csid_from_client: Csid string from client</span>
<span class="sd">        :param str logintoken: username_or_email</span>
<span class="sd">        :response data: returns &#39;ok&#39; or &#39;notfound&#39;</span>
<span class="sd">        :to test: curl --data &quot;csid_from_client=1&amp;username_or_email=oleg&quot; http://localhost:8080/api/profile/test-username</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request_data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>
        <span class="n">username_or_email</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;username_or_email&#39;</span><span class="p">)</span>

        <span class="nb">vars</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;username_or_email&#39;</span><span class="p">:</span> <span class="n">username_or_email</span><span class="p">}</span>
        <span class="c"># Trying to find a user with same username</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;users&#39;</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="nb">vars</span><span class="p">,</span>
                           <span class="n">where</span><span class="o">=</span><span class="s">&#39;username=$username_or_email&#39;</span><span class="p">)</span>
        <span class="c"># Fallback, trying to find user with same email</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">list</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s">&#39;users&#39;</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="nb">vars</span><span class="p">,</span>
                               <span class="n">where</span><span class="o">=</span><span class="s">&#39;email=$username_or_email&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">list</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;notfound&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s">&#39;ok&#39;</span>

        <span class="n">csid_from_client</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;csid_from_client&#39;</span><span class="p">)</span>
        <span class="n">csid_from_server</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
                            <span class="n">csid_from_server</span><span class="o">=</span><span class="n">csid_from_server</span><span class="p">,</span>
                            <span class="n">csid_from_client</span><span class="o">=</span><span class="n">csid_from_client</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="PicUpload"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.PicUpload">[docs]</a><span class="k">class</span> <span class="nc">PicUpload</span><span class="p">(</span><span class="n">BaseAPI</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upload profile picture and save it in database</span>

<span class="sd">    :link: /api/profile/userinfo/upload_pic</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="PicUpload.POST"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.PicUpload.POST">[docs]</a>    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param str csid_from_client: Csid string from client</span>
<span class="sd">        :param str logintoken: logintoken of user</span>
<span class="sd">        :param file file: file for saving</span>
<span class="sd">        :response data: returns id, original_url, resized_url of saved picture</span>
<span class="sd">        :to test: curl -F &quot;csid_from_client=1&quot; -F &quot;logintoken=AmWG6AhgPO&quot; -F &quot;file=@/image/for/test.jpg&quot; http://localhost:8080/api/profile/userinfo/upload_pic</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">csid_from_server</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">error_code</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="n">request_data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="p">{})</span>
        <span class="n">logintoken</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;logintoken&#39;</span><span class="p">)</span>

        <span class="n">user_status</span><span class="p">,</span> <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate_by_token</span><span class="p">(</span><span class="n">logintoken</span><span class="p">)</span>
        <span class="c"># User id contains error code</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_status</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">user</span>

        <span class="n">csid_from_server</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;seriesid&#39;</span><span class="p">]</span>
        <span class="n">csid_from_client</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;csid_from_client&quot;</span><span class="p">)</span>

        <span class="n">file_obj</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;file&#39;</span><span class="p">)</span>

        <span class="c"># For some reason, FileStorage object treats itself as False</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">file_obj</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">status</span><span class="o">=</span><span class="mi">405</span><span class="p">,</span>
                                <span class="n">error_code</span><span class="o">=</span><span class="s">&quot;Required args are missing&quot;</span><span class="p">)</span>

        <span class="n">album</span><span class="p">,</span> <span class="n">album_created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_album</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="s">&#39;photos&#39;</span><span class="p">)</span>
        <span class="n">photo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_in_database</span><span class="p">(</span><span class="n">file_obj</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="n">album</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="n">user_to_update</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>\
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="n">user_to_update</span><span class="o">.</span><span class="n">pic_obj</span> <span class="o">=</span> <span class="n">photo</span>
        <span class="k">if</span> <span class="n">album_created</span><span class="p">:</span>
            <span class="n">album</span><span class="o">.</span><span class="n">cover</span> <span class="o">=</span> <span class="n">photo</span>
        <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">data</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">photo</span><span class="o">.</span><span class="n">id</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;original_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">photo</span><span class="o">.</span><span class="n">original_url</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;resized_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">photo</span><span class="o">.</span><span class="n">resized_url</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
                                <span class="n">error_code</span><span class="o">=</span><span class="n">error_code</span><span class="p">,</span>
                                <span class="n">csid_from_client</span><span class="o">=</span><span class="n">csid_from_client</span><span class="p">,</span>
                                <span class="n">csid_from_server</span><span class="o">=</span><span class="n">csid_from_server</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>
</div>
    <span class="k">def</span> <span class="nf">_get_or_create_album</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">slug</span><span class="p">):</span>
        <span class="n">album</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Album</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Album</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">,</span>
                                               <span class="n">Album</span><span class="o">.</span><span class="n">slug</span> <span class="o">==</span> <span class="n">slug</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">created</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">album</span><span class="p">:</span>
            <span class="n">album</span> <span class="o">=</span> <span class="n">Album</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">slug</span><span class="p">)</span>

            <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">album</span><span class="p">)</span>
            <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">created</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="n">album</span><span class="p">,</span> <span class="n">created</span>

    <span class="k">def</span> <span class="nf">_save_in_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_obj</span><span class="p">,</span> <span class="n">resized_size</span><span class="p">,</span> <span class="n">album_id</span><span class="p">):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_file</span><span class="p">(</span><span class="n">file_obj</span><span class="p">)</span>
        <span class="n">images_dict</span> <span class="o">=</span> <span class="n">store_image_from_filename</span><span class="p">(</span><span class="n">db</span><span class="p">,</span>
                                                <span class="n">file_path</span><span class="p">,</span>
                                                <span class="n">widths</span><span class="o">=</span><span class="p">[</span><span class="n">resized_size</span><span class="p">])</span>

        <span class="n">picture</span> <span class="o">=</span> <span class="n">Picture</span><span class="p">(</span>
            <span class="n">album_id</span><span class="p">,</span>
            <span class="n">images_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;url&#39;</span><span class="p">],</span>
            <span class="n">images_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resized_size</span><span class="p">,</span> <span class="n">images_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>\
                <span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;url&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">picture</span><span class="p">)</span>
        <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">picture</span>

    <span class="k">def</span> <span class="nf">_save_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_obj</span><span class="p">,</span> <span class="n">upload_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves uploaded file to a given upload dir.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">upload_dir</span><span class="p">:</span>
            <span class="n">upload_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_media_path</span><span class="p">()</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">file_obj</span><span class="o">.</span><span class="n">filename</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_file_name</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">upload_dir</span><span class="p">)</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upload_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">upload_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">upload_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_obj</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">upload_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">filepath</span>

    <span class="k">def</span> <span class="nf">_get_media_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns or creates media directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">media_path</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_PATH</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">media_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">media_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">media_path</span>

    <span class="k">def</span> <span class="nf">_get_file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">upload_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method responsible for avoiding duplicated filenames.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upload_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="c"># Suggest uuid hex as a filename to avoid duplicates</span>
        <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filename</span>

</div>
<div class="viewcode-block" id="BgUpload"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.BgUpload">[docs]</a><span class="k">class</span> <span class="nc">BgUpload</span><span class="p">(</span><span class="n">PicUpload</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upload profile background and save it in database</span>

<span class="sd">    :link: /api/profile/userinfo/upload_bg</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="BgUpload.POST"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.BgUpload.POST">[docs]</a>    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param str csid_from_client: Csid string from client</span>
<span class="sd">        :param str logintoken: logintoken of user</span>
<span class="sd">        :param file file: file for saving</span>
<span class="sd">        :response data: returns id, original_url, resized_url of saved picture</span>
<span class="sd">        :to test: curl -F &quot;csid_from_client=1&quot; -F &quot;logintoken=AmWG6AhgPO&quot; -F &quot;file=@/image/for/test.jpg&quot; http://localhost:8080/api/profile/userinfo/upload_bg</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">csid_from_server</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">error_code</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="n">request_data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="p">{})</span>
        <span class="n">logintoken</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;logintoken&#39;</span><span class="p">)</span>

        <span class="n">user_status</span><span class="p">,</span> <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate_by_token</span><span class="p">(</span><span class="n">logintoken</span><span class="p">)</span>
        <span class="c"># User id contains error code</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_status</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">user</span>

        <span class="n">csid_from_server</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;seriesid&#39;</span><span class="p">]</span>
        <span class="n">csid_from_client</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;csid_from_client&quot;</span><span class="p">)</span>

        <span class="n">file_obj</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;file&#39;</span><span class="p">)</span>

        <span class="c"># For some reason, FileStorage object treats itself as False</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">file_obj</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">status</span><span class="o">=</span><span class="mi">405</span><span class="p">,</span>
                                <span class="n">error_code</span><span class="o">=</span><span class="s">&quot;Required args are missing&quot;</span><span class="p">)</span>

        <span class="n">album</span><span class="p">,</span> <span class="n">album_created</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_or_create_album</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span>
                                                         <span class="s">&#39;backgrounds&#39;</span><span class="p">)</span>
        <span class="n">photo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save_in_database</span><span class="p">(</span><span class="n">file_obj</span><span class="p">,</span> <span class="mi">1100</span><span class="p">,</span> <span class="n">album</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="n">user_to_update</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span>\
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="n">user_to_update</span><span class="o">.</span><span class="n">bg</span> <span class="o">=</span> <span class="n">photo</span>
        <span class="k">if</span> <span class="n">album_created</span><span class="p">:</span>
            <span class="n">album</span><span class="o">.</span><span class="n">cover</span> <span class="o">=</span> <span class="n">photo</span>
        <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">data</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">photo</span><span class="o">.</span><span class="n">id</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;original_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">photo</span><span class="o">.</span><span class="n">original_url</span>
        <span class="n">data</span><span class="p">[</span><span class="s">&#39;resized_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">photo</span><span class="o">.</span><span class="n">resized_url</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
                                <span class="n">error_code</span><span class="o">=</span><span class="n">error_code</span><span class="p">,</span>
                                <span class="n">csid_from_client</span><span class="o">=</span><span class="n">csid_from_client</span><span class="p">,</span>
                                <span class="n">csid_from_server</span><span class="o">=</span><span class="n">csid_from_server</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>

</div></div>
<div class="viewcode-block" id="GetPictures"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.GetPictures">[docs]</a><span class="k">class</span> <span class="nc">GetPictures</span><span class="p">(</span><span class="n">BaseAPI</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    API method for get photos of user</span>

<span class="sd">    :link: /api/profile/userinfo/get_pictures</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="GetPictures.POST"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.GetPictures.POST">[docs]</a>    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param str csid_from_client: Csid string from client</span>
<span class="sd">        :param str logintoken: logintoken of user (is not required)</span>
<span class="sd">        :param int user_id: id of user</span>
<span class="sd">        :param str album_type: type of pictures (photos|backgrounds)</span>
<span class="sd">        :response data: returns photos - list of pictures</span>
<span class="sd">        :to test: curl --data &quot;csid_from_client=1&amp;user_id=93&amp;album_type=photos&quot; http://localhost:8080/api/profile/userinfo/get_pictures</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">request_data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>

        <span class="n">update_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">csid_from_server</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">error_code</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="c"># Get data from request</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;user_id&quot;</span><span class="p">)</span>
        <span class="n">album_type</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;album_type&quot;</span><span class="p">)</span>

        <span class="c"># This if is a monkeypatch, which allows to map</span>
        <span class="c"># photos to any other non background slug</span>
        <span class="c"># TODO: replace this code</span>
        <span class="k">if</span> <span class="n">album_type</span> <span class="o">!=</span> <span class="s">&quot;backgrounds&quot;</span><span class="p">:</span>
            <span class="n">album_type</span> <span class="o">=</span> <span class="s">&quot;photos&quot;</span>

        <span class="n">csid_from_client</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;csid_from_client&#39;</span><span class="p">)</span>

        <span class="n">current_user_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">logintoken</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;logintoken&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">logintoken</span><span class="p">:</span>
            <span class="n">user_status</span><span class="p">,</span> <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate_by_token</span><span class="p">(</span><span class="n">logintoken</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user_status</span><span class="p">:</span>
                <span class="n">current_user_id</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">]</span>


        <span class="n">album</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Album</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Album</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">,</span>
            <span class="n">Album</span><span class="o">.</span><span class="n">slug</span> <span class="o">==</span> <span class="n">album_type</span>
        <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="n">data</span><span class="p">[</span><span class="s">&#39;photos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">album</span><span class="p">:</span>
            <span class="n">pictures</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Picture</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Picture</span><span class="o">.</span><span class="n">album_id</span> <span class="o">==</span> <span class="n">album</span><span class="o">.</span><span class="n">id</span>
            <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">picture</span> <span class="ow">in</span> <span class="n">pictures</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">picture</span><span class="o">.</span><span class="n">resized_url</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">picture</span> <span class="o">=</span> <span class="n">picture</span><span class="o">.</span><span class="n">to_serializable_dict</span><span class="p">()</span>

                <span class="n">picture</span><span class="p">[</span><span class="s">&#39;likes_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">picture</span><span class="p">[</span><span class="s">&#39;likes&#39;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">current_user_id</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">like</span> <span class="ow">in</span> <span class="n">picture</span><span class="p">[</span><span class="s">&#39;likes&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">like</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">current_user_id</span><span class="p">:</span>
                            <span class="n">picture</span><span class="p">[</span><span class="s">&#39;liked&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">picture</span><span class="p">[</span><span class="s">&#39;liked&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

                <span class="n">data</span><span class="p">[</span><span class="s">&#39;photos&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">picture</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
                                <span class="n">error_code</span><span class="o">=</span><span class="n">error_code</span><span class="p">,</span>
                                <span class="n">csid_from_client</span><span class="o">=</span><span class="n">csid_from_client</span><span class="p">,</span>
                                <span class="n">csid_from_server</span><span class="o">=</span><span class="n">csid_from_server</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>

</div></div>
<div class="viewcode-block" id="PictureRemove"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.PictureRemove">[docs]</a><span class="k">class</span> <span class="nc">PictureRemove</span><span class="p">(</span><span class="n">BaseAPI</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove picture and save changes in database</span>

<span class="sd">    :link: /api/profile/userinfo/remove_pic</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="PictureRemove.POST"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.PictureRemove.POST">[docs]</a>    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param str csid_from_client: Csid string from client</span>
<span class="sd">        :param str logintoken: logintoken of user</span>
<span class="sd">        :param int picture_id: id of photo that you wish to remove</span>
<span class="sd">        :response data: no extra rsponse</span>
<span class="sd">        :to test: curl --data &quot;csid_from_client=1&amp;picture_id=5&amp;logintoken=XXXXXXX&quot; http://localhost:8080/api/profile/userinfo/remove_pic</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">csid_from_server</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">error_code</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="n">request_data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>
        <span class="n">logintoken</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;logintoken&#39;</span><span class="p">)</span>
        <span class="n">picture_id</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;picture_id&#39;</span><span class="p">)</span>

        <span class="n">user_status</span><span class="p">,</span> <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate_by_token</span><span class="p">(</span><span class="n">logintoken</span><span class="p">)</span>
        <span class="c"># User id contains error code</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_status</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">user</span>

        <span class="n">csid_from_server</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;seriesid&#39;</span><span class="p">]</span>
        <span class="n">csid_from_client</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;csid_from_client&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_picture</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="n">picture_id</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
                                <span class="n">error_code</span><span class="o">=</span><span class="n">error_code</span><span class="p">,</span>
                                <span class="n">csid_from_client</span><span class="o">=</span><span class="n">csid_from_client</span><span class="p">,</span>
                                <span class="n">csid_from_server</span><span class="o">=</span><span class="n">csid_from_server</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>
</div>
    <span class="k">def</span> <span class="nf">_delete_picture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">picture_id</span><span class="p">):</span>
        <span class="n">user_to_update</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="n">picture</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Picture</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Picture</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">picture_id</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">picture</span><span class="p">:</span>
            <span class="n">album</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Album</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Album</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">picture</span><span class="o">.</span><span class="n">album_id</span>
            <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">album</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_to_update</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="c"># if album.slug == &quot;photos&quot;:</span>
                <span class="c">#     if user_to_update.pic_id == picture.id:</span>
                <span class="c">#         user_to_update.pic_obj = self._get_next_picture(album,</span>
                <span class="c">#                                                     picture)</span>
                <span class="c"># elif album.slug == &quot;backgrounds&quot;:</span>
                <span class="c">#     if user_to_update.bg_id == picture.id:</span>
                <span class="c">#         user_to_update.bg = self._get_next_picture(album,</span>
                <span class="c">#                                                    picture)</span>
                <span class="c">#         user_to_update.bgx = 0</span>
                <span class="c">#         user_to_update.bgy = 0</span>

                <span class="k">if</span> <span class="n">album</span><span class="o">.</span><span class="n">cover_id</span> <span class="o">==</span> <span class="n">picture</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                    <span class="n">album</span><span class="o">.</span><span class="n">cover</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_next_picture</span><span class="p">(</span><span class="n">album</span><span class="p">,</span>
                                                         <span class="n">picture</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">picture</span><span class="o">.</span><span class="n">comments</span><span class="p">:</span>
                    <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">like</span> <span class="ow">in</span> <span class="n">picture</span><span class="o">.</span><span class="n">likes</span><span class="p">:</span>
                    <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">like</span><span class="p">)</span>

                <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">picture</span><span class="p">)</span>
                <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_get_next_picture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">album</span><span class="p">,</span> <span class="n">picture</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pic</span> <span class="ow">in</span> <span class="n">album</span><span class="o">.</span><span class="n">pictures</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">picture</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">pic</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pic</span>
        <span class="k">return</span> <span class="bp">None</span>

</div>
<div class="viewcode-block" id="AlbumDefaultPic"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.AlbumDefaultPic">[docs]</a><span class="k">class</span> <span class="nc">AlbumDefaultPic</span><span class="p">(</span><span class="n">BaseAPI</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets picture as default album cover</span>

<span class="sd">    :link: /api/profile/userinfo/album_default_picture</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="AlbumDefaultPic.POST"><a class="viewcode-back" href="../../../api.views.html#api.views.profile.AlbumDefaultPic.POST">[docs]</a>    <span class="k">def</span> <span class="nf">POST</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param str csid_from_client: Csid string from client</span>
<span class="sd">        :param str logintoken: logintoken of user</span>
<span class="sd">        :param int picture_id: id of photo that you wish tis set as xover</span>
<span class="sd">        :response data: no extra rsponse</span>
<span class="sd">        :to test: curl --data &quot;csid_from_client=1&amp;picture_id=5&amp;logintoken=XXXXXXX&quot; http://localhost:8080/api/profile/userinfo/album_default_picture</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">csid_from_server</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">error_code</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="n">request_data</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">input</span><span class="p">()</span>
        <span class="n">logintoken</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;logintoken&#39;</span><span class="p">)</span>
        <span class="n">picture_id</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;picture_id&#39;</span><span class="p">)</span>

        <span class="n">user_status</span><span class="p">,</span> <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate_by_token</span><span class="p">(</span><span class="n">logintoken</span><span class="p">)</span>
        <span class="c"># User id contains error code</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_status</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">user</span>

        <span class="n">csid_from_server</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;seriesid&#39;</span><span class="p">]</span>
        <span class="n">csid_from_client</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;csid_from_client&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_picture</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="n">picture_id</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">api_response</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                                <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
                                <span class="n">error_code</span><span class="o">=</span><span class="n">error_code</span><span class="p">,</span>
                                <span class="n">csid_from_client</span><span class="o">=</span><span class="n">csid_from_client</span><span class="p">,</span>
                                <span class="n">csid_from_server</span><span class="o">=</span><span class="n">csid_from_server</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">response</span>
</div>
    <span class="k">def</span> <span class="nf">_set_picture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">picture_id</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="n">picture</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Picture</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Picture</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">picture_id</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">picture</span><span class="p">:</span>
            <span class="n">album</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Album</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Album</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">picture</span><span class="o">.</span><span class="n">album_id</span>
            <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">album</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
                <span class="n">album</span><span class="o">.</span><span class="n">cover</span> <span class="o">=</span> <span class="n">picture</span>
                <span class="n">web</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">orm</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">mypinnings 1.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, mygetlist.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>