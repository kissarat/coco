<html><head><title>profile.py</title><link rel="stylesheet" type="text/css" href="/style.css"></head><body><article><div id="container"><div class="comment ui-draggable ui-draggable-handle" style="top: 15920px; left: 18px;">incorrect http status code</div><div class="comment ui-draggable ui-draggable-handle" style="top: 13616px; left: 18px;" data-lines="[757]">incorrect http status code</div><div class="comment ui-draggable ui-draggable-handle" style="top: 11330px; left: 18px;" data-lines="[630]">incorrect http status code</div><div class="comment ui-draggable ui-draggable-handle" style="top: 4310px; left: 18px;">incorrect http status code</div><div class="comment ui-draggable ui-draggable-handle" style="top: 3518px; left: 18px;" data-lines="[196]">incorrect http status code</div><div class="comment ui-draggable ui-draggable-handle" style="top: 3086px; left: 18px;" data-lines="[172]">no "else"</div><div class="comment ui-draggable ui-draggable-handle" style="top: 2924px; left: 18px;" data-lines="[163]">incorrect http status code</div><div class="comment ui-draggable ui-draggable-handle" style="top: 2636px; left: 18px;" data-lines="[147]">incorrect http status code</div><div class="comment ui-draggable ui-draggable-handle" style="top: 1178px; left: 18px;" data-lines="[66,67,68,69]">or instead and</div><div class="comment ui-draggable ui-draggable-handle" style="top: 1718px; left: 18px;" data-lines="[96]">incorrect http status code</div><div class="comment ui-draggable ui-draggable-handle" style="top: 12662px; left: 18px;" data-lines="[704,705]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 10970px; left: 18px;" data-lines="[610,611,612,613,614,615,616,617,618,619,620,621,622]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 10466px; left: 18px;" data-lines="[582,583,584]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 10268px; left: 18px;" data-lines="[571,572,573,574,575,576,577,578]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 9026px; left: 18px;" data-lines="[502,503]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 8810px; left: 18px;" data-lines="[490,491]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 8684px; left: 18px;" data-lines="[483,484]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 7730px; left: 18px;" data-lines="[430,431,432]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 7622px; left: 18px;" data-lines="[424,425,426]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 7442px; left: 18px;" data-lines="[414]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 7334px; left: 18px;" data-lines="[408,409,410]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 5642px; left: 18px;" data-lines="[314,315,316,408,409,410]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 4940px; left: 18px;">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 3122px; left: 18px;" data-lines="[173,174]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 2114px; left: 18px;" data-lines="[118,119,275,276,277]">sql</div></div><table id="source" class="language-javascript"><tbody><tr><td>1</td><td><pre>""" API views responsible for returing and updating the profile info"""</pre></td></tr><tr class=""><td>2</td><td><pre>import os</pre></td></tr><tr class=""><td>3</td><td><pre>import uuid</pre></td></tr><tr class=""><td>4</td><td><pre>import web</pre></td></tr><tr class=""><td>5</td><td><pre>import math</pre></td></tr><tr class=""><td>6</td><td><pre>from datetime import datetime</pre></td></tr><tr><td>7</td><td><pre></pre></td></tr><tr><td>8</td><td><pre>from api.utils import api_response, save_api_request, api_response, \</pre></td></tr><tr class=""><td>9</td><td><pre>    photo_id_to_url</pre></td></tr><tr class=""><td>10</td><td><pre>from api.views.base import BaseAPI</pre></td></tr><tr><td>11</td><td><pre>from api.views.social import share, get_comments_to_photo</pre></td></tr><tr><td>12</td><td><pre>from api.entities import UserProfile</pre></td></tr><tr><td>13</td><td><pre></pre></td></tr><tr><td>14</td><td><pre>from mypinnings import auth</pre></td></tr><tr><td>15</td><td><pre>from mypinnings import session</pre></td></tr><tr><td>16</td><td><pre>from mypinnings.database import connect_db</pre></td></tr><tr><td>17</td><td><pre>from mypinnings.conf import settings</pre></td></tr><tr><td>18</td><td><pre>from mypinnings.media import store_image_from_filename</pre></td></tr><tr><td>19</td><td><pre></pre></td></tr><tr><td>20</td><td><pre>from api.models.user import User</pre></td></tr><tr><td>21</td><td><pre>from api.models.album import Album</pre></td></tr><tr><td>22</td><td><pre>from api.models.picture import Picture</pre></td></tr><tr><td>23</td><td><pre></pre></td></tr><tr><td>24</td><td><pre></pre></td></tr><tr><td>25</td><td><pre>db = connect_db()</pre></td></tr><tr><td>26</td><td><pre></pre></td></tr><tr><td>27</td><td><pre></pre></td></tr><tr><td>28</td><td><pre>class BaseUserProfile(BaseAPI):</pre></td></tr><tr><td>29</td><td><pre>    """</pre></td></tr><tr><td>30</td><td><pre>    General class which holds list of fields used by user profile methods</pre></td></tr><tr><td>31</td><td><pre>    """</pre></td></tr><tr><td>32</td><td><pre>    def __init__(self):</pre></td></tr><tr><td>33</td><td><pre>        self._fields = ['id', 'name', 'about', 'city', 'country', 'hometown',</pre></td></tr><tr><td>34</td><td><pre>                        'about', 'email', 'pic_id', 'bg_id', 'website', 'facebook',</pre></td></tr><tr><td>35</td><td><pre>                        'twitter', 'getlist_privacy_level', 'private',</pre></td></tr><tr><td>36</td><td><pre>                        'bgx', 'bgy', 'show_views', 'views', 'username', 'zip',</pre></td></tr><tr><td>37</td><td><pre>                        'linkedin', 'gplus', 'headerbgy', 'headerbgx']</pre></td></tr><tr><td>38</td><td><pre>        self._birthday_fields = ['birthday_year', 'birthday_month',</pre></td></tr><tr><td>39</td><td><pre>                                 'birthday_day']</pre></td></tr><tr><td>40</td><td><pre>        self.required = ['csid_from_client', 'logintoken']</pre></td></tr><tr><td>41</td><td><pre>        self.default_fields = ['project_id', 'os_type', 'version_id','format_type']</pre></td></tr><tr><td>42</td><td><pre></pre></td></tr><tr><td>43</td><td><pre>    @staticmethod</pre></td></tr><tr><td>44</td><td><pre>    def format_birthday(user, response):</pre></td></tr><tr><td>45</td><td><pre>        """</pre></td></tr><tr><td>46</td><td><pre>        Composes birthday response, returning year, day and month</pre></td></tr><tr><td>47</td><td><pre>        as separate response fields</pre></td></tr><tr><td>48</td><td><pre>        """</pre></td></tr><tr><td>49</td><td><pre>        if user['birthday']:</pre></td></tr><tr><td>50</td><td><pre>            response['birthday_year'] = user['birthday'].year</pre></td></tr><tr><td>51</td><td><pre>            response['birthday_day'] = user['birthday'].day</pre></td></tr><tr><td>52</td><td><pre>            response['birthday_month'] = user['birthday'].month</pre></td></tr><tr><td>53</td><td><pre>        return response</pre></td></tr><tr><td>54</td><td><pre></pre></td></tr><tr><td>55</td><td><pre>    def is_request_valid(self, request_data):</pre></td></tr><tr><td>56</td><td><pre>        """</pre></td></tr><tr><td>57</td><td><pre>        Checks if all required parameters are sent from the client.</pre></td></tr><tr><td>58</td><td><pre>        Also checks if no extra arguments was passed</pre></td></tr><tr><td>59</td><td><pre>        """</pre></td></tr><tr><td>60</td><td><pre>        for field in self.required:</pre></td></tr><tr><td>61</td><td><pre>            if field not in request_data:</pre></td></tr><tr><td>62</td><td><pre>                return False</pre></td></tr><tr><td>63</td><td><pre></pre></td></tr><tr><td>64</td><td><pre>        for field in request_data:</pre></td></tr><tr><td>65</td><td><pre>            # Checking if current field is among the fields we have in the db</pre></td></tr><tr class="accepted"><td>66</td><td><pre>            if (field not in self._fields and</pre></td></tr><tr class="accepted"><td>67</td><td><pre>                    field not in self._birthday_fields and</pre></td></tr><tr class="accepted"><td>68</td><td><pre>                    field not in self.required and</pre></td></tr><tr class="accepted"><td>69</td><td><pre>                    field not in self.default_fields):</pre></td></tr><tr><td>70</td><td><pre>                return False</pre></td></tr><tr><td>71</td><td><pre>        return True</pre></td></tr><tr><td>72</td><td><pre></pre></td></tr><tr><td>73</td><td><pre></pre></td></tr><tr><td>74</td><td><pre>class SetPrivacy(BaseUserProfile):</pre></td></tr><tr><td>75</td><td><pre>    """</pre></td></tr><tr><td>76</td><td><pre>    Allows to set privacy level of the profile.</pre></td></tr><tr><td>77</td><td><pre></pre></td></tr><tr><td>78</td><td><pre>    :link: /api/profile/userinfo/update</pre></td></tr><tr><td>79</td><td><pre>    """</pre></td></tr><tr><td>80</td><td><pre>    def POST(self):</pre></td></tr><tr><td>81</td><td><pre>        """ Updates profile with fields sent from the client,</pre></td></tr><tr><td>82</td><td><pre>        returns saved fields.</pre></td></tr><tr><td>83</td><td><pre></pre></td></tr><tr><td>84</td><td><pre>        :param str csid_from_client: csid from client key</pre></td></tr><tr><td>85</td><td><pre>        :param str getlist_privacy_level/private: controls privacy level</pre></td></tr><tr><td>86</td><td><pre>        :param str logintoken: logintoken</pre></td></tr><tr><td>87</td><td><pre>        :response_data: Returns api response with 'getlist_privacy_level/private.'</pre></td></tr><tr><td>88</td><td><pre>        :to test: curl --data "logintoken=UaNxct7bJZ&amp;twitter=1&amp;csid_from_client=1" http://localhost:8080/api/profile/userinfo/update</pre></td></tr><tr><td>89</td><td><pre>        """</pre></td></tr><tr><td>90</td><td><pre>        request_data = web.input()</pre></td></tr><tr><td>91</td><td><pre></pre></td></tr><tr><td>92</td><td><pre>        # Adding field to the list of required fields</pre></td></tr><tr><td>93</td><td><pre>        # self.required.append('getlist_privacy_level')</pre></td></tr><tr><td>94</td><td><pre></pre></td></tr><tr><td>95</td><td><pre>        if not self.is_request_valid(request_data):</pre></td></tr><tr class="accepted"><td>96</td><td><pre>            return api_response(data={}, status=405,</pre></td></tr><tr><td>97</td><td><pre>                                error_code="Required args are missing")</pre></td></tr><tr><td>98</td><td><pre></pre></td></tr><tr><td>99</td><td><pre>        csid_from_client = request_data.pop('csid_from_client')</pre></td></tr><tr><td>100</td><td><pre></pre></td></tr><tr><td>101</td><td><pre>        data = {}</pre></td></tr><tr><td>102</td><td><pre></pre></td></tr><tr><td>103</td><td><pre>        privacy_level = request_data.get('getlist_privacy_level')</pre></td></tr><tr><td>104</td><td><pre>        private = request_data.get('private')</pre></td></tr><tr><td>105</td><td><pre></pre></td></tr><tr><td>106</td><td><pre>        if privacy_level:</pre></td></tr><tr><td>107</td><td><pre>            data['getlist_privacy_level'] = privacy_level</pre></td></tr><tr><td>108</td><td><pre>        if private:</pre></td></tr><tr><td>109</td><td><pre>            data['private'] = private</pre></td></tr><tr><td>110</td><td><pre></pre></td></tr><tr><td>111</td><td><pre>        status, response_or_user = self.authenticate_by_token(</pre></td></tr><tr><td>112</td><td><pre>            request_data.pop('logintoken'))</pre></td></tr><tr><td>113</td><td><pre>        # Login was not successful</pre></td></tr><tr><td>114</td><td><pre>        if not status:</pre></td></tr><tr><td>115</td><td><pre>            return response_or_user</pre></td></tr><tr><td>116</td><td><pre></pre></td></tr><tr><td>117</td><td><pre>        if len(data) &gt; 0:</pre></td></tr><tr class="accepted"><td>118</td><td><pre>            db.update('users', where='id = %s' % (response_or_user['id']),</pre></td></tr><tr class="accepted"><td>119</td><td><pre>                      **data)</pre></td></tr><tr><td>120</td><td><pre></pre></td></tr><tr><td>121</td><td><pre>        csid_from_server = response_or_user['seriesid']</pre></td></tr><tr><td>122</td><td><pre>        return api_response(data=data,</pre></td></tr><tr><td>123</td><td><pre>                            csid_from_client=csid_from_client,</pre></td></tr><tr><td>124</td><td><pre>                            csid_from_server=csid_from_server)</pre></td></tr><tr><td>125</td><td><pre></pre></td></tr><tr><td>126</td><td><pre></pre></td></tr><tr><td>127</td><td><pre>class UserInfoUpdate(BaseUserProfile):</pre></td></tr><tr><td>128</td><td><pre>    """</pre></td></tr><tr><td>129</td><td><pre>    Defines a class responsible for updating user data, inside the profile</pre></td></tr><tr><td>130</td><td><pre></pre></td></tr><tr><td>131</td><td><pre>    :link: /api/profile/userinfo/update</pre></td></tr><tr><td>132</td><td><pre>    """</pre></td></tr><tr><td>133</td><td><pre>    def POST(self):</pre></td></tr><tr><td>134</td><td><pre>        """  Updates profile with fields sent from the client,</pre></td></tr><tr><td>135</td><td><pre>        returns saved fields.</pre></td></tr><tr><td>136</td><td><pre></pre></td></tr><tr><td>137</td><td><pre>        :param str csid_from_client: Csid string from client</pre></td></tr><tr><td>138</td><td><pre>        :param str logintoken: Logintoken</pre></td></tr><tr><td>139</td><td><pre>        :param str &lt;field&gt;: The field which will be changed</pre></td></tr><tr><td>140</td><td><pre>        :response_data: returns changed field</pre></td></tr><tr><td>141</td><td><pre>        :to test: curl --data "logintoken=UaNxct7bJZ&amp;twitter=1&amp;csid_from_client=1" http://localhost:8080/api/profile/userinfo/update</pre></td></tr><tr><td>142</td><td><pre></pre></td></tr><tr><td>143</td><td><pre>        """</pre></td></tr><tr><td>144</td><td><pre>        request_data = web.input()</pre></td></tr><tr><td>145</td><td><pre></pre></td></tr><tr><td>146</td><td><pre>        if not self.is_request_valid(request_data):</pre></td></tr><tr class="accepted"><td>147</td><td><pre>            return api_response(data={}, status=405,</pre></td></tr><tr><td>148</td><td><pre>                                error_code="Required args are missing")</pre></td></tr><tr><td>149</td><td><pre>        csid_from_client = request_data.pop('csid_from_client')</pre></td></tr><tr><td>150</td><td><pre></pre></td></tr><tr><td>151</td><td><pre>        status, response_or_user = self.authenticate_by_token(</pre></td></tr><tr><td>152</td><td><pre>            request_data.pop('logintoken'))</pre></td></tr><tr><td>153</td><td><pre>        # Login was not successful</pre></td></tr><tr><td>154</td><td><pre>        if not status:</pre></td></tr><tr><td>155</td><td><pre>            return response_or_user</pre></td></tr><tr><td>156</td><td><pre>        to_insert = {}</pre></td></tr><tr><td>157</td><td><pre></pre></td></tr><tr><td>158</td><td><pre>        birthday = [value for key, value in request_data.items()</pre></td></tr><tr><td>159</td><td><pre>                    if key in self._birthday_fields]</pre></td></tr><tr><td>160</td><td><pre></pre></td></tr><tr><td>161</td><td><pre>        if len(birthday) in [1, 2]:</pre></td></tr><tr><td>162</td><td><pre>            error_code = "Birthday date incomplete"</pre></td></tr><tr class="accepted"><td>163</td><td><pre>            return api_response(data={}, status=405, error_code=error_code)</pre></td></tr><tr><td>164</td><td><pre>        elif len(birthday) == 3:</pre></td></tr><tr><td>165</td><td><pre>            to_insert['birthday'] = datetime.strptime("-".join(birthday),</pre></td></tr><tr><td>166</td><td><pre>                                                      "%Y-%d-%m")</pre></td></tr><tr><td>167</td><td><pre>        for field in self._fields:</pre></td></tr><tr><td>168</td><td><pre>            item = request_data.get(field)</pre></td></tr><tr><td>169</td><td><pre>            if item:</pre></td></tr><tr><td>170</td><td><pre>                to_insert[field] = item</pre></td></tr><tr><td>171</td><td><pre></pre></td></tr><tr class="accepted"><td>172</td><td><pre>        if len(to_insert) &gt; 0:</pre></td></tr><tr class="accepted"><td>173</td><td><pre>            db.update('users', where='id = %s' % (response_or_user['id']),</pre></td></tr><tr class="accepted"><td>174</td><td><pre>                      **to_insert)</pre></td></tr><tr><td>175</td><td><pre>        csid_from_server = response_or_user['seriesid']</pre></td></tr><tr><td>176</td><td><pre>        return api_response(data=request_data,</pre></td></tr><tr><td>177</td><td><pre>                            csid_from_client=csid_from_client,</pre></td></tr><tr><td>178</td><td><pre>                            csid_from_server=csid_from_server)</pre></td></tr><tr><td>179</td><td><pre></pre></td></tr><tr><td>180</td><td><pre></pre></td></tr><tr><td>181</td><td><pre>class GetProfileInfo(BaseUserProfile):</pre></td></tr><tr><td>182</td><td><pre>    """ Allows to render profile information, by token</pre></td></tr><tr><td>183</td><td><pre></pre></td></tr><tr><td>184</td><td><pre>    :url: /api/profile/userinfo/get</pre></td></tr><tr><td>185</td><td><pre>    """</pre></td></tr><tr><td>186</td><td><pre>    def POST(self):</pre></td></tr><tr><td>187</td><td><pre>        """</pre></td></tr><tr><td>188</td><td><pre>        :param str csid_from_client: Csid string from client</pre></td></tr><tr><td>189</td><td><pre>        :param str logintoken: Logintoken</pre></td></tr><tr><td>190</td><td><pre></pre></td></tr><tr><td>191</td><td><pre>        :response_data: 'id', 'name', 'about', 'city', 'country','hometown', 'about', 'email', 'pic', 'website', 'facebook', 'twitter', 'getlist_privacy_level', 'private', 'bg', 'bgx', 'bgy', 'show_views', 'views', 'username', 'zip', 'linkedin', 'gplus', 'bg_resized_url', 'headerbgy', 'headerbgx'</pre></td></tr><tr><td>192</td><td><pre>        :to test: curl --data "logintoken=UaNxct7bJZ&amp;csid_from_client=123" http://localhost:8080/api/profile/userinfo/get</pre></td></tr><tr><td>193</td><td><pre>        """</pre></td></tr><tr><td>194</td><td><pre>        request_data = web.input()</pre></td></tr><tr><td>195</td><td><pre>        if not self.is_request_valid(request_data):</pre></td></tr><tr class="accepted"><td>196</td><td><pre>            return api_response(data={}, status=405,</pre></td></tr><tr><td>197</td><td><pre>                                error_code="Required args are missing")</pre></td></tr><tr><td>198</td><td><pre>        status, response_or_user = self.authenticate_by_token(</pre></td></tr><tr><td>199</td><td><pre>            request_data.pop('logintoken'))</pre></td></tr><tr><td>200</td><td><pre></pre></td></tr><tr><td>201</td><td><pre>        # User id contains error code</pre></td></tr><tr><td>202</td><td><pre>        if not status:</pre></td></tr><tr><td>203</td><td><pre>            return response_or_user</pre></td></tr><tr><td>204</td><td><pre></pre></td></tr><tr><td>205</td><td><pre>        response = {field: response_or_user[field] for field in self._fields}</pre></td></tr><tr><td>206</td><td><pre>        response['resized_url'] = photo_id_to_url(response['pic_id'])</pre></td></tr><tr><td>207</td><td><pre>        response['bg_resized_url'] = photo_id_to_url(response['bg_id'])</pre></td></tr><tr><td>208</td><td><pre>        csid_from_client = request_data.pop('csid_from_client')</pre></td></tr><tr><td>209</td><td><pre>        csid_from_server = response_or_user['seriesid']</pre></td></tr><tr><td>210</td><td><pre>        self.format_birthday(response_or_user, response)</pre></td></tr><tr><td>211</td><td><pre>        return api_response(data=response,</pre></td></tr><tr><td>212</td><td><pre>                            csid_from_client=csid_from_client,</pre></td></tr><tr><td>213</td><td><pre>                            csid_from_server=csid_from_server)</pre></td></tr><tr><td>214</td><td><pre></pre></td></tr><tr><td>215</td><td><pre></pre></td></tr><tr><td>216</td><td><pre>class ProfileInfo(BaseUserProfile):</pre></td></tr><tr><td>217</td><td><pre>    """</pre></td></tr><tr><td>218</td><td><pre>    Returns public profile information</pre></td></tr><tr><td>219</td><td><pre></pre></td></tr><tr><td>220</td><td><pre>    :url: /api/profile/userinfo/info</pre></td></tr><tr><td>221</td><td><pre>    """</pre></td></tr><tr><td>222</td><td><pre>    def POST(self):</pre></td></tr><tr><td>223</td><td><pre>        """</pre></td></tr><tr><td>224</td><td><pre>        :param str csid_from_client: Csid string from client</pre></td></tr><tr><td>225</td><td><pre>        :param str logintoken: Logintoken</pre></td></tr><tr><td>226</td><td><pre>        :param str username: Username</pre></td></tr><tr><td>227</td><td><pre>        :param str username: id</pre></td></tr><tr><td>228</td><td><pre>        :response_data: 'id', 'name', 'about', 'city', 'country','hometown', 'about', 'email', 'pic', 'website', 'facebook', 'twitter', 'getlist_privacy_level', 'private', 'bg', 'bgx', 'bgy', 'show_views', 'views', 'username', 'zip', 'linkedin', 'gplus', 'bg_resized_url', 'headerbgy', 'headerbgx'</pre></td></tr><tr><td>229</td><td><pre></pre></td></tr><tr><td>230</td><td><pre>        :to test:</pre></td></tr><tr><td>231</td><td><pre>        - curl --data "csid_from_client=11&amp;id=78&amp;logintoken=RxPu7fLYgv" http://localhost:8080/api/profile/userinfo/info</pre></td></tr><tr><td>232</td><td><pre>        - curl --data "csid_from_client=11&amp;username=Oleg&amp;logintoken=RxPu7fLYgv" http://localhost:8080/api/profile/userinfo/info</pre></td></tr><tr><td>233</td><td><pre>        """</pre></td></tr><tr><td>234</td><td><pre>        request_data = web.input()</pre></td></tr><tr><td>235</td><td><pre>        profile = request_data.get("username", "")</pre></td></tr><tr><td>236</td><td><pre>        user_id = request_data.get("id", 0)</pre></td></tr><tr><td>237</td><td><pre>        logintoken = request_data.get("logintoken", "")</pre></td></tr><tr><td>238</td><td><pre></pre></td></tr><tr><td>239</td><td><pre>        if not self.is_request_valid(request_data):</pre></td></tr><tr class="accepted"><td>240</td><td><pre>            return api_response(data={}, status=405,</pre></td></tr><tr><td>241</td><td><pre>                                error_code="Required args are missing")</pre></td></tr><tr><td>242</td><td><pre></pre></td></tr><tr><td>243</td><td><pre>        if not profile and not user_id:</pre></td></tr><tr><td>244</td><td><pre>            error_code = "This function requires either profile or user_id"</pre></td></tr><tr class="accepted"><td>245</td><td><pre>            return api_response(data={}, status=405,</pre></td></tr><tr><td>246</td><td><pre>                                error_code=error_code)</pre></td></tr><tr><td>247</td><td><pre></pre></td></tr><tr><td>248</td><td><pre>        status, response_or_user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>249</td><td><pre>        if not status:</pre></td></tr><tr class="accepted"><td>250</td><td><pre>            return api_response(data={}, status=405,</pre></td></tr><tr><td>251</td><td><pre>                                error_code="You need to log in first")</pre></td></tr><tr><td>252</td><td><pre></pre></td></tr><tr><td>253</td><td><pre>        user = UserProfile.query_user(profile=profile, user_id=user_id)</pre></td></tr><tr><td>254</td><td><pre>        if not user:</pre></td></tr><tr class="accepted"><td>255</td><td><pre>            return api_response(data={}, status=405,</pre></td></tr><tr><td>256</td><td><pre>                                error_code="User was not found")</pre></td></tr><tr><td>257</td><td><pre>        followers = UserProfile\</pre></td></tr><tr><td>258</td><td><pre>            .query_followed_by(profile_owner=user.id,</pre></td></tr><tr><td>259</td><td><pre>                               current_user=response_or_user["id"])</pre></td></tr><tr><td>260</td><td><pre>        user.follower_count = len(followers)</pre></td></tr><tr><td>261</td><td><pre></pre></td></tr><tr><td>262</td><td><pre>        follow = UserProfile\</pre></td></tr><tr><td>263</td><td><pre>            .query_following(profile_owner=user.id,</pre></td></tr><tr><td>264</td><td><pre>                             current_user=response_or_user["id"])</pre></td></tr><tr><td>265</td><td><pre>        user.follow_count = len(follow)</pre></td></tr><tr><td>266</td><td><pre></pre></td></tr><tr><td>267</td><td><pre>        csid_from_client = request_data.pop('csid_from_client')</pre></td></tr><tr><td>268</td><td><pre>        csid_from_server = ""</pre></td></tr><tr><td>269</td><td><pre></pre></td></tr><tr><td>270</td><td><pre>        return api_response(data=user.to_serializable_dict(),</pre></td></tr><tr><td>271</td><td><pre>                            csid_from_client=csid_from_client,</pre></td></tr><tr><td>272</td><td><pre>                            csid_from_server=csid_from_server)</pre></td></tr><tr><td>273</td><td><pre></pre></td></tr><tr><td>274</td><td><pre>    def get_user_info(self, profile="", user_id=0):</pre></td></tr><tr class="accepted"><td>275</td><td><pre>        query = db.select('users',</pre></td></tr><tr class="accepted"><td>276</td><td><pre>                          vars={'username': profile, 'id': user_id},</pre></td></tr><tr class="accepted"><td>277</td><td><pre>                          where="username=$username or id=$id")</pre></td></tr><tr><td>278</td><td><pre></pre></td></tr><tr><td>279</td><td><pre>        if len(query) &gt; 0:</pre></td></tr><tr><td>280</td><td><pre>            user = query.list()[0]</pre></td></tr><tr><td>281</td><td><pre>            user['pic'] = photo_id_to_url(user['pic'])</pre></td></tr><tr><td>282</td><td><pre>        else:</pre></td></tr><tr><td>283</td><td><pre>            return False</pre></td></tr><tr><td>284</td><td><pre>        response = {field: user[field] for field in self._fields}</pre></td></tr><tr><td>285</td><td><pre>        response = self.format_birthday(user, response)</pre></td></tr><tr><td>286</td><td><pre>        return response</pre></td></tr><tr><td>287</td><td><pre></pre></td></tr><tr><td>288</td><td><pre>class UpdateProfileViews(BaseUserProfile):</pre></td></tr><tr><td>289</td><td><pre>    """</pre></td></tr><tr><td>290</td><td><pre>    Responsible for updating count of pofile views</pre></td></tr><tr><td>291</td><td><pre></pre></td></tr><tr><td>292</td><td><pre>    :link: /api/profile/updateviews/&lt;username&gt;</pre></td></tr><tr><td>293</td><td><pre>    """</pre></td></tr><tr><td>294</td><td><pre>    def POST(self, profile):</pre></td></tr><tr><td>295</td><td><pre>        """</pre></td></tr><tr><td>296</td><td><pre>        :param str csid_from_client: Csid string from client</pre></td></tr><tr><td>297</td><td><pre>        :param str profile: must be in url</pre></td></tr><tr><td>298</td><td><pre>        :response_data: returns a dict with 'status' key</pre></td></tr><tr><td>299</td><td><pre>        :to test: curl --data "csid_from_client=11&amp;logintoken=RxPu7fLYgv" http://localhost:8080/api/profile/updateviews/oleg</pre></td></tr><tr><td>300</td><td><pre>        """</pre></td></tr><tr><td>301</td><td><pre>        request_data = web.input()</pre></td></tr><tr><td>302</td><td><pre></pre></td></tr><tr><td>303</td><td><pre>        if not self.is_request_valid(request_data):</pre></td></tr><tr><td>304</td><td><pre>            return api_response(data={}, status=405,</pre></td></tr><tr><td>305</td><td><pre>                                error_code="Required args are missing")</pre></td></tr><tr><td>306</td><td><pre></pre></td></tr><tr><td>307</td><td><pre>        # Checking if user has a valid logintoken</pre></td></tr><tr><td>308</td><td><pre>        status, response_or_user = self.authenticate_by_token(</pre></td></tr><tr><td>309</td><td><pre>            request_data.pop('logintoken'))</pre></td></tr><tr><td>310</td><td><pre>        # Login was not successful</pre></td></tr><tr><td>311</td><td><pre>        if not status:</pre></td></tr><tr><td>312</td><td><pre>            return response_or_user</pre></td></tr><tr><td>313</td><td><pre></pre></td></tr><tr class="accepted"><td>314</td><td><pre>        db.update('users', where='user = $username',</pre></td></tr><tr class="accepted"><td>315</td><td><pre>                  vars={'username': profile},</pre></td></tr><tr class="accepted"><td>316</td><td><pre>                  views=web.SQLLiteral('views + 1'))</pre></td></tr><tr><td>317</td><td><pre></pre></td></tr><tr><td>318</td><td><pre>        csid_from_client = request_data.pop('csid_from_client')</pre></td></tr><tr><td>319</td><td><pre>        csid_from_server = ""</pre></td></tr><tr><td>320</td><td><pre></pre></td></tr><tr><td>321</td><td><pre>        return api_response(data={"status": "success"},</pre></td></tr><tr><td>322</td><td><pre>                            csid_from_client=csid_from_client,</pre></td></tr><tr><td>323</td><td><pre>                            csid_from_server=csid_from_server)</pre></td></tr><tr><td>324</td><td><pre></pre></td></tr><tr><td>325</td><td><pre></pre></td></tr><tr><td>326</td><td><pre>class ManageGetList(BaseAPI):</pre></td></tr><tr><td>327</td><td><pre>    """</pre></td></tr><tr><td>328</td><td><pre>    :link: /api/profile/mgl</pre></td></tr><tr><td>329</td><td><pre>    """</pre></td></tr><tr><td>330</td><td><pre>    def POST(self):</pre></td></tr><tr><td>331</td><td><pre>        """</pre></td></tr><tr><td>332</td><td><pre>        Manage list of user products: sharing, add, remove</pre></td></tr><tr><td>333</td><td><pre></pre></td></tr><tr><td>334</td><td><pre>        Method for image_id_share_list must additional receive next</pre></td></tr><tr><td>335</td><td><pre>        :param str csid_from_client: Csid string from client</pre></td></tr><tr><td>336</td><td><pre>        :param str logintoken: Logintoken</pre></td></tr><tr><td>337</td><td><pre>        :param str social_network: e.g. facebook</pre></td></tr><tr><td>338</td><td><pre>        :response_data: returns added/removed/shared getlists</pre></td></tr><tr><td>339</td><td><pre>        """</pre></td></tr><tr><td>340</td><td><pre>        request_data = web.input(</pre></td></tr><tr><td>341</td><td><pre>            image_id_remove_list=[],</pre></td></tr><tr><td>342</td><td><pre>            image_id_share_list=[],</pre></td></tr><tr><td>343</td><td><pre>            image_id_add_list=[],</pre></td></tr><tr><td>344</td><td><pre>        )</pre></td></tr><tr><td>345</td><td><pre></pre></td></tr><tr><td>346</td><td><pre>        # Setting default status code as 200</pre></td></tr><tr><td>347</td><td><pre>        status = 200</pre></td></tr><tr><td>348</td><td><pre>        # Setting empty error</pre></td></tr><tr><td>349</td><td><pre>        error_code = ""</pre></td></tr><tr><td>350</td><td><pre></pre></td></tr><tr><td>351</td><td><pre>        save_api_request(request_data)</pre></td></tr><tr><td>352</td><td><pre>        login_token = request_data.get("logintoken")</pre></td></tr><tr><td>353</td><td><pre></pre></td></tr><tr><td>354</td><td><pre>        status_success, response_or_user = self.authenticate_by_token(login_token)</pre></td></tr><tr><td>355</td><td><pre>        if not status_success:</pre></td></tr><tr><td>356</td><td><pre>            return response_or_user</pre></td></tr><tr><td>357</td><td><pre></pre></td></tr><tr><td>358</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>359</td><td><pre></pre></td></tr><tr><td>360</td><td><pre>        access_token = request_data.get("access_token")</pre></td></tr><tr><td>361</td><td><pre>        social_network = request_data.get("social_network")</pre></td></tr><tr><td>362</td><td><pre></pre></td></tr><tr><td>363</td><td><pre>        image_id_add_list = map(int, request_data.get("image_id_add_list"))</pre></td></tr><tr><td>364</td><td><pre>        add_list_result = []</pre></td></tr><tr><td>365</td><td><pre>        if len(image_id_add_list) &gt; 0:</pre></td></tr><tr><td>366</td><td><pre>            add_list_result = self.add(response_or_user["id"],</pre></td></tr><tr><td>367</td><td><pre>                                       image_id_add_list)</pre></td></tr><tr><td>368</td><td><pre></pre></td></tr><tr><td>369</td><td><pre>        image_id_remove_list = map(int,</pre></td></tr><tr><td>370</td><td><pre>                                   request_data.get("image_id_remove_list"))</pre></td></tr><tr><td>371</td><td><pre>        remove_list_result = []</pre></td></tr><tr><td>372</td><td><pre>        if len(image_id_remove_list) &gt; 0:</pre></td></tr><tr><td>373</td><td><pre>            remove_list_result = self.remove(response_or_user["id"],</pre></td></tr><tr><td>374</td><td><pre>                                             image_id_remove_list)</pre></td></tr><tr><td>375</td><td><pre></pre></td></tr><tr><td>376</td><td><pre>        image_id_share_list = map(int, request_data.get("image_id_share_list"))</pre></td></tr><tr><td>377</td><td><pre>        share_list_result = []</pre></td></tr><tr><td>378</td><td><pre>        if len(image_id_share_list) &gt; 0:</pre></td></tr><tr><td>379</td><td><pre>            # Check input social data for posting</pre></td></tr><tr><td>380</td><td><pre>            if not access_token or not social_network:</pre></td></tr><tr><td>381</td><td><pre>                status = 400</pre></td></tr><tr><td>382</td><td><pre>                error_code = "Invalid input data"</pre></td></tr><tr><td>383</td><td><pre>            else:</pre></td></tr><tr><td>384</td><td><pre>                share_list_result, status, error_code = self.sharing(access_token, social_network,</pre></td></tr><tr><td>385</td><td><pre>                                                                 image_id_share_list)</pre></td></tr><tr><td>386</td><td><pre></pre></td></tr><tr><td>387</td><td><pre>        csid_from_server = response_or_user.get('seriesid')</pre></td></tr><tr><td>388</td><td><pre></pre></td></tr><tr><td>389</td><td><pre>        data = {</pre></td></tr><tr><td>390</td><td><pre>            "added": add_list_result,</pre></td></tr><tr><td>391</td><td><pre>            "removed": remove_list_result,</pre></td></tr><tr><td>392</td><td><pre>            "shared": share_list_result,</pre></td></tr><tr><td>393</td><td><pre>        }</pre></td></tr><tr><td>394</td><td><pre>        response = api_response(data,</pre></td></tr><tr><td>395</td><td><pre>                                status=status,</pre></td></tr><tr><td>396</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>397</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>398</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>399</td><td><pre>        return response</pre></td></tr><tr><td>400</td><td><pre></pre></td></tr><tr><td>401</td><td><pre>    def add(self, user_id, add_list):</pre></td></tr><tr><td>402</td><td><pre>        """</pre></td></tr><tr><td>403</td><td><pre>        Add new products to user profile</pre></td></tr><tr><td>404</td><td><pre>        """</pre></td></tr><tr><td>405</td><td><pre>        add_list_result = []</pre></td></tr><tr><td>406</td><td><pre>        for pin in add_list:</pre></td></tr><tr><td>407</td><td><pre>            user_product = {"user_id": user_id, "pin_id": pin}</pre></td></tr><tr class="accepted"><td>408</td><td><pre>            exist_product = db.select(</pre></td></tr><tr class="accepted"><td>409</td><td><pre>                'user_prefered_pins',</pre></td></tr><tr class="accepted"><td>410</td><td><pre>                where=web.db.sqlwhere(user_product)</pre></td></tr><tr><td>411</td><td><pre>            )</pre></td></tr><tr><td>412</td><td><pre>            if len(exist_product) == 0:</pre></td></tr><tr><td>413</td><td><pre>                add_list_result.append(pin)</pre></td></tr><tr class="accepted"><td>414</td><td><pre>                db.insert('user_prefered_pins', user_id=user_id, pin_id=pin)</pre></td></tr><tr><td>415</td><td><pre>        return add_list_result</pre></td></tr><tr><td>416</td><td><pre></pre></td></tr><tr><td>417</td><td><pre>    def remove(self, user_id, remove_list):</pre></td></tr><tr><td>418</td><td><pre>        """</pre></td></tr><tr><td>419</td><td><pre>        Remove products from user profile</pre></td></tr><tr><td>420</td><td><pre>        """</pre></td></tr><tr><td>421</td><td><pre>        remove_list_result = []</pre></td></tr><tr><td>422</td><td><pre>        for pin in remove_list:</pre></td></tr><tr><td>423</td><td><pre>            user_product = {"user_id": user_id, "pin_id": pin}</pre></td></tr><tr class="accepted"><td>424</td><td><pre>            exist_product = db.select(</pre></td></tr><tr class="accepted"><td>425</td><td><pre>                'user_prefered_pins',</pre></td></tr><tr class="accepted"><td>426</td><td><pre>                where=web.db.sqlwhere(user_product)</pre></td></tr><tr><td>427</td><td><pre>            )</pre></td></tr><tr><td>428</td><td><pre>            if len(exist_product) &gt; 0:</pre></td></tr><tr><td>429</td><td><pre>                remove_list_result.append(pin)</pre></td></tr><tr class="accepted"><td>430</td><td><pre>                db.delete(</pre></td></tr><tr class="accepted"><td>431</td><td><pre>                    'user_prefered_pins',</pre></td></tr><tr class="accepted"><td>432</td><td><pre>                    where=web.db.sqlwhere(user_product)</pre></td></tr><tr><td>433</td><td><pre>                )</pre></td></tr><tr><td>434</td><td><pre>        return remove_list_result</pre></td></tr><tr><td>435</td><td><pre></pre></td></tr><tr><td>436</td><td><pre>    def sharing(self, access_token, social_network, share_list):</pre></td></tr><tr><td>437</td><td><pre>        """</pre></td></tr><tr><td>438</td><td><pre>        Share products from user profile</pre></td></tr><tr><td>439</td><td><pre>        """</pre></td></tr><tr><td>440</td><td><pre></pre></td></tr><tr><td>441</td><td><pre>        share_list_result, status, error_code = share(access_token,</pre></td></tr><tr><td>442</td><td><pre>                                                      share_list,</pre></td></tr><tr><td>443</td><td><pre>                                                      social_network)</pre></td></tr><tr><td>444</td><td><pre></pre></td></tr><tr><td>445</td><td><pre>        return share_list_result, status, error_code</pre></td></tr><tr><td>446</td><td><pre></pre></td></tr><tr><td>447</td><td><pre></pre></td></tr><tr><td>448</td><td><pre>class ChangePassword(BaseAPI):</pre></td></tr><tr><td>449</td><td><pre>    """</pre></td></tr><tr><td>450</td><td><pre>    :link: /api/profile/pwd</pre></td></tr><tr><td>451</td><td><pre>    """</pre></td></tr><tr><td>452</td><td><pre>    def POST(self):</pre></td></tr><tr><td>453</td><td><pre>        """ Change user password and get/store new logintoken</pre></td></tr><tr><td>454</td><td><pre>        :param str csid_from_client: Csid string from client</pre></td></tr><tr><td>455</td><td><pre>        :param str logintoken: Logintoken</pre></td></tr><tr><td>456</td><td><pre>        :param str old_password: current password of the user</pre></td></tr><tr><td>457</td><td><pre>        :param str new_password, new_password2: The new password typed 2 times</pre></td></tr><tr><td>458</td><td><pre></pre></td></tr><tr><td>459</td><td><pre>        :response_data: new clinet token</pre></td></tr><tr><td>460</td><td><pre>        :to test:</pre></td></tr><tr><td>461</td><td><pre>        """</pre></td></tr><tr><td>462</td><td><pre>        request_data = web.input()</pre></td></tr><tr><td>463</td><td><pre>        save_api_request(request_data)</pre></td></tr><tr><td>464</td><td><pre>        client_token = request_data.get("logintoken")</pre></td></tr><tr><td>465</td><td><pre>        status, response_or_user = self.authenticate_by_token(client_token)</pre></td></tr><tr><td>466</td><td><pre>        if not status:</pre></td></tr><tr><td>467</td><td><pre>            return response_or_user</pre></td></tr><tr><td>468</td><td><pre></pre></td></tr><tr><td>469</td><td><pre>        old_password = request_data.get("old_password")</pre></td></tr><tr><td>470</td><td><pre>        new_password = request_data.get("new_password")</pre></td></tr><tr><td>471</td><td><pre>        new_password2 = request_data.get("new_password2")</pre></td></tr><tr><td>472</td><td><pre></pre></td></tr><tr><td>473</td><td><pre>        pw_salt = response_or_user['pw_salt']</pre></td></tr><tr><td>474</td><td><pre>        pw_hash = response_or_user['pw_hash']</pre></td></tr><tr><td>475</td><td><pre></pre></td></tr><tr><td>476</td><td><pre>        status, error = self.passwords_validation(pw_salt, pw_hash,</pre></td></tr><tr><td>477</td><td><pre>                                                  old_password, new_password,</pre></td></tr><tr><td>478</td><td><pre>                                                  new_password2,</pre></td></tr><tr><td>479</td><td><pre>                                                  response_or_user["username"],</pre></td></tr><tr><td>480</td><td><pre>                                                  response_or_user["email"])</pre></td></tr><tr><td>481</td><td><pre>        if status:</pre></td></tr><tr><td>482</td><td><pre>            new_password_hash = self.create_password(pw_salt, new_password)</pre></td></tr><tr class="accepted"><td>483</td><td><pre>            db.update('users', pw_hash=new_password_hash,</pre></td></tr><tr class="accepted"><td>484</td><td><pre>                      vars={'id': response_or_user["id"]}, where="id=$id")</pre></td></tr><tr><td>485</td><td><pre></pre></td></tr><tr><td>486</td><td><pre>            # re_login user with new password</pre></td></tr><tr><td>487</td><td><pre>            sess = session.get_session()</pre></td></tr><tr><td>488</td><td><pre>            auth.login_user(sess, response_or_user["id"])</pre></td></tr><tr><td>489</td><td><pre></pre></td></tr><tr class="accepted"><td>490</td><td><pre>            user = db.select('users', {'id': response_or_user["id"]},</pre></td></tr><tr class="accepted"><td>491</td><td><pre>                             where='id=$id')[0]</pre></td></tr><tr><td>492</td><td><pre>            new_client_token = user.get('logintoken')</pre></td></tr><tr><td>493</td><td><pre>            csid_from_server = user.get('seriesid')</pre></td></tr><tr><td>494</td><td><pre>            csid_from_client = request_data.get("csid_from_client")</pre></td></tr><tr><td>495</td><td><pre>            data = {</pre></td></tr><tr><td>496</td><td><pre>                "client_token": new_client_token,</pre></td></tr><tr><td>497</td><td><pre>            }</pre></td></tr><tr><td>498</td><td><pre>            response = api_response(data, csid_from_client,</pre></td></tr><tr><td>499</td><td><pre>                                    csid_from_server=csid_from_server)</pre></td></tr><tr><td>500</td><td><pre>        else:</pre></td></tr><tr><td>501</td><td><pre>            data = {}</pre></td></tr><tr class="accepted"><td>502</td><td><pre>            user = db.select('users', {'id': response_or_user["id"]},</pre></td></tr><tr class="accepted"><td>503</td><td><pre>                             where='id=$id')[0]</pre></td></tr><tr><td>504</td><td><pre>            csid_from_server = user.get('seriesid')</pre></td></tr><tr><td>505</td><td><pre>            csid_from_client = request_data.get("csid_from_client")</pre></td></tr><tr><td>506</td><td><pre></pre></td></tr><tr><td>507</td><td><pre>            response = api_response(data=data,</pre></td></tr><tr><td>508</td><td><pre>                                    status=400,</pre></td></tr><tr><td>509</td><td><pre>                                    error_code=error,</pre></td></tr><tr><td>510</td><td><pre>                                    csid_from_client=csid_from_client,</pre></td></tr><tr><td>511</td><td><pre>                                    csid_from_server=csid_from_server)</pre></td></tr><tr><td>512</td><td><pre></pre></td></tr><tr><td>513</td><td><pre>        return response</pre></td></tr><tr><td>514</td><td><pre></pre></td></tr><tr><td>515</td><td><pre>    def passwords_validation(self, pw_salt, pw_hash, old_pwd=None,</pre></td></tr><tr><td>516</td><td><pre>                             new_pwd=None, new_pwd2=None, uname=None,</pre></td></tr><tr><td>517</td><td><pre>                             email=None):</pre></td></tr><tr><td>518</td><td><pre>        """</pre></td></tr><tr><td>519</td><td><pre>        Check if new password match with confirmation.</pre></td></tr><tr><td>520</td><td><pre>        Check relevance old password.</pre></td></tr><tr><td>521</td><td><pre>        Check empty field.</pre></td></tr><tr><td>522</td><td><pre>        """</pre></td></tr><tr><td>523</td><td><pre>        if new_pwd is None:</pre></td></tr><tr><td>524</td><td><pre>            return False, self.access_denied("New password is empty")</pre></td></tr><tr><td>525</td><td><pre></pre></td></tr><tr><td>526</td><td><pre>        if old_pwd is None:</pre></td></tr><tr><td>527</td><td><pre>            return False, self.access_denied("Old password is empty")</pre></td></tr><tr><td>528</td><td><pre></pre></td></tr><tr><td>529</td><td><pre>        if new_pwd != new_pwd2:</pre></td></tr><tr><td>530</td><td><pre>            return False, self.access_denied("Passwords do not match")</pre></td></tr><tr><td>531</td><td><pre></pre></td></tr><tr><td>532</td><td><pre>        if str(hash(str(hash(old_pwd)) + pw_salt)) != pw_hash:</pre></td></tr><tr><td>533</td><td><pre>            return False, self.access_denied("Incorrect old password")</pre></td></tr><tr><td>534</td><td><pre></pre></td></tr><tr><td>535</td><td><pre>        pwd_status, error_code = auth.check_password(uname, new_pwd, email)</pre></td></tr><tr><td>536</td><td><pre>        if not pwd_status:</pre></td></tr><tr><td>537</td><td><pre>            return False, error_code</pre></td></tr><tr><td>538</td><td><pre></pre></td></tr><tr><td>539</td><td><pre>        return True, "Success"</pre></td></tr><tr><td>540</td><td><pre></pre></td></tr><tr><td>541</td><td><pre>    def create_password(self, pw_salt, new_pwd):</pre></td></tr><tr><td>542</td><td><pre>        new_pwd_hash = str(hash(new_pwd))</pre></td></tr><tr><td>543</td><td><pre>        new_pwd_hash = str(hash(new_pwd_hash + pw_salt))</pre></td></tr><tr><td>544</td><td><pre>        return new_pwd_hash</pre></td></tr><tr><td>545</td><td><pre></pre></td></tr><tr><td>546</td><td><pre></pre></td></tr><tr><td>547</td><td><pre>class QueryBoards(BaseAPI):</pre></td></tr><tr><td>548</td><td><pre>    """</pre></td></tr><tr><td>549</td><td><pre>    Class responsible for getting boards of a given user</pre></td></tr><tr><td>550</td><td><pre></pre></td></tr><tr><td>551</td><td><pre>    :link: /api/profile/userinfo/boards</pre></td></tr><tr><td>552</td><td><pre>    """</pre></td></tr><tr><td>553</td><td><pre>    def POST(self):</pre></td></tr><tr><td>554</td><td><pre>        """ Returns all boards associated with a given user</pre></td></tr><tr><td>555</td><td><pre></pre></td></tr><tr><td>556</td><td><pre>        :param str csid_from_client: Csid string from client</pre></td></tr><tr><td>557</td><td><pre>        :param str user_id: id of the queried user</pre></td></tr><tr><td>558</td><td><pre>        :param str current_user_id: id of current user</pre></td></tr><tr><td>559</td><td><pre>        :response_data: returns all boards of a given user as a list</pre></td></tr><tr><td>560</td><td><pre>        :to test: curl --data "user_id=2&amp;csid_from_client=1" http://localhost:8080/api/profile/userinfo/boards</pre></td></tr><tr><td>561</td><td><pre>        """</pre></td></tr><tr><td>562</td><td><pre>        request_data = web.input()</pre></td></tr><tr><td>563</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>564</td><td><pre>        csid_from_server = ""</pre></td></tr><tr><td>565</td><td><pre>        current_user_id = request_data.get('current_user_id', 0)</pre></td></tr><tr><td>566</td><td><pre>        user_id = request_data.get('user_id')</pre></td></tr><tr><td>567</td><td><pre></pre></td></tr><tr><td>568</td><td><pre>        if not user_id:</pre></td></tr><tr><td>569</td><td><pre>            return api_response(data={}, status=405,</pre></td></tr><tr><td>570</td><td><pre>                                error_code="Missing user_id")</pre></td></tr><tr class="accepted"><td>571</td><td><pre>        boards_query = """</pre></td></tr><tr class="accepted"><td>572</td><td><pre>        SELECT b.id, b.name, b.description, bf.follower_id is not null</pre></td></tr><tr class="accepted"><td>573</td><td><pre>        as is_following FROM boards b</pre></td></tr><tr class="accepted"><td>574</td><td><pre>        LEFT JOIN boards_followers bf on bf.board_id = b.id</pre></td></tr><tr class="accepted"><td>575</td><td><pre>        and bf.follower_id = $cid WHERE b.user_id=$uid;</pre></td></tr><tr class="accepted"><td>576</td><td><pre>        """</pre></td></tr><tr class="accepted"><td>577</td><td><pre>        boards_tmp = db.query(boards_query,</pre></td></tr><tr class="accepted"><td>578</td><td><pre>                              vars={'uid': user_id, 'cid': current_user_id})</pre></td></tr><tr class=""><td>579</td><td><pre></pre></td></tr><tr><td>580</td><td><pre>        boards = []</pre></td></tr><tr><td>581</td><td><pre>        for board in boards_tmp:</pre></td></tr><tr class="accepted"><td>582</td><td><pre>            pins_from_board = db.select('pins',</pre></td></tr><tr class="accepted"><td>583</td><td><pre>                               where='board_id=$board_id',</pre></td></tr><tr class="accepted"><td>584</td><td><pre>                               vars={'board_id': board['id']})</pre></td></tr><tr><td>585</td><td><pre>            board['pins_ids'] = []</pre></td></tr><tr><td>586</td><td><pre>            for pin_from_board in pins_from_board:</pre></td></tr><tr><td>587</td><td><pre>                if pin_from_board['id'] not in board['pins_ids']:</pre></td></tr><tr><td>588</td><td><pre>                    board['pins_ids'].append(pin_from_board['id'])</pre></td></tr><tr><td>589</td><td><pre>            boards.append(board)</pre></td></tr><tr><td>590</td><td><pre>        return api_response(data=boards,</pre></td></tr><tr><td>591</td><td><pre>                            csid_from_server=csid_from_server,</pre></td></tr><tr><td>592</td><td><pre>                            csid_from_client=csid_from_client)</pre></td></tr><tr><td>593</td><td><pre></pre></td></tr><tr><td>594</td><td><pre></pre></td></tr><tr><td>595</td><td><pre>class QueryPins(BaseAPI):</pre></td></tr><tr><td>596</td><td><pre>    """</pre></td></tr><tr><td>597</td><td><pre>    Responsible for getting pins of a given user</pre></td></tr><tr><td>598</td><td><pre></pre></td></tr><tr><td>599</td><td><pre>    :url: /api/profile/userinfo/pins</pre></td></tr><tr><td>600</td><td><pre>    """</pre></td></tr><tr><td>601</td><td><pre>    def POST(self):</pre></td></tr><tr><td>602</td><td><pre>        """ Returns all pins associated with a given user</pre></td></tr><tr><td>603</td><td><pre></pre></td></tr><tr><td>604</td><td><pre>        :param str csid_from_client: Csid string from client</pre></td></tr><tr><td>605</td><td><pre>        :param str user_id: id of the queried user</pre></td></tr><tr><td>606</td><td><pre>        :response_data: Returns list of pins of a current user</pre></td></tr><tr><td>607</td><td><pre></pre></td></tr><tr><td>608</td><td><pre>        :to test: curl --data "user_id=78&amp;csid_from_client=1" http://localhost:8080/api/profile/userinfo/pins</pre></td></tr><tr><td>609</td><td><pre>        """</pre></td></tr><tr class="accepted"><td>610</td><td><pre>        query = '''</pre></td></tr><tr class="accepted"><td>611</td><td><pre>        select tags.tags, pins.*, users.pic_id as user_pic,</pre></td></tr><tr class="accepted"><td>612</td><td><pre>        users.username as user_username, users.name as user_name,</pre></td></tr><tr class="accepted"><td>613</td><td><pre>        count(distinct p1) as repin_count,</pre></td></tr><tr class="accepted"><td>614</td><td><pre>        count(distinct l1) as like_count</pre></td></tr><tr class="accepted"><td>615</td><td><pre>        from users</pre></td></tr><tr class="accepted"><td>616</td><td><pre>        left join pins on pins.user_id = users.id</pre></td></tr><tr class="accepted"><td>617</td><td><pre>        left join tags on tags.pin_id = pins.id</pre></td></tr><tr class="accepted"><td>618</td><td><pre>        left join pins p1 on p1.repin = pins.id</pre></td></tr><tr class="accepted"><td>619</td><td><pre>        left join likes l1 on l1.pin_id = pins.id</pre></td></tr><tr class="accepted"><td>620</td><td><pre>        where users.id = $id</pre></td></tr><tr class="accepted"><td>621</td><td><pre>        group by tags.tags, pins.id, users.id</pre></td></tr><tr class="accepted"><td>622</td><td><pre>        order by timestamp desc'''</pre></td></tr><tr><td>623</td><td><pre></pre></td></tr><tr><td>624</td><td><pre>        request_data = web.input()</pre></td></tr><tr><td>625</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>626</td><td><pre>        csid_from_server = ""</pre></td></tr><tr><td>627</td><td><pre>        user_id = request_data.get('user_id')</pre></td></tr><tr><td>628</td><td><pre></pre></td></tr><tr><td>629</td><td><pre>        if not user_id:</pre></td></tr><tr class="accepted"><td>630</td><td><pre>            return api_response(data={}, status=405,</pre></td></tr><tr><td>631</td><td><pre>                                error_code="Missing user_id")</pre></td></tr><tr class=""><td>632</td><td><pre>        results = db.query(query, vars={'id': user_id})</pre></td></tr><tr><td>633</td><td><pre></pre></td></tr><tr><td>634</td><td><pre>        pins = []</pre></td></tr><tr><td>635</td><td><pre>        current_row = None</pre></td></tr><tr><td>636</td><td><pre>        pins_counter = 0</pre></td></tr><tr><td>637</td><td><pre>        owned_pins_counter = 0</pre></td></tr><tr><td>638</td><td><pre>        for row in results:</pre></td></tr><tr><td>639</td><td><pre>            if not row.id:</pre></td></tr><tr><td>640</td><td><pre>                continue</pre></td></tr><tr><td>641</td><td><pre>            if not current_row or current_row.id != row.id:</pre></td></tr><tr><td>642</td><td><pre>                current_row = row</pre></td></tr><tr><td>643</td><td><pre>                tag = row.tags</pre></td></tr><tr><td>644</td><td><pre>                current_row.tags = []</pre></td></tr><tr><td>645</td><td><pre>                if tag:</pre></td></tr><tr><td>646</td><td><pre>                    current_row.tags.append(tag)</pre></td></tr><tr><td>647</td><td><pre></pre></td></tr><tr><td>648</td><td><pre>                current_row_dt = datetime.fromtimestamp(current_row.timestamp)</pre></td></tr><tr><td>649</td><td><pre></pre></td></tr><tr><td>650</td><td><pre>                pins.append(current_row)</pre></td></tr><tr><td>651</td><td><pre>                if not current_row.get("repin"):</pre></td></tr><tr><td>652</td><td><pre>                    owned_pins_counter += 1</pre></td></tr><tr><td>653</td><td><pre>            else:</pre></td></tr><tr><td>654</td><td><pre>                tag = row.tags</pre></td></tr><tr><td>655</td><td><pre>                if tag not in current_row.tags:</pre></td></tr><tr><td>656</td><td><pre>                    current_row.tags.append(tag)</pre></td></tr><tr><td>657</td><td><pre>            pins_counter += 1</pre></td></tr><tr><td>658</td><td><pre></pre></td></tr><tr><td>659</td><td><pre>        data = {</pre></td></tr><tr><td>660</td><td><pre>            "total": pins_counter,</pre></td></tr><tr><td>661</td><td><pre>            "total_owned": owned_pins_counter</pre></td></tr><tr><td>662</td><td><pre>        }</pre></td></tr><tr><td>663</td><td><pre>        page = int(request_data.get("page", 1))</pre></td></tr><tr><td>664</td><td><pre>        if page is not None:</pre></td></tr><tr><td>665</td><td><pre>            items_per_page = int(request_data.get("items_per_page", 10))</pre></td></tr><tr><td>666</td><td><pre>            if items_per_page &lt; 1:</pre></td></tr><tr><td>667</td><td><pre>                items_per_page = 1</pre></td></tr><tr><td>668</td><td><pre></pre></td></tr><tr><td>669</td><td><pre>            data['pages_count'] = math.ceil(float(len(pins)) /</pre></td></tr><tr><td>670</td><td><pre>                                            float(items_per_page))</pre></td></tr><tr><td>671</td><td><pre>            data['pages_count'] = int(data['pages_count'])</pre></td></tr><tr><td>672</td><td><pre>            data['page'] = page</pre></td></tr><tr><td>673</td><td><pre>            data['items_per_page'] = items_per_page</pre></td></tr><tr><td>674</td><td><pre></pre></td></tr><tr><td>675</td><td><pre>            start = (page-1) * items_per_page</pre></td></tr><tr><td>676</td><td><pre>            end = start + items_per_page</pre></td></tr><tr><td>677</td><td><pre>            data['pins_list'] = pins[start:end]</pre></td></tr><tr><td>678</td><td><pre>        else:</pre></td></tr><tr><td>679</td><td><pre>            data['pins_list'] = pins</pre></td></tr><tr><td>680</td><td><pre></pre></td></tr><tr><td>681</td><td><pre>        return api_response(data=data,</pre></td></tr><tr><td>682</td><td><pre>                            csid_from_server=csid_from_server,</pre></td></tr><tr><td>683</td><td><pre>                            csid_from_client=csid_from_client)</pre></td></tr><tr><td>684</td><td><pre></pre></td></tr><tr><td>685</td><td><pre>class TestUsernameOrEmail(BaseAPI):</pre></td></tr><tr><td>686</td><td><pre>    """</pre></td></tr><tr><td>687</td><td><pre>    Checks if given username or email is already added to database.</pre></td></tr><tr><td>688</td><td><pre>    in case if a username</pre></td></tr><tr><td>689</td><td><pre></pre></td></tr><tr><td>690</td><td><pre>    :link: /api/profile/test-username</pre></td></tr><tr><td>691</td><td><pre>    """</pre></td></tr><tr><td>692</td><td><pre>    def POST(self):</pre></td></tr><tr><td>693</td><td><pre>        """</pre></td></tr><tr><td>694</td><td><pre>        :param str csid_from_client: Csid string from client</pre></td></tr><tr><td>695</td><td><pre>        :param str logintoken: username_or_email</pre></td></tr><tr><td>696</td><td><pre>        :response data: returns 'ok' or 'notfound'</pre></td></tr><tr><td>697</td><td><pre>        :to test: curl --data "csid_from_client=1&amp;username_or_email=oleg" http://localhost:8080/api/profile/test-username</pre></td></tr><tr><td>698</td><td><pre>        """</pre></td></tr><tr><td>699</td><td><pre>        request_data = web.input()</pre></td></tr><tr><td>700</td><td><pre>        username_or_email = request_data.get('username_or_email')</pre></td></tr><tr><td>701</td><td><pre></pre></td></tr><tr><td>702</td><td><pre>        vars={'username_or_email': username_or_email}</pre></td></tr><tr><td>703</td><td><pre>        # Trying to find a user with same username</pre></td></tr><tr class="accepted"><td>704</td><td><pre>        result = db.select('users', vars=vars,</pre></td></tr><tr class="accepted"><td>705</td><td><pre>                           where='username=$username_or_email')</pre></td></tr><tr class="accepted"><td>706</td><td><pre>        # Fallback, trying to find user with same email</pre></td></tr><tr class="accepted"><td>707</td><td><pre>        if len(result.list()) == 0:</pre></td></tr><tr class="accepted"><td>708</td><td><pre>            result = db.select('users', vars=vars,</pre></td></tr><tr class="accepted"><td>709</td><td><pre>                               where='email=$username_or_email')</pre></td></tr><tr><td>710</td><td><pre></pre></td></tr><tr><td>711</td><td><pre>        if len(result.list()) == 0:</pre></td></tr><tr><td>712</td><td><pre>            status = 'notfound'</pre></td></tr><tr><td>713</td><td><pre>        else:</pre></td></tr><tr><td>714</td><td><pre>            status = 'ok'</pre></td></tr><tr><td>715</td><td><pre></pre></td></tr><tr><td>716</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>717</td><td><pre>        csid_from_server = ""</pre></td></tr><tr><td>718</td><td><pre>        return api_response(data=status,</pre></td></tr><tr><td>719</td><td><pre>                            csid_from_server=csid_from_server,</pre></td></tr><tr><td>720</td><td><pre>                            csid_from_client=csid_from_client)</pre></td></tr><tr><td>721</td><td><pre></pre></td></tr><tr><td>722</td><td><pre></pre></td></tr><tr><td>723</td><td><pre>class PicUpload(BaseAPI):</pre></td></tr><tr><td>724</td><td><pre>    """</pre></td></tr><tr><td>725</td><td><pre>    Upload profile picture and save it in database</pre></td></tr><tr><td>726</td><td><pre></pre></td></tr><tr><td>727</td><td><pre>    :link: /api/profile/userinfo/upload_pic</pre></td></tr><tr><td>728</td><td><pre>    """</pre></td></tr><tr><td>729</td><td><pre>    def POST(self):</pre></td></tr><tr><td>730</td><td><pre>        """</pre></td></tr><tr><td>731</td><td><pre>        :param str csid_from_client: Csid string from client</pre></td></tr><tr><td>732</td><td><pre>        :param str logintoken: logintoken of user</pre></td></tr><tr><td>733</td><td><pre>        :param file file: file for saving</pre></td></tr><tr><td>734</td><td><pre>        :response data: returns id, original_url, resized_url of saved picture</pre></td></tr><tr><td>735</td><td><pre>        :to test: curl -F "csid_from_client=1" -F "logintoken=AmWG6AhgPO" -F "file=@/image/for/test.jpg" http://localhost:8080/api/profile/userinfo/upload_pic</pre></td></tr><tr><td>736</td><td><pre>        """</pre></td></tr><tr><td>737</td><td><pre>        data = {}</pre></td></tr><tr><td>738</td><td><pre>        status = 200</pre></td></tr><tr><td>739</td><td><pre>        csid_from_server = None</pre></td></tr><tr><td>740</td><td><pre>        error_code = ""</pre></td></tr><tr><td>741</td><td><pre></pre></td></tr><tr><td>742</td><td><pre>        request_data = web.input(file={})</pre></td></tr><tr><td>743</td><td><pre>        logintoken = request_data.get('logintoken')</pre></td></tr><tr><td>744</td><td><pre></pre></td></tr><tr><td>745</td><td><pre>        user_status, user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>746</td><td><pre>        # User id contains error code</pre></td></tr><tr><td>747</td><td><pre>        if not user_status:</pre></td></tr><tr><td>748</td><td><pre>            return user</pre></td></tr><tr><td>749</td><td><pre></pre></td></tr><tr><td>750</td><td><pre>        csid_from_server = user['seriesid']</pre></td></tr><tr><td>751</td><td><pre>        csid_from_client = request_data.get("csid_from_client")</pre></td></tr><tr><td>752</td><td><pre></pre></td></tr><tr><td>753</td><td><pre>        file_obj = request_data.get('file')</pre></td></tr><tr><td>754</td><td><pre></pre></td></tr><tr><td>755</td><td><pre>        # For some reason, FileStorage object treats itself as False</pre></td></tr><tr><td>756</td><td><pre>        if type(file_obj) == dict:</pre></td></tr><tr class="accepted"><td>757</td><td><pre>            return api_response(data={}, status=405,</pre></td></tr><tr><td>758</td><td><pre>                                error_code="Required args are missing")</pre></td></tr><tr><td>759</td><td><pre></pre></td></tr><tr><td>760</td><td><pre>        album, album_created = self._get_or_create_album(user['id'], 'photos')</pre></td></tr><tr><td>761</td><td><pre>        photo = self._save_in_database(file_obj, 300, album.id)</pre></td></tr><tr><td>762</td><td><pre></pre></td></tr><tr><td>763</td><td><pre>        user_to_update = web.ctx.orm.query(User)\</pre></td></tr><tr><td>764</td><td><pre>            .filter(User.id == user['id'])\</pre></td></tr><tr><td>765</td><td><pre>            .first()</pre></td></tr><tr><td>766</td><td><pre></pre></td></tr><tr><td>767</td><td><pre>        user_to_update.pic_obj = photo</pre></td></tr><tr><td>768</td><td><pre>        if album_created:</pre></td></tr><tr><td>769</td><td><pre>            album.cover = photo</pre></td></tr><tr><td>770</td><td><pre>        web.ctx.orm.commit()</pre></td></tr><tr><td>771</td><td><pre></pre></td></tr><tr><td>772</td><td><pre>        data['id'] = photo.id</pre></td></tr><tr><td>773</td><td><pre>        data['original_url'] = photo.original_url</pre></td></tr><tr><td>774</td><td><pre>        data['resized_url'] = photo.resized_url</pre></td></tr><tr><td>775</td><td><pre></pre></td></tr><tr><td>776</td><td><pre>        response = api_response(data=data,</pre></td></tr><tr><td>777</td><td><pre>                                status=status,</pre></td></tr><tr><td>778</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>779</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>780</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>781</td><td><pre></pre></td></tr><tr><td>782</td><td><pre>        return response</pre></td></tr><tr><td>783</td><td><pre></pre></td></tr><tr><td>784</td><td><pre>    def _get_or_create_album(self, user_id, slug):</pre></td></tr><tr><td>785</td><td><pre>        album = web.ctx.orm.query(Album).filter(Album.user_id == user_id,</pre></td></tr><tr><td>786</td><td><pre>                                               Album.slug == slug).first()</pre></td></tr><tr><td>787</td><td><pre>        created = False</pre></td></tr><tr><td>788</td><td><pre></pre></td></tr><tr><td>789</td><td><pre>        if not album:</pre></td></tr><tr><td>790</td><td><pre>            album = Album(user_id, slug)</pre></td></tr><tr><td>791</td><td><pre></pre></td></tr><tr><td>792</td><td><pre>            web.ctx.orm.add(album)</pre></td></tr><tr><td>793</td><td><pre>            web.ctx.orm.commit()</pre></td></tr><tr><td>794</td><td><pre>            created = True</pre></td></tr><tr><td>795</td><td><pre></pre></td></tr><tr><td>796</td><td><pre>        return album, created</pre></td></tr><tr><td>797</td><td><pre></pre></td></tr><tr><td>798</td><td><pre>    def _save_in_database(self, file_obj, resized_size, album_id):</pre></td></tr><tr><td>799</td><td><pre>        file_path = self._save_file(file_obj)</pre></td></tr><tr><td>800</td><td><pre>        images_dict = store_image_from_filename(db,</pre></td></tr><tr><td>801</td><td><pre>                                                file_path,</pre></td></tr><tr><td>802</td><td><pre>                                                widths=[resized_size])</pre></td></tr><tr><td>803</td><td><pre></pre></td></tr><tr><td>804</td><td><pre>        picture = Picture(</pre></td></tr><tr><td>805</td><td><pre>            album_id,</pre></td></tr><tr><td>806</td><td><pre>            images_dict[0]['url'],</pre></td></tr><tr><td>807</td><td><pre>            images_dict.get(resized_size, images_dict[0])\</pre></td></tr><tr><td>808</td><td><pre>                .get('url', None)</pre></td></tr><tr><td>809</td><td><pre>        )</pre></td></tr><tr><td>810</td><td><pre></pre></td></tr><tr><td>811</td><td><pre>        web.ctx.orm.add(picture)</pre></td></tr><tr><td>812</td><td><pre>        web.ctx.orm.commit()</pre></td></tr><tr><td>813</td><td><pre></pre></td></tr><tr><td>814</td><td><pre>        return picture</pre></td></tr><tr><td>815</td><td><pre></pre></td></tr><tr><td>816</td><td><pre>    def _save_file(self, file_obj, upload_dir=None):</pre></td></tr><tr><td>817</td><td><pre>        """</pre></td></tr><tr><td>818</td><td><pre>        Saves uploaded file to a given upload dir.</pre></td></tr><tr><td>819</td><td><pre>        """</pre></td></tr><tr><td>820</td><td><pre>        if not upload_dir:</pre></td></tr><tr><td>821</td><td><pre>            upload_dir = self._get_media_path()</pre></td></tr><tr><td>822</td><td><pre>        filename = file_obj.filename</pre></td></tr><tr><td>823</td><td><pre>        filename = self._get_file_name(filename, upload_dir)</pre></td></tr><tr><td>824</td><td><pre>        filepath = os.path.join(upload_dir, filename)</pre></td></tr><tr><td>825</td><td><pre>        upload_file = open(filepath, 'w')</pre></td></tr><tr><td>826</td><td><pre>        upload_file.write(file_obj.file.read())</pre></td></tr><tr><td>827</td><td><pre>        upload_file.close()</pre></td></tr><tr><td>828</td><td><pre>        return filepath</pre></td></tr><tr><td>829</td><td><pre></pre></td></tr><tr><td>830</td><td><pre>    def _get_media_path(self):</pre></td></tr><tr><td>831</td><td><pre>        """</pre></td></tr><tr><td>832</td><td><pre>        Returns or creates media directory.</pre></td></tr><tr><td>833</td><td><pre>        """</pre></td></tr><tr><td>834</td><td><pre>        media_path = settings.MEDIA_PATH</pre></td></tr><tr><td>835</td><td><pre>        if not os.path.exists(media_path):</pre></td></tr><tr><td>836</td><td><pre>            os.makedirs(media_path)</pre></td></tr><tr><td>837</td><td><pre>        return media_path</pre></td></tr><tr><td>838</td><td><pre></pre></td></tr><tr><td>839</td><td><pre>    def _get_file_name(self, filename, upload_dir):</pre></td></tr><tr><td>840</td><td><pre>        """</pre></td></tr><tr><td>841</td><td><pre>        Method responsible for avoiding duplicated filenames.</pre></td></tr><tr><td>842</td><td><pre>        """</pre></td></tr><tr><td>843</td><td><pre>        filepath = os.path.join(upload_dir, filename)</pre></td></tr><tr><td>844</td><td><pre>        exists = os.path.isfile(filepath)</pre></td></tr><tr><td>845</td><td><pre>        # Suggest uuid hex as a filename to avoid duplicates</pre></td></tr><tr><td>846</td><td><pre>        if exists:</pre></td></tr><tr><td>847</td><td><pre>            filename = "%s.%s" % (uuid.uuid4().hex[:10], filename)</pre></td></tr><tr><td>848</td><td><pre>        return filename</pre></td></tr><tr><td>849</td><td><pre></pre></td></tr><tr><td>850</td><td><pre></pre></td></tr><tr><td>851</td><td><pre>class BgUpload(PicUpload):</pre></td></tr><tr><td>852</td><td><pre>    """</pre></td></tr><tr><td>853</td><td><pre>    Upload profile background and save it in database</pre></td></tr><tr><td>854</td><td><pre></pre></td></tr><tr><td>855</td><td><pre>    :link: /api/profile/userinfo/upload_bg</pre></td></tr><tr><td>856</td><td><pre>    """</pre></td></tr><tr><td>857</td><td><pre>    def POST(self):</pre></td></tr><tr><td>858</td><td><pre>        """</pre></td></tr><tr><td>859</td><td><pre>        :param str csid_from_client: Csid string from client</pre></td></tr><tr><td>860</td><td><pre>        :param str logintoken: logintoken of user</pre></td></tr><tr><td>861</td><td><pre>        :param file file: file for saving</pre></td></tr><tr><td>862</td><td><pre>        :response data: returns id, original_url, resized_url of saved picture</pre></td></tr><tr><td>863</td><td><pre>        :to test: curl -F "csid_from_client=1" -F "logintoken=AmWG6AhgPO" -F "file=@/image/for/test.jpg" http://localhost:8080/api/profile/userinfo/upload_bg</pre></td></tr><tr><td>864</td><td><pre>        """</pre></td></tr><tr><td>865</td><td><pre>        data = {}</pre></td></tr><tr><td>866</td><td><pre>        status = 200</pre></td></tr><tr><td>867</td><td><pre>        csid_from_server = None</pre></td></tr><tr><td>868</td><td><pre>        error_code = ""</pre></td></tr><tr><td>869</td><td><pre></pre></td></tr><tr><td>870</td><td><pre>        request_data = web.input(file={})</pre></td></tr><tr><td>871</td><td><pre>        logintoken = request_data.get('logintoken')</pre></td></tr><tr><td>872</td><td><pre></pre></td></tr><tr><td>873</td><td><pre>        user_status, user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>874</td><td><pre>        # User id contains error code</pre></td></tr><tr><td>875</td><td><pre>        if not user_status:</pre></td></tr><tr><td>876</td><td><pre>            return user</pre></td></tr><tr><td>877</td><td><pre></pre></td></tr><tr><td>878</td><td><pre>        csid_from_server = user['seriesid']</pre></td></tr><tr><td>879</td><td><pre>        csid_from_client = request_data.get("csid_from_client")</pre></td></tr><tr><td>880</td><td><pre></pre></td></tr><tr><td>881</td><td><pre>        file_obj = request_data.get('file')</pre></td></tr><tr><td>882</td><td><pre></pre></td></tr><tr><td>883</td><td><pre>        # For some reason, FileStorage object treats itself as False</pre></td></tr><tr><td>884</td><td><pre>        if type(file_obj) == dict:</pre></td></tr><tr class="accepted"><td>885</td><td><pre>            return api_response(data={}, status=405,</pre></td></tr><tr><td>886</td><td><pre>                                error_code="Required args are missing")</pre></td></tr><tr><td>887</td><td><pre></pre></td></tr><tr><td>888</td><td><pre>        album, album_created = self._get_or_create_album(user['id'],</pre></td></tr><tr><td>889</td><td><pre>                                                         'backgrounds')</pre></td></tr><tr><td>890</td><td><pre>        photo = self._save_in_database(file_obj, 1100, album.id)</pre></td></tr><tr><td>891</td><td><pre></pre></td></tr><tr><td>892</td><td><pre>        user_to_update = web.ctx.orm.query(User)\</pre></td></tr><tr><td>893</td><td><pre>            .filter(User.id == user['id'])\</pre></td></tr><tr><td>894</td><td><pre>            .first()</pre></td></tr><tr><td>895</td><td><pre></pre></td></tr><tr><td>896</td><td><pre>        user_to_update.bg = photo</pre></td></tr><tr><td>897</td><td><pre>        if album_created:</pre></td></tr><tr><td>898</td><td><pre>            album.cover = photo</pre></td></tr><tr><td>899</td><td><pre>        web.ctx.orm.commit()</pre></td></tr><tr><td>900</td><td><pre></pre></td></tr><tr><td>901</td><td><pre>        data['id'] = photo.id</pre></td></tr><tr><td>902</td><td><pre>        data['original_url'] = photo.original_url</pre></td></tr><tr><td>903</td><td><pre>        data['resized_url'] = photo.resized_url</pre></td></tr><tr><td>904</td><td><pre></pre></td></tr><tr><td>905</td><td><pre>        response = api_response(data=data,</pre></td></tr><tr><td>906</td><td><pre>                                status=status,</pre></td></tr><tr><td>907</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>908</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>909</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>910</td><td><pre></pre></td></tr><tr><td>911</td><td><pre>        return response</pre></td></tr><tr><td>912</td><td><pre></pre></td></tr><tr><td>913</td><td><pre></pre></td></tr><tr><td>914</td><td><pre>class GetPictures(BaseAPI):</pre></td></tr><tr><td>915</td><td><pre>    """</pre></td></tr><tr><td>916</td><td><pre>    API method for get photos of user</pre></td></tr><tr><td>917</td><td><pre></pre></td></tr><tr><td>918</td><td><pre>    :link: /api/profile/userinfo/get_pictures</pre></td></tr><tr><td>919</td><td><pre>    """</pre></td></tr><tr><td>920</td><td><pre>    def POST(self):</pre></td></tr><tr><td>921</td><td><pre>        """</pre></td></tr><tr><td>922</td><td><pre>        :param str csid_from_client: Csid string from client</pre></td></tr><tr><td>923</td><td><pre>        :param str logintoken: logintoken of user (is not required)</pre></td></tr><tr><td>924</td><td><pre>        :param int user_id: id of user</pre></td></tr><tr><td>925</td><td><pre>        :param str album_type: type of pictures (photos|backgrounds)</pre></td></tr><tr><td>926</td><td><pre>        :response data: returns photos - list of pictures</pre></td></tr><tr><td>927</td><td><pre>        :to test: curl --data "csid_from_client=1&amp;user_id=93&amp;album_type=photos" http://localhost:8080/api/profile/userinfo/get_pictures</pre></td></tr><tr><td>928</td><td><pre>        """</pre></td></tr><tr><td>929</td><td><pre>        request_data = web.input()</pre></td></tr><tr><td>930</td><td><pre></pre></td></tr><tr><td>931</td><td><pre>        update_data = {}</pre></td></tr><tr><td>932</td><td><pre>        data = {}</pre></td></tr><tr><td>933</td><td><pre>        status = 200</pre></td></tr><tr><td>934</td><td><pre>        csid_from_server = None</pre></td></tr><tr><td>935</td><td><pre>        error_code = ""</pre></td></tr><tr><td>936</td><td><pre></pre></td></tr><tr><td>937</td><td><pre>        # Get data from request</pre></td></tr><tr><td>938</td><td><pre>        user_id = request_data.get("user_id")</pre></td></tr><tr><td>939</td><td><pre>        album_type = request_data.get("album_type")</pre></td></tr><tr><td>940</td><td><pre></pre></td></tr><tr><td>941</td><td><pre>        # This if is a monkeypatch, which allows to map</pre></td></tr><tr><td>942</td><td><pre>        # photos to any other non background slug</pre></td></tr><tr><td>943</td><td><pre>        # TODO: replace this code</pre></td></tr><tr><td>944</td><td><pre>        if album_type != "backgrounds":</pre></td></tr><tr><td>945</td><td><pre>            album_type = "photos"</pre></td></tr><tr><td>946</td><td><pre></pre></td></tr><tr><td>947</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>948</td><td><pre></pre></td></tr><tr><td>949</td><td><pre>        current_user_id = None</pre></td></tr><tr><td>950</td><td><pre>        logintoken = request_data.get('logintoken', None)</pre></td></tr><tr><td>951</td><td><pre>        if logintoken:</pre></td></tr><tr><td>952</td><td><pre>            user_status, user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>953</td><td><pre>            if user_status:</pre></td></tr><tr><td>954</td><td><pre>                current_user_id = user['id']</pre></td></tr><tr><td>955</td><td><pre></pre></td></tr><tr><td>956</td><td><pre></pre></td></tr><tr><td>957</td><td><pre>        album = web.ctx.orm.query(Album).filter(</pre></td></tr><tr><td>958</td><td><pre>            Album.user_id == user_id,</pre></td></tr><tr><td>959</td><td><pre>            Album.slug == album_type</pre></td></tr><tr><td>960</td><td><pre>        ).first()</pre></td></tr><tr><td>961</td><td><pre></pre></td></tr><tr><td>962</td><td><pre>        data['photos'] = []</pre></td></tr><tr><td>963</td><td><pre></pre></td></tr><tr><td>964</td><td><pre>        if album:</pre></td></tr><tr><td>965</td><td><pre>            pictures = web.ctx.orm.query(Picture).filter(</pre></td></tr><tr><td>966</td><td><pre>                Picture.album_id == album.id</pre></td></tr><tr><td>967</td><td><pre>            ).all()</pre></td></tr><tr><td>968</td><td><pre></pre></td></tr><tr><td>969</td><td><pre>            for picture in pictures:</pre></td></tr><tr><td>970</td><td><pre>                if not picture.resized_url:</pre></td></tr><tr><td>971</td><td><pre>                    continue</pre></td></tr><tr><td>972</td><td><pre></pre></td></tr><tr><td>973</td><td><pre>                picture = picture.to_serializable_dict()</pre></td></tr><tr><td>974</td><td><pre></pre></td></tr><tr><td>975</td><td><pre>                picture['likes_count'] = len(picture['likes'])</pre></td></tr><tr><td>976</td><td><pre></pre></td></tr><tr><td>977</td><td><pre>                if current_user_id:</pre></td></tr><tr><td>978</td><td><pre>                    for like in picture['likes']:</pre></td></tr><tr><td>979</td><td><pre>                        if like['user_id'] == current_user_id:</pre></td></tr><tr><td>980</td><td><pre>                            picture['liked'] = True</pre></td></tr><tr><td>981</td><td><pre>                            break</pre></td></tr><tr><td>982</td><td><pre>                else:</pre></td></tr><tr><td>983</td><td><pre>                    picture['liked'] = False</pre></td></tr><tr><td>984</td><td><pre></pre></td></tr><tr><td>985</td><td><pre>                data['photos'].append(picture)</pre></td></tr><tr><td>986</td><td><pre></pre></td></tr><tr><td>987</td><td><pre>        response = api_response(data=data,</pre></td></tr><tr><td>988</td><td><pre>                                status=status,</pre></td></tr><tr><td>989</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>990</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>991</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>992</td><td><pre>        return response</pre></td></tr><tr><td>993</td><td><pre></pre></td></tr><tr><td>994</td><td><pre></pre></td></tr><tr><td>995</td><td><pre>class PictureRemove(BaseAPI):</pre></td></tr><tr><td>996</td><td><pre>    """</pre></td></tr><tr><td>997</td><td><pre>    Remove picture and save changes in database</pre></td></tr><tr><td>998</td><td><pre></pre></td></tr><tr><td>999</td><td><pre>    :link: /api/profile/userinfo/remove_pic</pre></td></tr><tr><td>1000</td><td><pre>    """</pre></td></tr><tr><td>1001</td><td><pre>    def POST(self):</pre></td></tr><tr><td>1002</td><td><pre>        """</pre></td></tr><tr><td>1003</td><td><pre>        :param str csid_from_client: Csid string from client</pre></td></tr><tr><td>1004</td><td><pre>        :param str logintoken: logintoken of user</pre></td></tr><tr><td>1005</td><td><pre>        :param int picture_id: id of photo that you wish to remove</pre></td></tr><tr><td>1006</td><td><pre>        :response data: no extra rsponse</pre></td></tr><tr><td>1007</td><td><pre>        :to test: curl --data "csid_from_client=1&amp;picture_id=5&amp;logintoken=XXXXXXX" http://localhost:8080/api/profile/userinfo/remove_pic</pre></td></tr><tr><td>1008</td><td><pre>        """</pre></td></tr><tr><td>1009</td><td><pre>        data = {}</pre></td></tr><tr><td>1010</td><td><pre>        status = 200</pre></td></tr><tr><td>1011</td><td><pre>        csid_from_server = None</pre></td></tr><tr><td>1012</td><td><pre>        error_code = ""</pre></td></tr><tr><td>1013</td><td><pre></pre></td></tr><tr><td>1014</td><td><pre>        request_data = web.input()</pre></td></tr><tr><td>1015</td><td><pre>        logintoken = request_data.get('logintoken')</pre></td></tr><tr><td>1016</td><td><pre>        picture_id = request_data.get('picture_id')</pre></td></tr><tr><td>1017</td><td><pre></pre></td></tr><tr><td>1018</td><td><pre>        user_status, user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>1019</td><td><pre>        # User id contains error code</pre></td></tr><tr><td>1020</td><td><pre>        if not user_status:</pre></td></tr><tr><td>1021</td><td><pre>            return user</pre></td></tr><tr><td>1022</td><td><pre></pre></td></tr><tr><td>1023</td><td><pre>        csid_from_server = user['seriesid']</pre></td></tr><tr><td>1024</td><td><pre>        csid_from_client = request_data.get("csid_from_client")</pre></td></tr><tr><td>1025</td><td><pre></pre></td></tr><tr><td>1026</td><td><pre>        self._delete_picture(user['id'], picture_id)</pre></td></tr><tr><td>1027</td><td><pre></pre></td></tr><tr><td>1028</td><td><pre>        response = api_response(data=data,</pre></td></tr><tr><td>1029</td><td><pre>                                status=status,</pre></td></tr><tr><td>1030</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>1031</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>1032</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>1033</td><td><pre></pre></td></tr><tr><td>1034</td><td><pre>        return response</pre></td></tr><tr><td>1035</td><td><pre></pre></td></tr><tr><td>1036</td><td><pre>    def _delete_picture(self, user_id, picture_id):</pre></td></tr><tr><td>1037</td><td><pre>        user_to_update = web.ctx.orm.query(User)\</pre></td></tr><tr><td>1038</td><td><pre>            .filter(User.id == user_id)\</pre></td></tr><tr><td>1039</td><td><pre>            .first()</pre></td></tr><tr><td>1040</td><td><pre></pre></td></tr><tr><td>1041</td><td><pre>        picture = web.ctx.orm.query(Picture)\</pre></td></tr><tr><td>1042</td><td><pre>            .filter(Picture.id == picture_id)\</pre></td></tr><tr><td>1043</td><td><pre>            .first()</pre></td></tr><tr><td>1044</td><td><pre></pre></td></tr><tr><td>1045</td><td><pre>        if picture:</pre></td></tr><tr><td>1046</td><td><pre>            album = web.ctx.orm.query(Album).filter(</pre></td></tr><tr><td>1047</td><td><pre>                Album.id == picture.album_id</pre></td></tr><tr><td>1048</td><td><pre>            ).first()</pre></td></tr><tr><td>1049</td><td><pre></pre></td></tr><tr><td>1050</td><td><pre>            if album.user_id == user_to_update.id:</pre></td></tr><tr><td>1051</td><td><pre>                # if album.slug == "photos":</pre></td></tr><tr><td>1052</td><td><pre>                #     if user_to_update.pic_id == picture.id:</pre></td></tr><tr><td>1053</td><td><pre>                #         user_to_update.pic_obj = self._get_next_picture(album,</pre></td></tr><tr><td>1054</td><td><pre>                #                                                     picture)</pre></td></tr><tr><td>1055</td><td><pre>                # elif album.slug == "backgrounds":</pre></td></tr><tr><td>1056</td><td><pre>                #     if user_to_update.bg_id == picture.id:</pre></td></tr><tr><td>1057</td><td><pre>                #         user_to_update.bg = self._get_next_picture(album,</pre></td></tr><tr><td>1058</td><td><pre>                #                                                    picture)</pre></td></tr><tr><td>1059</td><td><pre>                #         user_to_update.bgx = 0</pre></td></tr><tr><td>1060</td><td><pre>                #         user_to_update.bgy = 0</pre></td></tr><tr><td>1061</td><td><pre></pre></td></tr><tr><td>1062</td><td><pre>                if album.cover_id == picture.id:</pre></td></tr><tr><td>1063</td><td><pre>                    album.cover = self._get_next_picture(album,</pre></td></tr><tr><td>1064</td><td><pre>                                                         picture)</pre></td></tr><tr><td>1065</td><td><pre></pre></td></tr><tr><td>1066</td><td><pre>                for comment in picture.comments:</pre></td></tr><tr><td>1067</td><td><pre>                    web.ctx.orm.delete(comment)</pre></td></tr><tr><td>1068</td><td><pre></pre></td></tr><tr><td>1069</td><td><pre>                for like in picture.likes:</pre></td></tr><tr><td>1070</td><td><pre>                    web.ctx.orm.delete(like)</pre></td></tr><tr><td>1071</td><td><pre></pre></td></tr><tr><td>1072</td><td><pre>                web.ctx.orm.delete(picture)</pre></td></tr><tr><td>1073</td><td><pre>                web.ctx.orm.commit()</pre></td></tr><tr><td>1074</td><td><pre></pre></td></tr><tr><td>1075</td><td><pre>    def _get_next_picture(self, album, picture):</pre></td></tr><tr><td>1076</td><td><pre>        for pic in album.pictures:</pre></td></tr><tr><td>1077</td><td><pre>            if picture.id != pic.id:</pre></td></tr><tr><td>1078</td><td><pre>                return pic</pre></td></tr><tr><td>1079</td><td><pre>        return None</pre></td></tr><tr><td>1080</td><td><pre></pre></td></tr><tr><td>1081</td><td><pre></pre></td></tr><tr><td>1082</td><td><pre>class AlbumDefaultPic(BaseAPI):</pre></td></tr><tr><td>1083</td><td><pre>    """</pre></td></tr><tr><td>1084</td><td><pre>    Sets picture as default album cover</pre></td></tr><tr><td>1085</td><td><pre></pre></td></tr><tr><td>1086</td><td><pre>    :link: /api/profile/userinfo/album_default_picture</pre></td></tr><tr><td>1087</td><td><pre>    """</pre></td></tr><tr><td>1088</td><td><pre>    def POST(self):</pre></td></tr><tr><td>1089</td><td><pre>        """</pre></td></tr><tr><td>1090</td><td><pre>        :param str csid_from_client: Csid string from client</pre></td></tr><tr><td>1091</td><td><pre>        :param str logintoken: logintoken of user</pre></td></tr><tr><td>1092</td><td><pre>        :param int picture_id: id of photo that you wish tis set as xover</pre></td></tr><tr><td>1093</td><td><pre>        :response data: no extra rsponse</pre></td></tr><tr><td>1094</td><td><pre>        :to test: curl --data "csid_from_client=1&amp;picture_id=5&amp;logintoken=XXXXXXX" http://localhost:8080/api/profile/userinfo/album_default_picture</pre></td></tr><tr><td>1095</td><td><pre>        """</pre></td></tr><tr><td>1096</td><td><pre>        data = {}</pre></td></tr><tr><td>1097</td><td><pre>        status = 200</pre></td></tr><tr><td>1098</td><td><pre>        csid_from_server = None</pre></td></tr><tr><td>1099</td><td><pre>        error_code = ""</pre></td></tr><tr><td>1100</td><td><pre></pre></td></tr><tr><td>1101</td><td><pre>        request_data = web.input()</pre></td></tr><tr><td>1102</td><td><pre>        logintoken = request_data.get('logintoken')</pre></td></tr><tr><td>1103</td><td><pre>        picture_id = request_data.get('picture_id')</pre></td></tr><tr><td>1104</td><td><pre></pre></td></tr><tr><td>1105</td><td><pre>        user_status, user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>1106</td><td><pre>        # User id contains error code</pre></td></tr><tr><td>1107</td><td><pre>        if not user_status:</pre></td></tr><tr><td>1108</td><td><pre>            return user</pre></td></tr><tr><td>1109</td><td><pre></pre></td></tr><tr><td>1110</td><td><pre>        csid_from_server = user['seriesid']</pre></td></tr><tr><td>1111</td><td><pre>        csid_from_client = request_data.get("csid_from_client")</pre></td></tr><tr><td>1112</td><td><pre></pre></td></tr><tr><td>1113</td><td><pre>        self._set_picture(user['id'], picture_id)</pre></td></tr><tr><td>1114</td><td><pre></pre></td></tr><tr><td>1115</td><td><pre>        response = api_response(data=data,</pre></td></tr><tr><td>1116</td><td><pre>                                status=status,</pre></td></tr><tr><td>1117</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>1118</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>1119</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>1120</td><td><pre></pre></td></tr><tr><td>1121</td><td><pre>        return response</pre></td></tr><tr><td>1122</td><td><pre></pre></td></tr><tr><td>1123</td><td><pre>    def _set_picture(self, user_id, picture_id):</pre></td></tr><tr><td>1124</td><td><pre>        user = web.ctx.orm.query(User)\</pre></td></tr><tr><td>1125</td><td><pre>            .filter(User.id == user_id)\</pre></td></tr><tr><td>1126</td><td><pre>            .first()</pre></td></tr><tr><td>1127</td><td><pre></pre></td></tr><tr><td>1128</td><td><pre>        picture = web.ctx.orm.query(Picture)\</pre></td></tr><tr><td>1129</td><td><pre>            .filter(Picture.id == picture_id)\</pre></td></tr><tr><td>1130</td><td><pre>            .first()</pre></td></tr><tr><td>1131</td><td><pre></pre></td></tr><tr><td>1132</td><td><pre>        if picture:</pre></td></tr><tr><td>1133</td><td><pre>            album = web.ctx.orm.query(Album).filter(</pre></td></tr><tr><td>1134</td><td><pre>                Album.id == picture.album_id</pre></td></tr><tr><td>1135</td><td><pre>            ).first()</pre></td></tr><tr><td>1136</td><td><pre></pre></td></tr><tr><td>1137</td><td><pre>            if album.user_id == user.id:</pre></td></tr><tr><td>1138</td><td><pre>                album.cover = picture</pre></td></tr><tr><td>1139</td><td><pre>                web.ctx.orm.commit()</pre></td></tr><tr><td>1140</td><td><pre>&lt;/username&gt;&lt;/field&gt;</pre></td></tr></tbody></table></article></body></html>