<html><head><title>images.py</title><link rel="stylesheet" type="text/css" href="/style.css"></head><body><article>
    <div id="container"><div class="comment ui-draggable ui-draggable-handle" style="top: 14282px; left: 18px;" data-lines="[794,795,796,797,798,799,800]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 13778px; left: 18px;" data-lines="[766]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 12824px; left: 18px;" data-lines="[713,714,715,716,717,718,719,720,721,722,723,724,725,726]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 11564px; left: 18px;" data-lines="[643]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 10376px; left: 18px;" data-lines="[577,578,579,580,581,582,583,584,585,586,587,588,589,590]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 9602px; left: 18px;" data-lines="[534,535,536,537,538,539,540,541,542,543,544,545,546,547,548,549]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 8972px; left: 18px;" data-lines="[499,500,501,502,503,504,505,506,507,508,509,510,511,512]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 7892px; left: 18px;" data-lines="[439,440,441]">sql in loop</div><div class="comment ui-draggable ui-draggable-handle" style="top: 7856px; left: 18px;" data-lines="[437]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 6668px; left: 18px;" data-lines="[371,372,373,374,375,376,377,378,379,380,381,382,383,385,386,388]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 4130px; left: 18px;" data-lines="[230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 2978px; left: 18px;" data-lines="[166,167,175,176,182]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 1808px; left: 18px;" data-lines="[101]">sql</div></div>
    <table id="source"><tbody><tr><td>1</td><td><pre>""" Implements images part of the API """</pre></td></tr><tr><td>2</td><td><pre>import os</pre></td></tr><tr><td>3</td><td><pre>import web</pre></td></tr><tr><td>4</td><td><pre>import uuid</pre></td></tr><tr><td>5</td><td><pre>import datetime</pre></td></tr><tr><td>6</td><td><pre>import math</pre></td></tr><tr><td>7</td><td><pre>import random</pre></td></tr><tr><td>8</td><td><pre>import string</pre></td></tr><tr><td>9</td><td><pre></pre></td></tr><tr><td>10</td><td><pre>from mypinnings import database</pre></td></tr><tr><td>11</td><td><pre>from api.views.base import BaseAPI</pre></td></tr><tr><td>12</td><td><pre>from api.utils import api_response, save_api_request, photo_id_to_url</pre></td></tr><tr><td>13</td><td><pre>from api.utils import e_response</pre></td></tr><tr><td>14</td><td><pre>from mypinnings.database import connect_db</pre></td></tr><tr><td>15</td><td><pre>from mypinnings.conf import settings</pre></td></tr><tr><td>16</td><td><pre>from mypinnings.media import store_image_from_filename</pre></td></tr><tr><td>17</td><td><pre></pre></td></tr><tr><td>18</td><td><pre>db = connect_db()</pre></td></tr><tr><td>19</td><td><pre></pre></td></tr><tr><td>20</td><td><pre>DIGITS_AND_LETTERS = string.ascii_letters + string.digits</pre></td></tr><tr><td>21</td><td><pre></pre></td></tr><tr><td>22</td><td><pre></pre></td></tr><tr><td>23</td><td><pre>class ImageUpload(BaseAPI):</pre></td></tr><tr><td>24</td><td><pre>    """ Handles image upload and storing it on the file system """</pre></td></tr><tr><td>25</td><td><pre>    def POST(self):</pre></td></tr><tr><td>26</td><td><pre>        """ Images upload main handler</pre></td></tr><tr><td>27</td><td><pre></pre></td></tr><tr><td>28</td><td><pre>        Can be tested using the following command:</pre></td></tr><tr><td>29</td><td><pre>        curl -F "image_title=some_title" -F "image_descr=some_descr" \</pre></td></tr><tr><td>30</td><td><pre>        -F "image_file=@/home/oleg/Desktop/hard.jpg" \</pre></td></tr><tr><td>31</td><td><pre>        http://localhost:8080/api/image/upload</pre></td></tr><tr><td>32</td><td><pre>        """</pre></td></tr><tr><td>33</td><td><pre>        data = {}</pre></td></tr><tr><td>34</td><td><pre>        status = 200</pre></td></tr><tr><td>35</td><td><pre>        csid_from_server = None</pre></td></tr><tr><td>36</td><td><pre>        error_code = ""</pre></td></tr><tr><td>37</td><td><pre></pre></td></tr><tr><td>38</td><td><pre>        request_data = web.input(image_file={})</pre></td></tr><tr><td>39</td><td><pre>        logintoken = request_data.get('logintoken')</pre></td></tr><tr><td>40</td><td><pre></pre></td></tr><tr><td>41</td><td><pre>        user_status, user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>42</td><td><pre>        # User id contains error code</pre></td></tr><tr><td>43</td><td><pre>        if not user_status:</pre></td></tr><tr><td>44</td><td><pre>            return user</pre></td></tr><tr><td>45</td><td><pre></pre></td></tr><tr><td>46</td><td><pre>        csid_from_server = user['seriesid']</pre></td></tr><tr><td>47</td><td><pre>        csid_from_client = request_data.get("csid_from_client")</pre></td></tr><tr><td>48</td><td><pre></pre></td></tr><tr><td>49</td><td><pre>        save_api_request(request_data)</pre></td></tr><tr><td>50</td><td><pre>        file_obj = request_data.get('image_file')</pre></td></tr><tr><td>51</td><td><pre></pre></td></tr><tr><td>52</td><td><pre>        # For some reason, FileStorage object treats itself as False</pre></td></tr><tr><td>53</td><td><pre>        if type(file_obj) == dict:</pre></td></tr><tr><td>54</td><td><pre>            return api_response(data={}, status=405,</pre></td></tr><tr><td>55</td><td><pre>                                error_code="Required args are missing")</pre></td></tr><tr><td>56</td><td><pre></pre></td></tr><tr><td>57</td><td><pre>        file_path = self.save_file(file_obj)</pre></td></tr><tr><td>58</td><td><pre>        images_dict = store_image_from_filename(db,</pre></td></tr><tr><td>59</td><td><pre>                                                file_path,</pre></td></tr><tr><td>60</td><td><pre>                                                widths=(202, 212))</pre></td></tr><tr><td>61</td><td><pre></pre></td></tr><tr><td>62</td><td><pre>        external_id = _generate_external_id()</pre></td></tr><tr><td>63</td><td><pre></pre></td></tr><tr><td>64</td><td><pre>        image_kwargs = {'name': request_data.get("image_title"),</pre></td></tr><tr><td>65</td><td><pre>                        'description': request_data.get("image_descr"),</pre></td></tr><tr><td>66</td><td><pre>                        'user_id': user['id'],</pre></td></tr><tr><td>67</td><td><pre>                        'link': request_data.get("link"),</pre></td></tr><tr><td>68</td><td><pre>                        'product_url': request_data.get("product_url"),</pre></td></tr><tr><td>69</td><td><pre>                        'price': request_data.get("price"),</pre></td></tr><tr><td>70</td><td><pre>                        'price_range': request_data.get("price_range"),</pre></td></tr><tr><td>71</td><td><pre>                        'board_id': request_data.get("board_id"),</pre></td></tr><tr><td>72</td><td><pre>                        'external_id': external_id,</pre></td></tr><tr><td>73</td><td><pre>                        'image_url': images_dict[0]['url'],</pre></td></tr><tr><td>74</td><td><pre>                        'image_width': images_dict[0]['width'],</pre></td></tr><tr><td>75</td><td><pre>                        'image_height': images_dict[0]['height'],</pre></td></tr><tr><td>76</td><td><pre>                        'image_202_url': images_dict[202]['url'],</pre></td></tr><tr><td>77</td><td><pre>                        'image_202_height': images_dict[202]['height'],</pre></td></tr><tr><td>78</td><td><pre>                        'image_212_url': images_dict[212]['url'],</pre></td></tr><tr><td>79</td><td><pre>                        'image_212_height': images_dict[212]['height']}</pre></td></tr><tr><td>80</td><td><pre></pre></td></tr><tr><td>81</td><td><pre>        pin_id = self.create_db_record(image_kwargs)</pre></td></tr><tr><td>82</td><td><pre></pre></td></tr><tr><td>83</td><td><pre>        data['image_id'] = pin_id</pre></td></tr><tr><td>84</td><td><pre>        data['external_id'] = external_id</pre></td></tr><tr><td>85</td><td><pre></pre></td></tr><tr><td>86</td><td><pre>        response = api_response(data=data,</pre></td></tr><tr><td>87</td><td><pre>                                status=status,</pre></td></tr><tr><td>88</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>89</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>90</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>91</td><td><pre></pre></td></tr><tr><td>92</td><td><pre>        return response</pre></td></tr><tr><td>93</td><td><pre></pre></td></tr><tr><td>94</td><td><pre>    def create_db_record(self, kwargs):</pre></td></tr><tr><td>95</td><td><pre>        """</pre></td></tr><tr><td>96</td><td><pre>        Creates image record in the database.</pre></td></tr><tr><td>97</td><td><pre>        """</pre></td></tr><tr><td>98</td><td><pre>        # Do not record empty fields</pre></td></tr><tr><td>99</td><td><pre>        kwargs = {key: value for (key, value) in kwargs.items()</pre></td></tr><tr><td>100</td><td><pre>                  if value is not None}</pre></td></tr><tr class="accepted"><td>101</td><td><pre>        return db.insert("pins", **kwargs)</pre></td></tr><tr><td>102</td><td><pre></pre></td></tr><tr><td>103</td><td><pre>    def save_file(self, file_obj, upload_dir=None):</pre></td></tr><tr><td>104</td><td><pre>        """</pre></td></tr><tr><td>105</td><td><pre>        Saves uploaded file to a given upload dir.</pre></td></tr><tr><td>106</td><td><pre>        """</pre></td></tr><tr><td>107</td><td><pre>        if not upload_dir:</pre></td></tr><tr><td>108</td><td><pre>            upload_dir = self.get_media_path()</pre></td></tr><tr><td>109</td><td><pre>        filename = file_obj.filename</pre></td></tr><tr><td>110</td><td><pre>        filename = self.get_file_name(filename, upload_dir)</pre></td></tr><tr><td>111</td><td><pre>        filepath = os.path.join(upload_dir, filename)</pre></td></tr><tr><td>112</td><td><pre>        upload_file = open(filepath, 'w')</pre></td></tr><tr><td>113</td><td><pre>        upload_file.write(file_obj.file.read())</pre></td></tr><tr><td>114</td><td><pre>        upload_file.close()</pre></td></tr><tr><td>115</td><td><pre>        return filepath</pre></td></tr><tr><td>116</td><td><pre></pre></td></tr><tr><td>117</td><td><pre>    def get_media_path(self):</pre></td></tr><tr><td>118</td><td><pre>        """</pre></td></tr><tr><td>119</td><td><pre>        Returns or creates media directory.</pre></td></tr><tr><td>120</td><td><pre>        """</pre></td></tr><tr><td>121</td><td><pre>        media_path = settings.MEDIA_PATH</pre></td></tr><tr><td>122</td><td><pre>        if not os.path.exists(media_path):</pre></td></tr><tr><td>123</td><td><pre>            os.makedirs(media_path)</pre></td></tr><tr><td>124</td><td><pre>        return media_path</pre></td></tr><tr><td>125</td><td><pre></pre></td></tr><tr><td>126</td><td><pre>    def get_file_name(self, filename, upload_dir):</pre></td></tr><tr><td>127</td><td><pre>        """</pre></td></tr><tr><td>128</td><td><pre>        Method responsible for avoiding duplicated filenames.</pre></td></tr><tr><td>129</td><td><pre>        """</pre></td></tr><tr><td>130</td><td><pre>        filepath = os.path.join(upload_dir, filename)</pre></td></tr><tr><td>131</td><td><pre>        exists = os.path.isfile(filepath)</pre></td></tr><tr><td>132</td><td><pre>        # Suggest uuid hex as a filename to avoid duplicates</pre></td></tr><tr><td>133</td><td><pre>        if exists:</pre></td></tr><tr><td>134</td><td><pre>            filename = "%s.%s" % (uuid.uuid4().hex[:10], filename)</pre></td></tr><tr><td>135</td><td><pre>        return filename</pre></td></tr><tr><td>136</td><td><pre></pre></td></tr><tr><td>137</td><td><pre></pre></td></tr><tr><td>138</td><td><pre>class QueryBoardInfo(BaseAPI):</pre></td></tr><tr><td>139</td><td><pre>    """</pre></td></tr><tr><td>140</td><td><pre>    Class responsible for getting all pins from a given board</pre></td></tr><tr><td>141</td><td><pre></pre></td></tr><tr><td>142</td><td><pre>    :link: /api/image/query-board</pre></td></tr><tr><td>143</td><td><pre>    """</pre></td></tr><tr><td>144</td><td><pre>    def POST(self):</pre></td></tr><tr><td>145</td><td><pre>        """ Returns pin id's of a given board</pre></td></tr><tr><td>146</td><td><pre></pre></td></tr><tr><td>147</td><td><pre>        :param str csid_from_client: Csid string from client</pre></td></tr><tr><td>148</td><td><pre>        :param str board_name: name of a queried board</pre></td></tr><tr><td>149</td><td><pre>        :param username: name of the user who is being queried</pre></td></tr><tr><td>150</td><td><pre></pre></td></tr><tr><td>151</td><td><pre>        :response: * img_ids - list of pins related to a given board</pre></td></tr><tr><td>152</td><td><pre>                   * board_info - relevant board information</pre></td></tr><tr><td>153</td><td><pre></pre></td></tr><tr><td>154</td><td><pre>        :to test: curl -d "username=olte" -d "board_name=Things to get" -d "csid_from_client=1" http://localhost:8080/api/image/query-board</pre></td></tr><tr><td>155</td><td><pre>        """</pre></td></tr><tr><td>156</td><td><pre>        request_data = web.input()</pre></td></tr><tr><td>157</td><td><pre>        save_api_request(request_data)</pre></td></tr><tr><td>158</td><td><pre></pre></td></tr><tr><td>159</td><td><pre>        username = request_data.get('username')</pre></td></tr><tr><td>160</td><td><pre>        board_name = request_data.get('board_name') + '%'</pre></td></tr><tr><td>161</td><td><pre></pre></td></tr><tr><td>162</td><td><pre>        csid_from_client = request_data.get("csid_from_client")</pre></td></tr><tr><td>163</td><td><pre>        csid_from_server = ""</pre></td></tr><tr><td>164</td><td><pre></pre></td></tr><tr><td>165</td><td><pre>        # Get user_id from username</pre></td></tr><tr class="accepted"><td>166</td><td><pre>        user = db.select('users', where='username=$username',</pre></td></tr><tr class="accepted"><td>167</td><td><pre>                            vars={'username': username}).list()</pre></td></tr><tr class=""><td>168</td><td><pre></pre></td></tr><tr class=""><td>169</td><td><pre>        if len(user) == 0:</pre></td></tr><tr class=""><td>170</td><td><pre>            return e_response("Given user does not exist")</pre></td></tr><tr class=""><td>171</td><td><pre>        user_id = user[0].get("id")</pre></td></tr><tr class=""><td>172</td><td><pre></pre></td></tr><tr><td>173</td><td><pre></pre></td></tr><tr><td>174</td><td><pre>        # Get board by user_id and board_name</pre></td></tr><tr class="accepted"><td>175</td><td><pre>        board = db.select('boards',</pre></td></tr><tr class="accepted"><td>176</td><td><pre>                          where='user_id=$uid and LOWER(name) like $bname',</pre></td></tr><tr class=""><td>177</td><td><pre>                          vars = {'uid': user_id,</pre></td></tr><tr><td>178</td><td><pre>                                  'bname': board_name.lower()}).list()</pre></td></tr><tr><td>179</td><td><pre>        if len(board) == 0:</pre></td></tr><tr><td>180</td><td><pre>            return e_response("Impossible to find board by name and user_id")</pre></td></tr><tr><td>181</td><td><pre>        # Get pins by board.id</pre></td></tr><tr class="accepted"><td>182</td><td><pre>        image_ids = db.select('pins', where='board_id=$bid',</pre></td></tr><tr class=""><td>183</td><td><pre>                              vars={'bid': board[0]['id']},</pre></td></tr><tr><td>184</td><td><pre>                              what='id')</pre></td></tr><tr><td>185</td><td><pre>        response = {}</pre></td></tr><tr><td>186</td><td><pre>        response['img_ids'] = [img["id"] for img in image_ids.list()]</pre></td></tr><tr><td>187</td><td><pre>        response['board'] = board</pre></td></tr><tr><td>188</td><td><pre>        return api_response(data=response, csid_from_server=csid_from_server,</pre></td></tr><tr><td>189</td><td><pre>                            csid_from_client=csid_from_client)</pre></td></tr><tr><td>190</td><td><pre></pre></td></tr><tr><td>191</td><td><pre></pre></td></tr><tr><td>192</td><td><pre>class ImageQuery(BaseAPI):</pre></td></tr><tr><td>193</td><td><pre>    """</pre></td></tr><tr><td>194</td><td><pre>    Image query for getting information about image</pre></td></tr><tr><td>195</td><td><pre></pre></td></tr><tr><td>196</td><td><pre>    method need some actual "logintoken" in security reason</pre></td></tr><tr><td>197</td><td><pre>    """</pre></td></tr><tr><td>198</td><td><pre>    def POST(self):</pre></td></tr><tr><td>199</td><td><pre>        """</pre></td></tr><tr><td>200</td><td><pre>        You can tested it using:</pre></td></tr><tr><td>201</td><td><pre>        curl --data "csid_from_client=1&amp;query_type=all&amp;logintoken=2mwvVHVFga&amp;</pre></td></tr><tr><td>202</td><td><pre>        query_params=840&amp;query_params=841&amp;&amp;query_params=842"</pre></td></tr><tr><td>203</td><td><pre>        http://localhost:8080/api/image/query</pre></td></tr><tr><td>204</td><td><pre></pre></td></tr><tr><td>205</td><td><pre>        "image_url" in response related with "link" in pins table.</pre></td></tr><tr><td>206</td><td><pre>        """</pre></td></tr><tr><td>207</td><td><pre>        request_data = web.input(query_params=[],)</pre></td></tr><tr><td>208</td><td><pre>        save_api_request(request_data)</pre></td></tr><tr><td>209</td><td><pre></pre></td></tr><tr><td>210</td><td><pre>        csid_from_client = request_data.get("csid_from_client")</pre></td></tr><tr><td>211</td><td><pre>        csid_from_server = ""</pre></td></tr><tr><td>212</td><td><pre></pre></td></tr><tr><td>213</td><td><pre>        query_type = request_data.get("query_type")</pre></td></tr><tr><td>214</td><td><pre>        query_params = map(str, request_data.get("query_params"))</pre></td></tr><tr><td>215</td><td><pre>        image_data_list = []</pre></td></tr><tr><td>216</td><td><pre>        if len(query_params) &gt; 0:</pre></td></tr><tr><td>217</td><td><pre>            image_data_list = self.query_image(query_params)</pre></td></tr><tr><td>218</td><td><pre></pre></td></tr><tr><td>219</td><td><pre>        data = {</pre></td></tr><tr><td>220</td><td><pre>            "image_data_list": image_data_list,</pre></td></tr><tr><td>221</td><td><pre>        }</pre></td></tr><tr><td>222</td><td><pre>        response = api_response(data,</pre></td></tr><tr><td>223</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>224</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>225</td><td><pre>        return response</pre></td></tr><tr><td>226</td><td><pre></pre></td></tr><tr><td>227</td><td><pre>    def query_image(self, query_params):</pre></td></tr><tr><td>228</td><td><pre>        image_data_list = []</pre></td></tr><tr><td>229</td><td><pre></pre></td></tr><tr class="accepted"><td>230</td><td><pre>        where = 'pins.id in (%s)' % (','.join(query_params))</pre></td></tr><tr class="accepted"><td>231</td><td><pre>        query = '''</pre></td></tr><tr class="accepted"><td>232</td><td><pre>            select</pre></td></tr><tr class="accepted"><td>233</td><td><pre>                tags.tags, pins.*, categories.id as category,</pre></td></tr><tr class="accepted"><td>234</td><td><pre>                categories.name as cat_name, pictures.resized_url as user_pic,</pre></td></tr><tr class="accepted"><td>235</td><td><pre>                users.username as user_username, users.name as user_name,</pre></td></tr><tr class="accepted"><td>236</td><td><pre>                users.id as user_id,</pre></td></tr><tr class="accepted"><td>237</td><td><pre>                count(distinct p1) as repin_count,</pre></td></tr><tr class="accepted"><td>238</td><td><pre>                count(distinct l1) as like_count</pre></td></tr><tr class="accepted"><td>239</td><td><pre>            from pins</pre></td></tr><tr class="accepted"><td>240</td><td><pre>                left join tags on tags.pin_id = pins.id</pre></td></tr><tr class="accepted"><td>241</td><td><pre>                left join pins p1 on p1.repin = pins.id</pre></td></tr><tr class="accepted"><td>242</td><td><pre>                left join likes l1 on l1.pin_id = pins.id</pre></td></tr><tr class="accepted"><td>243</td><td><pre>                left join users on users.id = pins.user_id</pre></td></tr><tr class="accepted"><td>244</td><td><pre>                left join pictures on users.pic_id = pictures.id</pre></td></tr><tr class="accepted"><td>245</td><td><pre>                left join follows on follows.follow = users.id</pre></td></tr><tr class="accepted"><td>246</td><td><pre>                left join pins_categories on pins.id=pins_categories.pin_id</pre></td></tr><tr class="accepted"><td>247</td><td><pre>                left join categories</pre></td></tr><tr class="accepted"><td>248</td><td><pre>                on pins_categories.category_id = categories.id</pre></td></tr><tr class="accepted"><td>249</td><td><pre>            where %s</pre></td></tr><tr class="accepted"><td>250</td><td><pre>            group by tags.tags, categories.id, pins.id, users.id, pictures.id</pre></td></tr><tr class="accepted"><td>251</td><td><pre>            order by timestamp desc''' % (where)</pre></td></tr><tr class="accepted"><td>252</td><td><pre></pre></td></tr><tr class="accepted"><td>253</td><td><pre>        images = db.query(query)</pre></td></tr><tr><td>254</td><td><pre></pre></td></tr><tr><td>255</td><td><pre>        image_properties = None</pre></td></tr><tr><td>256</td><td><pre>        for image in images:</pre></td></tr><tr><td>257</td><td><pre>            if not image['id']:</pre></td></tr><tr><td>258</td><td><pre>                continue</pre></td></tr><tr><td>259</td><td><pre></pre></td></tr><tr><td>260</td><td><pre>            if not image_properties or image_properties['id'] != image['id']:</pre></td></tr><tr><td>261</td><td><pre>                if image_properties:</pre></td></tr><tr><td>262</td><td><pre>                    image_properties['tags'] = list(image_properties['tags'])</pre></td></tr><tr><td>263</td><td><pre>                image_properties = {</pre></td></tr><tr><td>264</td><td><pre>                    "id": image.get('id'),</pre></td></tr><tr><td>265</td><td><pre>                    "name": image.get('name'),</pre></td></tr><tr><td>266</td><td><pre>                    "description": image.get('description'),</pre></td></tr><tr><td>267</td><td><pre>                    "link": image.get('link'),</pre></td></tr><tr><td>268</td><td><pre>                    "timestamp": image.get('timestamp'),</pre></td></tr><tr><td>269</td><td><pre>                    "product_url": image.get('product_url'),</pre></td></tr><tr><td>270</td><td><pre>                    "price": str(image.get('price')),</pre></td></tr><tr><td>271</td><td><pre>                    "price_range": image.get('price_range'),</pre></td></tr><tr><td>272</td><td><pre>                    "board_id": image.get('board_id'),</pre></td></tr><tr><td>273</td><td><pre>                    "external_id": image.get('external_id'),</pre></td></tr><tr><td>274</td><td><pre>                    "repin": image.get('repin'),</pre></td></tr><tr><td>275</td><td><pre>                    "views": image.get('views'),</pre></td></tr><tr><td>276</td><td><pre>                    "image_url": image.get('image_url'),</pre></td></tr><tr><td>277</td><td><pre>                    "image_width": image.get('image_width'),</pre></td></tr><tr><td>278</td><td><pre>                    "image_height": image.get('image_height'),</pre></td></tr><tr><td>279</td><td><pre>                    "image_202_url": image.get('image_202_url'),</pre></td></tr><tr><td>280</td><td><pre>                    "image_202_height": image.get('image_202_height'),</pre></td></tr><tr><td>281</td><td><pre>                    "image_212_url": image.get('image_212_url'),</pre></td></tr><tr><td>282</td><td><pre>                    "image_212_height": image.get('image_212_height'),</pre></td></tr><tr><td>283</td><td><pre>                    "like_count": image.get('like_count'),</pre></td></tr><tr><td>284</td><td><pre>                    "repin_count": image.get('repin_count'),</pre></td></tr><tr><td>285</td><td><pre>                    "category": image.get('category'),</pre></td></tr><tr><td>286</td><td><pre>                    "cat_name": image.get('cat_name'),</pre></td></tr><tr><td>287</td><td><pre>                    "user_id": image.get('user_id'),</pre></td></tr><tr><td>288</td><td><pre>                    "user_pic": image.get('user_pic'),</pre></td></tr><tr><td>289</td><td><pre>                    "user_username": image.get('user_username'),</pre></td></tr><tr><td>290</td><td><pre>                    "user_name": image.get('user_name')</pre></td></tr><tr><td>291</td><td><pre>                }</pre></td></tr><tr><td>292</td><td><pre></pre></td></tr><tr><td>293</td><td><pre>                if image.get('tags'):</pre></td></tr><tr><td>294</td><td><pre>                    image_properties['tags'] = \</pre></td></tr><tr><td>295</td><td><pre>                        set(image.get('tags').split())</pre></td></tr><tr><td>296</td><td><pre>                else:</pre></td></tr><tr><td>297</td><td><pre>                    image_properties['tags'] = set()</pre></td></tr><tr><td>298</td><td><pre></pre></td></tr><tr><td>299</td><td><pre>                image_data_list.append(image_properties)</pre></td></tr><tr><td>300</td><td><pre>            elif image.get('tags'):</pre></td></tr><tr><td>301</td><td><pre>                image_properties['tags'].update(</pre></td></tr><tr><td>302</td><td><pre>                    image.get('tags').split())</pre></td></tr><tr><td>303</td><td><pre>        if image_properties:</pre></td></tr><tr><td>304</td><td><pre>            image_properties['tags'] = list(image_properties['tags'])</pre></td></tr><tr><td>305</td><td><pre>        return image_data_list</pre></td></tr><tr><td>306</td><td><pre></pre></td></tr><tr><td>307</td><td><pre></pre></td></tr><tr><td>308</td><td><pre>class ManageProperties(BaseAPI):</pre></td></tr><tr><td>309</td><td><pre>    """</pre></td></tr><tr><td>310</td><td><pre>    API method for changing pin properties</pre></td></tr><tr><td>311</td><td><pre>    """</pre></td></tr><tr><td>312</td><td><pre>    def POST(self):</pre></td></tr><tr><td>313</td><td><pre>        request_data = web.input(</pre></td></tr><tr><td>314</td><td><pre>            hash_tag_add_list=[],</pre></td></tr><tr><td>315</td><td><pre>            hash_tag_remove_list=[],</pre></td></tr><tr><td>316</td><td><pre>        )</pre></td></tr><tr><td>317</td><td><pre></pre></td></tr><tr><td>318</td><td><pre>        update_data = {}</pre></td></tr><tr><td>319</td><td><pre>        data = {}</pre></td></tr><tr><td>320</td><td><pre>        status = 200</pre></td></tr><tr><td>321</td><td><pre>        csid_from_server = None</pre></td></tr><tr><td>322</td><td><pre>        error_code = ""</pre></td></tr><tr><td>323</td><td><pre></pre></td></tr><tr><td>324</td><td><pre>        # Get data from request</pre></td></tr><tr><td>325</td><td><pre>        image_id = request_data.get("image_id")</pre></td></tr><tr><td>326</td><td><pre>        image_title = request_data.get("image_title")</pre></td></tr><tr><td>327</td><td><pre>        image_desc = request_data.get("image_desc")</pre></td></tr><tr><td>328</td><td><pre>        product_url = request_data.get("product_url")</pre></td></tr><tr><td>329</td><td><pre>        link = request_data.get("link")</pre></td></tr><tr><td>330</td><td><pre>        price_range = request_data.get("price_range")</pre></td></tr><tr><td>331</td><td><pre>        board_id = request_data.get("board_id")</pre></td></tr><tr><td>332</td><td><pre>        hash_tag_add_list = map(str,</pre></td></tr><tr><td>333</td><td><pre>                                request_data.get("hash_tag_add_list"))</pre></td></tr><tr><td>334</td><td><pre>        hash_tag_remove_list = map(str,</pre></td></tr><tr><td>335</td><td><pre>                                   request_data.get("hash_tag_remove_list"))</pre></td></tr><tr><td>336</td><td><pre></pre></td></tr><tr><td>337</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>338</td><td><pre>        logintoken = request_data.get('logintoken')</pre></td></tr><tr><td>339</td><td><pre>        user_status, user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>340</td><td><pre></pre></td></tr><tr><td>341</td><td><pre>        if not image_id:</pre></td></tr><tr><td>342</td><td><pre>            status = 400</pre></td></tr><tr><td>343</td><td><pre>            error_code = "Invalid input data"</pre></td></tr><tr><td>344</td><td><pre></pre></td></tr><tr><td>345</td><td><pre>        data['image_id'] = image_id</pre></td></tr><tr><td>346</td><td><pre>        if image_title:</pre></td></tr><tr><td>347</td><td><pre>            update_data['name'] = image_title</pre></td></tr><tr><td>348</td><td><pre>            data['image_title'] = image_title</pre></td></tr><tr><td>349</td><td><pre>        if image_desc:</pre></td></tr><tr><td>350</td><td><pre>            update_data['description'] = image_desc</pre></td></tr><tr><td>351</td><td><pre>            data['image_desc'] = image_desc</pre></td></tr><tr><td>352</td><td><pre>        if product_url:</pre></td></tr><tr><td>353</td><td><pre>            update_data['product_url'] = product_url</pre></td></tr><tr><td>354</td><td><pre>            data['product_url'] = product_url</pre></td></tr><tr><td>355</td><td><pre>        if link:</pre></td></tr><tr><td>356</td><td><pre>            update_data['link'] = link</pre></td></tr><tr><td>357</td><td><pre>            data['link'] = link</pre></td></tr><tr><td>358</td><td><pre>        if price_range:</pre></td></tr><tr><td>359</td><td><pre>            update_data['price_range'] = price_range</pre></td></tr><tr><td>360</td><td><pre>            data['price_range'] = price_range</pre></td></tr><tr><td>361</td><td><pre>        if board_id:</pre></td></tr><tr><td>362</td><td><pre>            update_data['board_id'] = board_id</pre></td></tr><tr><td>363</td><td><pre>            data['board_id'] = board_id</pre></td></tr><tr><td>364</td><td><pre></pre></td></tr><tr><td>365</td><td><pre>        # User id contains error code</pre></td></tr><tr><td>366</td><td><pre>        if not user_status:</pre></td></tr><tr><td>367</td><td><pre>            return user</pre></td></tr><tr><td>368</td><td><pre></pre></td></tr><tr><td>369</td><td><pre>        csid_from_server = user['seriesid']</pre></td></tr><tr><td>370</td><td><pre></pre></td></tr><tr class="accepted"><td>371</td><td><pre>        tags = db.select('tags', where='pin_id = %s' % (image_id)).list()</pre></td></tr><tr class="accepted"><td>372</td><td><pre>        if len(tags) &gt; 0:</pre></td></tr><tr class="accepted"><td>373</td><td><pre>            tags = tags[0]['tags'].split()</pre></td></tr><tr class="accepted"><td>374</td><td><pre>            tags = set(tags) - set(hash_tag_remove_list)</pre></td></tr><tr class="accepted"><td>375</td><td><pre>            tags = tags | set(hash_tag_add_list)</pre></td></tr><tr class="accepted"><td>376</td><td><pre>            tags = ' '.join(tags)</pre></td></tr><tr class="accepted"><td>377</td><td><pre></pre></td></tr><tr class="accepted"><td>378</td><td><pre>            db.update('tags', where='pin_id = %s' % (image_id),</pre></td></tr><tr class="accepted"><td>379</td><td><pre>                      tags=tags)</pre></td></tr><tr class="accepted"><td>380</td><td><pre>        else:</pre></td></tr><tr class="accepted"><td>381</td><td><pre>            tags = ' '.join(hash_tag_add_list)</pre></td></tr><tr class="accepted"><td>382</td><td><pre>            db.insert('tags', pin_id=image_id, tags=tags)</pre></td></tr><tr class="accepted"><td>383</td><td><pre></pre></td></tr><tr class=""><td>384</td><td><pre>        if status == 200 and len(update_data) &gt; 0:</pre></td></tr><tr class="accepted"><td>385</td><td><pre>            db.update('pins', where='id = %s' % (image_id),</pre></td></tr><tr class="accepted"><td>386</td><td><pre>                      **update_data)</pre></td></tr><tr><td>387</td><td><pre></pre></td></tr><tr class="accepted"><td>388</td><td><pre>            pins = db.select('pins', where='id = %s' % (image_id)).list()</pre></td></tr><tr><td>389</td><td><pre>            if len(pins) &gt; 0:</pre></td></tr><tr><td>390</td><td><pre>                data['external_id'] = pins[0]['external_id']</pre></td></tr><tr><td>391</td><td><pre></pre></td></tr><tr><td>392</td><td><pre>        response = api_response(data=data,</pre></td></tr><tr><td>393</td><td><pre>                                status=status,</pre></td></tr><tr><td>394</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>395</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>396</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>397</td><td><pre>        return response</pre></td></tr><tr><td>398</td><td><pre></pre></td></tr><tr><td>399</td><td><pre></pre></td></tr><tr><td>400</td><td><pre>class Categorize(BaseAPI):</pre></td></tr><tr><td>401</td><td><pre>    """</pre></td></tr><tr><td>402</td><td><pre>    API method for changing category of pin</pre></td></tr><tr><td>403</td><td><pre>    """</pre></td></tr><tr><td>404</td><td><pre>    def POST(self):</pre></td></tr><tr><td>405</td><td><pre>        request_data = web.input(</pre></td></tr><tr><td>406</td><td><pre>            category_id_list=[],</pre></td></tr><tr><td>407</td><td><pre>        )</pre></td></tr><tr><td>408</td><td><pre></pre></td></tr><tr><td>409</td><td><pre>        update_data = {}</pre></td></tr><tr><td>410</td><td><pre>        data = {}</pre></td></tr><tr><td>411</td><td><pre>        status = 200</pre></td></tr><tr><td>412</td><td><pre>        csid_from_server = None</pre></td></tr><tr><td>413</td><td><pre>        error_code = ""</pre></td></tr><tr><td>414</td><td><pre></pre></td></tr><tr><td>415</td><td><pre>        # Get data from request</pre></td></tr><tr><td>416</td><td><pre>        image_id = request_data.get("image_id")</pre></td></tr><tr><td>417</td><td><pre>        category_id_list = map(int,</pre></td></tr><tr><td>418</td><td><pre>                               request_data.get("category_id_list"))</pre></td></tr><tr><td>419</td><td><pre></pre></td></tr><tr><td>420</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>421</td><td><pre>        logintoken = request_data.get('logintoken')</pre></td></tr><tr><td>422</td><td><pre>        user_status, user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>423</td><td><pre></pre></td></tr><tr><td>424</td><td><pre>        if not image_id:</pre></td></tr><tr><td>425</td><td><pre>            status = 400</pre></td></tr><tr><td>426</td><td><pre>            error_code = "Invalid input data"</pre></td></tr><tr><td>427</td><td><pre></pre></td></tr><tr><td>428</td><td><pre>        data['image_id'] = image_id</pre></td></tr><tr><td>429</td><td><pre></pre></td></tr><tr><td>430</td><td><pre>        # User id contains error code</pre></td></tr><tr><td>431</td><td><pre>        if not user_status:</pre></td></tr><tr><td>432</td><td><pre>            return user</pre></td></tr><tr><td>433</td><td><pre></pre></td></tr><tr><td>434</td><td><pre>        csid_from_server = user['seriesid']</pre></td></tr><tr><td>435</td><td><pre></pre></td></tr><tr><td>436</td><td><pre>        if status == 200:</pre></td></tr><tr class="accepted"><td>437</td><td><pre>            db.delete('pins_categories', where='pin_id = %s' % (image_id))</pre></td></tr><tr><td>438</td><td><pre>            for category_id in category_id_list:</pre></td></tr><tr class="accepted"><td>439</td><td><pre>                db.insert('pins_categories',</pre></td></tr><tr class="accepted"><td>440</td><td><pre>                          pin_id=image_id,</pre></td></tr><tr class="accepted"><td>441</td><td><pre>                          category_id=category_id)</pre></td></tr><tr><td>442</td><td><pre></pre></td></tr><tr><td>443</td><td><pre>        response = api_response(data=data,</pre></td></tr><tr><td>444</td><td><pre>                                status=status,</pre></td></tr><tr><td>445</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>446</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>447</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>448</td><td><pre>        return response</pre></td></tr><tr><td>449</td><td><pre></pre></td></tr><tr><td>450</td><td><pre></pre></td></tr><tr><td>451</td><td><pre>class QueryCategory(BaseAPI):</pre></td></tr><tr><td>452</td><td><pre>    """</pre></td></tr><tr><td>453</td><td><pre>    API for receiving pins by category</pre></td></tr><tr><td>454</td><td><pre>    """</pre></td></tr><tr><td>455</td><td><pre>    def POST(self):</pre></td></tr><tr><td>456</td><td><pre>        request_data = web.input(</pre></td></tr><tr><td>457</td><td><pre>            category_id_list=[],</pre></td></tr><tr><td>458</td><td><pre>        )</pre></td></tr><tr><td>459</td><td><pre></pre></td></tr><tr><td>460</td><td><pre>        data = {}</pre></td></tr><tr><td>461</td><td><pre>        status = 200</pre></td></tr><tr><td>462</td><td><pre>        csid_from_server = None</pre></td></tr><tr><td>463</td><td><pre>        error_code = ""</pre></td></tr><tr><td>464</td><td><pre></pre></td></tr><tr><td>465</td><td><pre>        # Get data from request</pre></td></tr><tr><td>466</td><td><pre>        query_type = request_data.get("query_type")</pre></td></tr><tr><td>467</td><td><pre>        category_id_list = map(str,</pre></td></tr><tr><td>468</td><td><pre>                               request_data.get("category_id_list"))</pre></td></tr><tr><td>469</td><td><pre>        page = request_data.get("page")</pre></td></tr><tr><td>470</td><td><pre>        items_per_page = request_data.get("items_per_page")</pre></td></tr><tr><td>471</td><td><pre>        not_private = request_data.get("not_private", False)</pre></td></tr><tr><td>472</td><td><pre></pre></td></tr><tr><td>473</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>474</td><td><pre>        csid_from_server = ""</pre></td></tr><tr><td>475</td><td><pre></pre></td></tr><tr><td>476</td><td><pre>        if query_type == "all" or not query_type:</pre></td></tr><tr><td>477</td><td><pre>            data = self.get_all(category_id_list, not_private)</pre></td></tr><tr><td>478</td><td><pre></pre></td></tr><tr><td>479</td><td><pre>        elif query_type == "new":</pre></td></tr><tr><td>480</td><td><pre>            data = self.get_new(category_id_list, not_private)</pre></td></tr><tr><td>481</td><td><pre></pre></td></tr><tr><td>482</td><td><pre>        elif query_type == "range":</pre></td></tr><tr><td>483</td><td><pre>            data = self.get_range(category_id_list,</pre></td></tr><tr><td>484</td><td><pre>                                  page,</pre></td></tr><tr><td>485</td><td><pre>                                  items_per_page,</pre></td></tr><tr><td>486</td><td><pre>                                  not_private)</pre></td></tr><tr><td>487</td><td><pre></pre></td></tr><tr><td>488</td><td><pre>        response = api_response(data=data,</pre></td></tr><tr><td>489</td><td><pre>                                status=status,</pre></td></tr><tr><td>490</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>491</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>492</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>493</td><td><pre>        return response</pre></td></tr><tr><td>494</td><td><pre></pre></td></tr><tr><td>495</td><td><pre>    def get_all(self, category_id_list, not_private):</pre></td></tr><tr><td>496</td><td><pre>        data = {}</pre></td></tr><tr><td>497</td><td><pre>        image_id_list = []</pre></td></tr><tr><td>498</td><td><pre></pre></td></tr><tr class="accepted"><td>499</td><td><pre>        where = "random() &lt; 0.1"</pre></td></tr><tr class="accepted"><td>500</td><td><pre>        if len(category_id_list) &gt; 0:</pre></td></tr><tr class="accepted"><td>501</td><td><pre>            where = "pins_categories.category_id in (%s)" % \</pre></td></tr><tr class="accepted"><td>502</td><td><pre>                ','.join(category_id_list)</pre></td></tr><tr class="accepted"><td>503</td><td><pre></pre></td></tr><tr class="accepted"><td>504</td><td><pre>        if not_private:</pre></td></tr><tr class="accepted"><td>505</td><td><pre>            where = where + " AND not users.private"</pre></td></tr><tr class="accepted"><td>506</td><td><pre></pre></td></tr><tr class="accepted"><td>507</td><td><pre>        pins = db.query("SELECT * FROM pins \</pre></td></tr><tr class="accepted"><td>508</td><td><pre>                        JOIN pins_categories \</pre></td></tr><tr class="accepted"><td>509</td><td><pre>                        ON pins_categories.pin_id = pins.id \</pre></td></tr><tr class="accepted"><td>510</td><td><pre>                        LEFT JOIN users ON pins.user_id = users.id \</pre></td></tr><tr class="accepted"><td>511</td><td><pre>                        WHERE %s \</pre></td></tr><tr class="accepted"><td>512</td><td><pre>                        ORDER BY pins.timestamp desc" % (where))\</pre></td></tr><tr><td>513</td><td><pre>            .list()</pre></td></tr><tr><td>514</td><td><pre></pre></td></tr><tr><td>515</td><td><pre>        for pin in pins:</pre></td></tr><tr><td>516</td><td><pre>            if pin['pin_id'] not in image_id_list:</pre></td></tr><tr><td>517</td><td><pre>                image_id_list.append(pin['pin_id'])</pre></td></tr><tr><td>518</td><td><pre></pre></td></tr><tr><td>519</td><td><pre>        data['image_id_list'] = image_id_list</pre></td></tr><tr><td>520</td><td><pre></pre></td></tr><tr><td>521</td><td><pre>        return data</pre></td></tr><tr><td>522</td><td><pre></pre></td></tr><tr><td>523</td><td><pre>    def get_new(self, category_id_list, not_private):</pre></td></tr><tr><td>524</td><td><pre>        data = {}</pre></td></tr><tr><td>525</td><td><pre>        image_id_list = []</pre></td></tr><tr><td>526</td><td><pre>        timestamp_with_delta = int(</pre></td></tr><tr><td>527</td><td><pre>            (</pre></td></tr><tr><td>528</td><td><pre>                datetime.datetime.utcnow() -</pre></td></tr><tr><td>529</td><td><pre>                datetime.timedelta(days=settings.PIN_NEW_DAYS)</pre></td></tr><tr><td>530</td><td><pre>            )</pre></td></tr><tr><td>531</td><td><pre>            .strftime("%s")</pre></td></tr><tr><td>532</td><td><pre>        )</pre></td></tr><tr><td>533</td><td><pre></pre></td></tr><tr class="accepted"><td>534</td><td><pre>        where = "random() &lt; 0.1"</pre></td></tr><tr class="accepted"><td>535</td><td><pre>        if len(category_id_list) &gt; 0:</pre></td></tr><tr class="accepted"><td>536</td><td><pre>            where = "pins_categories.category_id in (%s)" % \</pre></td></tr><tr class="accepted"><td>537</td><td><pre>                ','.join(category_id_list)</pre></td></tr><tr class="accepted"><td>538</td><td><pre></pre></td></tr><tr class="accepted"><td>539</td><td><pre>        if not_private:</pre></td></tr><tr class="accepted"><td>540</td><td><pre>            where = where + " AND not users.private"</pre></td></tr><tr class="accepted"><td>541</td><td><pre></pre></td></tr><tr class="accepted"><td>542</td><td><pre>        pins = db.query("SELECT * FROM pins \</pre></td></tr><tr class="accepted"><td>543</td><td><pre>                        JOIN pins_categories \</pre></td></tr><tr class="accepted"><td>544</td><td><pre>                        ON pins_categories.pin_id = pins.id \</pre></td></tr><tr class="accepted"><td>545</td><td><pre>                        LEFT JOIN users ON pins.user_id = users.id \</pre></td></tr><tr class="accepted"><td>546</td><td><pre>                        WHERE %s and \</pre></td></tr><tr class="accepted"><td>547</td><td><pre>                        pins.timestamp &gt;= %d \</pre></td></tr><tr class="accepted"><td>548</td><td><pre>                        ORDER BY pins.timestamp desc" %</pre></td></tr><tr class="accepted"><td>549</td><td><pre>                        (where, timestamp_with_delta))\</pre></td></tr><tr><td>550</td><td><pre>            .list()</pre></td></tr><tr><td>551</td><td><pre></pre></td></tr><tr><td>552</td><td><pre>        for pin in pins:</pre></td></tr><tr><td>553</td><td><pre>            if pin['pin_id'] not in image_id_list:</pre></td></tr><tr><td>554</td><td><pre>                image_id_list.append(pin['pin_id'])</pre></td></tr><tr><td>555</td><td><pre></pre></td></tr><tr><td>556</td><td><pre>        data['image_id_list'] = image_id_list</pre></td></tr><tr><td>557</td><td><pre></pre></td></tr><tr><td>558</td><td><pre>        return data</pre></td></tr><tr><td>559</td><td><pre></pre></td></tr><tr><td>560</td><td><pre>    def get_range(self, category_id_list, page, items_per_page, not_private):</pre></td></tr><tr><td>561</td><td><pre>        data = {}</pre></td></tr><tr><td>562</td><td><pre>        image_id_list = []</pre></td></tr><tr><td>563</td><td><pre></pre></td></tr><tr><td>564</td><td><pre>        if not page:</pre></td></tr><tr><td>565</td><td><pre>            page = 1</pre></td></tr><tr><td>566</td><td><pre>        else:</pre></td></tr><tr><td>567</td><td><pre>            page = int(page)</pre></td></tr><tr><td>568</td><td><pre>            if page &lt; 1:</pre></td></tr><tr><td>569</td><td><pre>                page = 1</pre></td></tr><tr><td>570</td><td><pre>        if not items_per_page:</pre></td></tr><tr><td>571</td><td><pre>            items_per_page = 10</pre></td></tr><tr><td>572</td><td><pre>            if items_per_page &lt; 1:</pre></td></tr><tr><td>573</td><td><pre>                items_per_page = 1</pre></td></tr><tr><td>574</td><td><pre>        else:</pre></td></tr><tr><td>575</td><td><pre>            items_per_page = int(items_per_page)</pre></td></tr><tr><td>576</td><td><pre></pre></td></tr><tr class="accepted"><td>577</td><td><pre>        where = "random() &lt; 0.1"</pre></td></tr><tr class="accepted"><td>578</td><td><pre>        if len(category_id_list) &gt; 0:</pre></td></tr><tr class="accepted"><td>579</td><td><pre>            where = "pins_categories.category_id in (%s)" % \</pre></td></tr><tr class="accepted"><td>580</td><td><pre>                ','.join(category_id_list)</pre></td></tr><tr class="accepted"><td>581</td><td><pre></pre></td></tr><tr class="accepted"><td>582</td><td><pre>        if not_private:</pre></td></tr><tr class="accepted"><td>583</td><td><pre>            where = where + " AND not users.private"</pre></td></tr><tr class="accepted"><td>584</td><td><pre></pre></td></tr><tr class="accepted"><td>585</td><td><pre>        pins = db.query("SELECT * FROM pins \</pre></td></tr><tr class="accepted"><td>586</td><td><pre>                        JOIN pins_categories \</pre></td></tr><tr class="accepted"><td>587</td><td><pre>                        ON pins_categories.pin_id = pins.id \</pre></td></tr><tr class="accepted"><td>588</td><td><pre>                        LEFT JOIN users ON pins.user_id = users.id \</pre></td></tr><tr class="accepted"><td>589</td><td><pre>                        WHERE %s \</pre></td></tr><tr class="accepted"><td>590</td><td><pre>                        ORDER BY random()" % (where))\</pre></td></tr><tr class=""><td>591</td><td><pre>            .list()</pre></td></tr><tr><td>592</td><td><pre></pre></td></tr><tr><td>593</td><td><pre>        for pin in pins:</pre></td></tr><tr><td>594</td><td><pre>            if pin['pin_id'] not in image_id_list:</pre></td></tr><tr><td>595</td><td><pre>                image_id_list.append(pin['pin_id'])</pre></td></tr><tr><td>596</td><td><pre></pre></td></tr><tr><td>597</td><td><pre>        data['pages_count'] = math.ceil(float(len(image_id_list)) /</pre></td></tr><tr><td>598</td><td><pre>                                        float(items_per_page))</pre></td></tr><tr><td>599</td><td><pre>        data['pages_count'] = int(data['pages_count'])</pre></td></tr><tr><td>600</td><td><pre>        data['page'] = page</pre></td></tr><tr><td>601</td><td><pre>        data['items_per_page'] = items_per_page</pre></td></tr><tr><td>602</td><td><pre></pre></td></tr><tr><td>603</td><td><pre>        start = (page-1) * items_per_page</pre></td></tr><tr><td>604</td><td><pre>        end = start + items_per_page</pre></td></tr><tr><td>605</td><td><pre>        data['image_id_list'] = image_id_list[start:end]</pre></td></tr><tr><td>606</td><td><pre></pre></td></tr><tr><td>607</td><td><pre>        return data</pre></td></tr><tr><td>608</td><td><pre></pre></td></tr><tr><td>609</td><td><pre></pre></td></tr><tr><td>610</td><td><pre>class QueryHashtags(BaseAPI):</pre></td></tr><tr><td>611</td><td><pre>    """</pre></td></tr><tr><td>612</td><td><pre>    API method for get hashtags of pin</pre></td></tr><tr><td>613</td><td><pre>    """</pre></td></tr><tr><td>614</td><td><pre>    def POST(self):</pre></td></tr><tr><td>615</td><td><pre>        request_data = web.input()</pre></td></tr><tr><td>616</td><td><pre></pre></td></tr><tr><td>617</td><td><pre>        update_data = {}</pre></td></tr><tr><td>618</td><td><pre>        data = {}</pre></td></tr><tr><td>619</td><td><pre>        status = 200</pre></td></tr><tr><td>620</td><td><pre>        csid_from_server = None</pre></td></tr><tr><td>621</td><td><pre>        error_code = ""</pre></td></tr><tr><td>622</td><td><pre></pre></td></tr><tr><td>623</td><td><pre>        # Get data from request</pre></td></tr><tr><td>624</td><td><pre>        image_id = request_data.get("image_id")</pre></td></tr><tr><td>625</td><td><pre></pre></td></tr><tr><td>626</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>627</td><td><pre>        logintoken = request_data.get('logintoken')</pre></td></tr><tr><td>628</td><td><pre>        user_status, user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>629</td><td><pre></pre></td></tr><tr><td>630</td><td><pre>        if not image_id:</pre></td></tr><tr><td>631</td><td><pre>            status = 400</pre></td></tr><tr><td>632</td><td><pre>            error_code = "Invalid input data"</pre></td></tr><tr><td>633</td><td><pre></pre></td></tr><tr><td>634</td><td><pre>        data['image_id'] = image_id</pre></td></tr><tr><td>635</td><td><pre></pre></td></tr><tr><td>636</td><td><pre>        # User id contains error code</pre></td></tr><tr><td>637</td><td><pre>        if not user_status:</pre></td></tr><tr><td>638</td><td><pre>            return user</pre></td></tr><tr><td>639</td><td><pre></pre></td></tr><tr><td>640</td><td><pre>        csid_from_server = user['seriesid']</pre></td></tr><tr><td>641</td><td><pre></pre></td></tr><tr><td>642</td><td><pre>        if status == 200:</pre></td></tr><tr class="accepted"><td>643</td><td><pre>            tags = db.select('tags', where='pin_id = %s' % (image_id)).list()</pre></td></tr><tr><td>644</td><td><pre>            if len(tags) &gt; 0:</pre></td></tr><tr><td>645</td><td><pre>                tags = tags[0]['tags'].split()</pre></td></tr><tr><td>646</td><td><pre>            else:</pre></td></tr><tr><td>647</td><td><pre>                tags = []</pre></td></tr><tr><td>648</td><td><pre></pre></td></tr><tr><td>649</td><td><pre>            data['hashtag_list'] = tags</pre></td></tr><tr><td>650</td><td><pre></pre></td></tr><tr><td>651</td><td><pre>        response = api_response(data=data,</pre></td></tr><tr><td>652</td><td><pre>                                status=status,</pre></td></tr><tr><td>653</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>654</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>655</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>656</td><td><pre>        return response</pre></td></tr><tr><td>657</td><td><pre></pre></td></tr><tr><td>658</td><td><pre></pre></td></tr><tr><td>659</td><td><pre>class QueryGetByHashtags(BaseAPI):</pre></td></tr><tr><td>660</td><td><pre>    """</pre></td></tr><tr><td>661</td><td><pre>    API for receiving pins by hashtag</pre></td></tr><tr><td>662</td><td><pre>    """</pre></td></tr><tr><td>663</td><td><pre>    def POST(self):</pre></td></tr><tr><td>664</td><td><pre>        request_data = web.input(</pre></td></tr><tr><td>665</td><td><pre>        )</pre></td></tr><tr><td>666</td><td><pre></pre></td></tr><tr><td>667</td><td><pre>        data = {}</pre></td></tr><tr><td>668</td><td><pre>        status = 200</pre></td></tr><tr><td>669</td><td><pre>        csid_from_server = None</pre></td></tr><tr><td>670</td><td><pre>        error_code = ""</pre></td></tr><tr><td>671</td><td><pre></pre></td></tr><tr><td>672</td><td><pre>        # Get data from request</pre></td></tr><tr><td>673</td><td><pre>        hashtag = request_data.get("hashtag", None)</pre></td></tr><tr><td>674</td><td><pre>        page = request_data.get("page")</pre></td></tr><tr><td>675</td><td><pre>        items_per_page = request_data.get("items_per_page", 10)</pre></td></tr><tr><td>676</td><td><pre>        not_private = request_data.get("not_private", False)</pre></td></tr><tr><td>677</td><td><pre></pre></td></tr><tr><td>678</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>679</td><td><pre>        csid_from_server = ""</pre></td></tr><tr><td>680</td><td><pre></pre></td></tr><tr><td>681</td><td><pre>        if not hashtag:</pre></td></tr><tr><td>682</td><td><pre>            status = 400</pre></td></tr><tr><td>683</td><td><pre>            error_code = "Invalid input data"</pre></td></tr><tr><td>684</td><td><pre>        else:</pre></td></tr><tr><td>685</td><td><pre>            data = self.get_range(hashtag,</pre></td></tr><tr><td>686</td><td><pre>                                  page,</pre></td></tr><tr><td>687</td><td><pre>                                  items_per_page,</pre></td></tr><tr><td>688</td><td><pre>                                  not_private)</pre></td></tr><tr><td>689</td><td><pre></pre></td></tr><tr><td>690</td><td><pre>        response = api_response(data=data,</pre></td></tr><tr><td>691</td><td><pre>                                status=status,</pre></td></tr><tr><td>692</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>693</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>694</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>695</td><td><pre>        return response</pre></td></tr><tr><td>696</td><td><pre></pre></td></tr><tr><td>697</td><td><pre>    def get_range(self, hashtag, page, items_per_page, not_private):</pre></td></tr><tr><td>698</td><td><pre>        data = {}</pre></td></tr><tr><td>699</td><td><pre>        image_id_list = []</pre></td></tr><tr><td>700</td><td><pre></pre></td></tr><tr><td>701</td><td><pre>        if page:</pre></td></tr><tr><td>702</td><td><pre>            page = int(page)</pre></td></tr><tr><td>703</td><td><pre>            if page &lt; 1:</pre></td></tr><tr><td>704</td><td><pre>                page = 1</pre></td></tr><tr><td>705</td><td><pre></pre></td></tr><tr><td>706</td><td><pre>        if not items_per_page:</pre></td></tr><tr><td>707</td><td><pre>            items_per_page = 10</pre></td></tr><tr><td>708</td><td><pre>            if items_per_page &lt; 1:</pre></td></tr><tr><td>709</td><td><pre>                items_per_page = 1</pre></td></tr><tr><td>710</td><td><pre>        else:</pre></td></tr><tr><td>711</td><td><pre>            items_per_page = int(items_per_page)</pre></td></tr><tr><td>712</td><td><pre></pre></td></tr><tr class="accepted"><td>713</td><td><pre>        where = "random() &lt; 0.1"</pre></td></tr><tr class="accepted"><td>714</td><td><pre>        if hashtag:</pre></td></tr><tr class="accepted"><td>715</td><td><pre>            where = "tags.tags LiKE '%%%s%%'" % \</pre></td></tr><tr class="accepted"><td>716</td><td><pre>                hashtag</pre></td></tr><tr class="accepted"><td>717</td><td><pre></pre></td></tr><tr class="accepted"><td>718</td><td><pre>        if not_private:</pre></td></tr><tr class="accepted"><td>719</td><td><pre>            where = where + " AND not users.private"</pre></td></tr><tr class="accepted"><td>720</td><td><pre></pre></td></tr><tr class="accepted"><td>721</td><td><pre>        pins = db.query("SELECT * FROM pins \</pre></td></tr><tr class="accepted"><td>722</td><td><pre>                        JOIN tags \</pre></td></tr><tr class="accepted"><td>723</td><td><pre>                        ON tags.pin_id = pins.id \</pre></td></tr><tr class="accepted"><td>724</td><td><pre>                        LEFT JOIN users ON pins.user_id = users.id \</pre></td></tr><tr class="accepted"><td>725</td><td><pre>                        WHERE %s \</pre></td></tr><tr class="accepted"><td>726</td><td><pre>                        ORDER BY pins.timestamp desc" % (where))\</pre></td></tr><tr><td>727</td><td><pre>            .list()</pre></td></tr><tr><td>728</td><td><pre></pre></td></tr><tr><td>729</td><td><pre>        for pin in pins:</pre></td></tr><tr><td>730</td><td><pre>            if hashtag and hashtag not in pin['tags'].split():</pre></td></tr><tr><td>731</td><td><pre>                continue</pre></td></tr><tr><td>732</td><td><pre></pre></td></tr><tr><td>733</td><td><pre>            if pin['pin_id'] not in image_id_list:</pre></td></tr><tr><td>734</td><td><pre>                image_id_list.append(pin['pin_id'])</pre></td></tr><tr><td>735</td><td><pre></pre></td></tr><tr><td>736</td><td><pre>        if page:</pre></td></tr><tr><td>737</td><td><pre>            data['pages_count'] = math.ceil(float(len(image_id_list)) /</pre></td></tr><tr><td>738</td><td><pre>                                            float(items_per_page))</pre></td></tr><tr><td>739</td><td><pre>            data['pages_count'] = int(data['pages_count'])</pre></td></tr><tr><td>740</td><td><pre>            data['page'] = page</pre></td></tr><tr><td>741</td><td><pre>            data['items_per_page'] = items_per_page</pre></td></tr><tr><td>742</td><td><pre></pre></td></tr><tr><td>743</td><td><pre>            start = (page-1) * items_per_page</pre></td></tr><tr><td>744</td><td><pre>            end = start + items_per_page</pre></td></tr><tr><td>745</td><td><pre>            data['image_id_list'] = image_id_list[start:end]</pre></td></tr><tr><td>746</td><td><pre>        else:</pre></td></tr><tr><td>747</td><td><pre>            data['image_id_list'] = image_id_list</pre></td></tr><tr><td>748</td><td><pre></pre></td></tr><tr><td>749</td><td><pre>        return data</pre></td></tr><tr><td>750</td><td><pre></pre></td></tr><tr><td>751</td><td><pre></pre></td></tr><tr><td>752</td><td><pre>def _generate_external_id():</pre></td></tr><tr><td>753</td><td><pre>    id = _new_external_id()</pre></td></tr><tr><td>754</td><td><pre>    while _already_exists(id):</pre></td></tr><tr><td>755</td><td><pre>        id = _new_external_id()</pre></td></tr><tr><td>756</td><td><pre>    return id</pre></td></tr><tr><td>757</td><td><pre></pre></td></tr><tr><td>758</td><td><pre></pre></td></tr><tr><td>759</td><td><pre>def _new_external_id():</pre></td></tr><tr><td>760</td><td><pre>    digits_and_letters = random.sample(DIGITS_AND_LETTERS, 9)</pre></td></tr><tr><td>761</td><td><pre>    return ''.join(digits_and_letters)</pre></td></tr><tr><td>762</td><td><pre></pre></td></tr><tr><td>763</td><td><pre></pre></td></tr><tr><td>764</td><td><pre>def _already_exists(id):</pre></td></tr><tr><td>765</td><td><pre>    db = database.get_db()</pre></td></tr><tr class="accepted"><td>766</td><td><pre>    results = db.where('pins', external_id=id)</pre></td></tr><tr><td>767</td><td><pre>    for _ in results:</pre></td></tr><tr><td>768</td><td><pre>        return True</pre></td></tr><tr><td>769</td><td><pre>    return False</pre></td></tr><tr><td>770</td><td><pre></pre></td></tr><tr><td>771</td><td><pre></pre></td></tr><tr><td>772</td><td><pre>class FollowOrUnfollowBoard(BaseAPI):</pre></td></tr><tr><td>773</td><td><pre>    """</pre></td></tr><tr><td>774</td><td><pre>    Allows to follow a given board if it was not already followed,</pre></td></tr><tr><td>775</td><td><pre>    Removes follow in case follow was set before.</pre></td></tr><tr><td>776</td><td><pre>    Works as toggle on/off</pre></td></tr><tr><td>777</td><td><pre></pre></td></tr><tr><td>778</td><td><pre>    :link: /api/image/follow-board</pre></td></tr><tr><td>779</td><td><pre>    """</pre></td></tr><tr><td>780</td><td><pre>    def POST(self):</pre></td></tr><tr><td>781</td><td><pre>        """</pre></td></tr><tr><td>782</td><td><pre>        :param str board_id: id of the board to follow</pre></td></tr><tr><td>783</td><td><pre>        :param str csid_from_client: CSID from client</pre></td></tr><tr><td>784</td><td><pre>        :param str user_id: id of the user who follows the board</pre></td></tr><tr><td>785</td><td><pre></pre></td></tr><tr><td>786</td><td><pre>        :response data: returns status:ok</pre></td></tr><tr><td>787</td><td><pre>        :example usage: curl --data "csid_from_client=1&amp;user_id=98&amp;board_id=15" http://localhost:8080/api/image/follow-board</pre></td></tr><tr><td>788</td><td><pre>        """</pre></td></tr><tr><td>789</td><td><pre>        request_data = web.input()</pre></td></tr><tr><td>790</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>791</td><td><pre>        user_id = request_data.get('user_id')</pre></td></tr><tr><td>792</td><td><pre>        board_id = request_data.get('board_id')</pre></td></tr><tr><td>793</td><td><pre>        try:</pre></td></tr><tr class="accepted"><td>794</td><td><pre>            db.insert('boards_followers', follower_id=user_id,</pre></td></tr><tr class="accepted"><td>795</td><td><pre>                      board_id=board_id)</pre></td></tr><tr class="accepted"><td>796</td><td><pre>            data = "Following"</pre></td></tr><tr class="accepted"><td>797</td><td><pre>        except Exception:</pre></td></tr><tr class="accepted"><td>798</td><td><pre>            db.delete('boards_followers',</pre></td></tr><tr class="accepted"><td>799</td><td><pre>                      where="follower_id=$uid and board_id=$bid",</pre></td></tr><tr class="accepted"><td>800</td><td><pre>                      vars={'uid': user_id, 'bid': board_id})</pre></td></tr><tr><td>801</td><td><pre>            data = "Follow"</pre></td></tr><tr><td>802</td><td><pre>        return api_response(data=data,</pre></td></tr><tr><td>803</td><td><pre>                            csid_from_client=csid_from_client,</pre></td></tr><tr><td>804</td><td><pre>                            csid_from_server="")</pre></td></tr><tr><td>805</td><td><pre></pre></td></tr></tbody></table>
</article></body></html>