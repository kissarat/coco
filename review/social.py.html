<html><head><title>social.py</title><link rel="stylesheet" type="text/css" href="/style.css"></head><body><article>
    <div id="container"><div class="comment ui-draggable ui-draggable-handle" style="top: 14372px; left: 18px;" data-lines="[799,800,801,802,803]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 12464px; left: 18px;" data-lines="[693,694,695,696,697,698,699,700,701,702]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 8846px; left: 18px;" data-lines="[492,493,494,495,496]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 8558px; left: 18px;" data-lines="[476,477,478,479,480,481,482,483,484]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 7496px; left: 18px;" data-lines="[417,418,419,420,421,422,423]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 6560px; left: 18px;" data-lines="[365,366,367,368,369,370,371,372,373]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 5372px; left: 18px;" data-lines="[299,300,301,302,303,304,305,306,307,308,309]">sql</div><div class="comment ui-draggable ui-draggable-handle" style="top: 1844px; left: 18px;" data-lines="[103]">sql</div></div>
    <table id="source"><tbody><tr><td>1</td><td><pre>import web</pre></td></tr><tr><td>2</td><td><pre>import os</pre></td></tr><tr><td>3</td><td><pre></pre></td></tr><tr><td>4</td><td><pre>from api.utils import api_response, save_api_request</pre></td></tr><tr><td>5</td><td><pre>from api.entities import UserProfile</pre></td></tr><tr><td>6</td><td><pre></pre></td></tr><tr><td>7</td><td><pre>from api.views.base import BaseAPI</pre></td></tr><tr><td>8</td><td><pre>from mypinnings.database import connect_db</pre></td></tr><tr><td>9</td><td><pre>import facebook</pre></td></tr><tr><td>10</td><td><pre>import urllib</pre></td></tr><tr><td>11</td><td><pre>import requests</pre></td></tr><tr><td>12</td><td><pre></pre></td></tr><tr><td>13</td><td><pre>from api.models.picture_comment import PictureComment</pre></td></tr><tr><td>14</td><td><pre>from api.models.picture_like import PictureLike</pre></td></tr><tr><td>15</td><td><pre></pre></td></tr><tr><td>16</td><td><pre>db = connect_db()</pre></td></tr><tr><td>17</td><td><pre></pre></td></tr><tr><td>18</td><td><pre></pre></td></tr><tr><td>19</td><td><pre>class PostingOnUserPage(BaseAPI):</pre></td></tr><tr><td>20</td><td><pre>    """</pre></td></tr><tr><td>21</td><td><pre>    Provides sharing pins to social networks</pre></td></tr><tr><td>22</td><td><pre></pre></td></tr><tr><td>23</td><td><pre>    :link: /api/social/poup</pre></td></tr><tr><td>24</td><td><pre>    """</pre></td></tr><tr><td>25</td><td><pre>    def POST(self):</pre></td></tr><tr><td>26</td><td><pre>        """</pre></td></tr><tr><td>27</td><td><pre>        Share pins to social network</pre></td></tr><tr><td>28</td><td><pre>        Method PostingOnUserPage must receive next required params:</pre></td></tr><tr><td>29</td><td><pre></pre></td></tr><tr><td>30</td><td><pre>        :param str share_list: list of pin's ids</pre></td></tr><tr><td>31</td><td><pre>        :param str access_token: access token for social network</pre></td></tr><tr><td>32</td><td><pre>        :param str social_network: name of social network</pre></td></tr><tr><td>33</td><td><pre>        (for example 'facebook')</pre></td></tr><tr><td>34</td><td><pre>        :response data: list of pin ids to share, e.g. [10, 20, 30]</pre></td></tr><tr><td>35</td><td><pre></pre></td></tr><tr><td>36</td><td><pre>        """</pre></td></tr><tr><td>37</td><td><pre>        request_data = web.input(</pre></td></tr><tr><td>38</td><td><pre>            share_list=[],</pre></td></tr><tr><td>39</td><td><pre>        )</pre></td></tr><tr><td>40</td><td><pre></pre></td></tr><tr><td>41</td><td><pre>        # Get data from request</pre></td></tr><tr><td>42</td><td><pre>        share_list = map(int, request_data.get("share_list"))</pre></td></tr><tr><td>43</td><td><pre>        access_token = request_data.get("access_token")</pre></td></tr><tr><td>44</td><td><pre>        social_network = request_data.get("social_network")</pre></td></tr><tr><td>45</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>46</td><td><pre>        logintoken = request_data.get('logintoken')</pre></td></tr><tr><td>47</td><td><pre>        user_status, user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>48</td><td><pre></pre></td></tr><tr><td>49</td><td><pre>        # User id contains error code</pre></td></tr><tr><td>50</td><td><pre>        if not user_status:</pre></td></tr><tr><td>51</td><td><pre>            return user</pre></td></tr><tr><td>52</td><td><pre></pre></td></tr><tr><td>53</td><td><pre>        csid_from_server = user['seriesid']</pre></td></tr><tr><td>54</td><td><pre></pre></td></tr><tr><td>55</td><td><pre>        # Initialize default posted pins list</pre></td></tr><tr><td>56</td><td><pre>        posted_pins = []</pre></td></tr><tr><td>57</td><td><pre>        # Setting default status code as 200</pre></td></tr><tr><td>58</td><td><pre>        status = 200</pre></td></tr><tr><td>59</td><td><pre>        # Setting empty error</pre></td></tr><tr><td>60</td><td><pre>        error_code = ""</pre></td></tr><tr><td>61</td><td><pre></pre></td></tr><tr><td>62</td><td><pre>        # Check input data and set appropriate code if not valid</pre></td></tr><tr><td>63</td><td><pre>        if not access_token or not social_network:</pre></td></tr><tr><td>64</td><td><pre>            status = 400</pre></td></tr><tr><td>65</td><td><pre>            error_code = "Invalid input data"</pre></td></tr><tr><td>66</td><td><pre>        else:</pre></td></tr><tr><td>67</td><td><pre>            posted_pins, status, error_code = share(</pre></td></tr><tr><td>68</td><td><pre>                access_token,</pre></td></tr><tr><td>69</td><td><pre>                share_list,</pre></td></tr><tr><td>70</td><td><pre>                social_network,</pre></td></tr><tr><td>71</td><td><pre>            )</pre></td></tr><tr><td>72</td><td><pre></pre></td></tr><tr><td>73</td><td><pre>        # Setting data for return</pre></td></tr><tr><td>74</td><td><pre>        data = {</pre></td></tr><tr><td>75</td><td><pre>            "posted_pins": posted_pins</pre></td></tr><tr><td>76</td><td><pre>        }</pre></td></tr><tr><td>77</td><td><pre></pre></td></tr><tr><td>78</td><td><pre>        response = api_response(data=data,</pre></td></tr><tr><td>79</td><td><pre>                                status=status,</pre></td></tr><tr><td>80</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>81</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>82</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>83</td><td><pre>        return response</pre></td></tr><tr><td>84</td><td><pre></pre></td></tr><tr><td>85</td><td><pre></pre></td></tr><tr><td>86</td><td><pre>def share(access_token, share_list, social_network="facebook"):</pre></td></tr><tr><td>87</td><td><pre>    # Initialize default access token status</pre></td></tr><tr><td>88</td><td><pre>    access_token_status = True</pre></td></tr><tr><td>89</td><td><pre></pre></td></tr><tr><td>90</td><td><pre>    # Get status of access token for social network</pre></td></tr><tr><td>91</td><td><pre>    if social_network == "facebook":</pre></td></tr><tr><td>92</td><td><pre>        access_token_status = check_facebook_access_token(access_token)</pre></td></tr><tr><td>93</td><td><pre>    if social_network == "linkedin":</pre></td></tr><tr><td>94</td><td><pre>        access_token_status = check_linkedin_access_token(access_token)</pre></td></tr><tr><td>95</td><td><pre></pre></td></tr><tr><td>96</td><td><pre>    if not access_token_status:</pre></td></tr><tr><td>97</td><td><pre>        return [], 400, "Bad access token for social network"</pre></td></tr><tr><td>98</td><td><pre></pre></td></tr><tr><td>99</td><td><pre>    # Initialize shared pins list</pre></td></tr><tr><td>100</td><td><pre>    shared_pins = []</pre></td></tr><tr><td>101</td><td><pre></pre></td></tr><tr><td>102</td><td><pre>    for pin_id in share_list:</pre></td></tr><tr class="accepted"><td>103</td><td><pre>        pin = db.select('pins', vars={'id': pin_id}, where='id=$id')</pre></td></tr><tr><td>104</td><td><pre></pre></td></tr><tr><td>105</td><td><pre>        if len(pin) == 0:</pre></td></tr><tr><td>106</td><td><pre>            continue</pre></td></tr><tr><td>107</td><td><pre></pre></td></tr><tr><td>108</td><td><pre>        pin = pin[0]</pre></td></tr><tr><td>109</td><td><pre>        message = ""</pre></td></tr><tr><td>110</td><td><pre>        link = ""</pre></td></tr><tr><td>111</td><td><pre></pre></td></tr><tr><td>112</td><td><pre>        if pin.get('name'):</pre></td></tr><tr><td>113</td><td><pre>            message += pin.get('name') + "\n"</pre></td></tr><tr><td>114</td><td><pre>        if pin.get('description'):</pre></td></tr><tr><td>115</td><td><pre>            message += pin.get('description') + "\n"</pre></td></tr><tr><td>116</td><td><pre>        if pin.get('price'):</pre></td></tr><tr><td>117</td><td><pre>            message += "Price: " + pin.get('price') + "\n"</pre></td></tr><tr><td>118</td><td><pre>        if pin.get('link'):</pre></td></tr><tr><td>119</td><td><pre>            link = pin.get('link')</pre></td></tr><tr><td>120</td><td><pre></pre></td></tr><tr><td>121</td><td><pre>        image_url = pin.get('image_url')</pre></td></tr><tr><td>122</td><td><pre></pre></td></tr><tr><td>123</td><td><pre>        share_pin_status = False</pre></td></tr><tr><td>124</td><td><pre>        if social_network == "facebook":</pre></td></tr><tr><td>125</td><td><pre>            share_pin_status = share_via_facebook(access_token,</pre></td></tr><tr><td>126</td><td><pre>                                                  message,</pre></td></tr><tr><td>127</td><td><pre>                                                  link,</pre></td></tr><tr><td>128</td><td><pre>                                                  image_url)</pre></td></tr><tr><td>129</td><td><pre></pre></td></tr><tr><td>130</td><td><pre>        if social_network == "linkedin":</pre></td></tr><tr><td>131</td><td><pre>            share_pin_status = share_via_linkedin(access_token,</pre></td></tr><tr><td>132</td><td><pre>                                                  message,</pre></td></tr><tr><td>133</td><td><pre>                                                  link,</pre></td></tr><tr><td>134</td><td><pre>                                                  image_url)</pre></td></tr><tr><td>135</td><td><pre></pre></td></tr><tr><td>136</td><td><pre>        if share_pin_status:</pre></td></tr><tr><td>137</td><td><pre>            shared_pins.append(pin_id)</pre></td></tr><tr><td>138</td><td><pre></pre></td></tr><tr><td>139</td><td><pre>    return shared_pins, 200, ""</pre></td></tr><tr><td>140</td><td><pre></pre></td></tr><tr><td>141</td><td><pre></pre></td></tr><tr><td>142</td><td><pre>def check_facebook_access_token(access_token):</pre></td></tr><tr><td>143</td><td><pre>    try:</pre></td></tr><tr><td>144</td><td><pre>        graph = facebook.GraphAPI(access_token)</pre></td></tr><tr><td>145</td><td><pre>        profile = graph.get_object("me")</pre></td></tr><tr><td>146</td><td><pre>        return True</pre></td></tr><tr><td>147</td><td><pre>    except facebook.GraphAPIError, exc:</pre></td></tr><tr><td>148</td><td><pre>        return False</pre></td></tr><tr><td>149</td><td><pre></pre></td></tr><tr><td>150</td><td><pre></pre></td></tr><tr><td>151</td><td><pre>def check_linkedin_access_token(access_token):</pre></td></tr><tr><td>152</td><td><pre>    try:</pre></td></tr><tr><td>153</td><td><pre>        url = 'https://api.linkedin.com/v1/people/~' + \</pre></td></tr><tr><td>154</td><td><pre>            '?oauth2_access_token=%s' % access_token</pre></td></tr><tr><td>155</td><td><pre></pre></td></tr><tr><td>156</td><td><pre>        result = requests.get(url)</pre></td></tr><tr><td>157</td><td><pre></pre></td></tr><tr><td>158</td><td><pre>        if result.status_code == 200:</pre></td></tr><tr><td>159</td><td><pre>            return True</pre></td></tr><tr><td>160</td><td><pre>        else:</pre></td></tr><tr><td>161</td><td><pre>            return False</pre></td></tr><tr><td>162</td><td><pre>    except Exception, exc:</pre></td></tr><tr><td>163</td><td><pre>        return False</pre></td></tr><tr><td>164</td><td><pre></pre></td></tr><tr><td>165</td><td><pre></pre></td></tr><tr><td>166</td><td><pre>def share_via_facebook(access_token, message, link, image_url):</pre></td></tr><tr><td>167</td><td><pre>    if link:</pre></td></tr><tr><td>168</td><td><pre>        message += link + "\n"</pre></td></tr><tr><td>169</td><td><pre></pre></td></tr><tr><td>170</td><td><pre>    try:</pre></td></tr><tr><td>171</td><td><pre>        graph = facebook.GraphAPI(access_token)</pre></td></tr><tr><td>172</td><td><pre>        if image_url:</pre></td></tr><tr><td>173</td><td><pre>            graph.put_photo(urllib.urlopen(image_url), message)</pre></td></tr><tr><td>174</td><td><pre>        else:</pre></td></tr><tr><td>175</td><td><pre>            graph.put_object("me", "feed", message=message)</pre></td></tr><tr><td>176</td><td><pre></pre></td></tr><tr><td>177</td><td><pre>        return True</pre></td></tr><tr><td>178</td><td><pre>    except Exception, exc:</pre></td></tr><tr><td>179</td><td><pre>        return False</pre></td></tr><tr><td>180</td><td><pre></pre></td></tr><tr><td>181</td><td><pre></pre></td></tr><tr><td>182</td><td><pre>def share_via_linkedin(access_token, message, link, image_url):</pre></td></tr><tr><td>183</td><td><pre>    try:</pre></td></tr><tr><td>184</td><td><pre>        url = 'https://api.linkedin.com/v1/people/~/shares' + \</pre></td></tr><tr><td>185</td><td><pre>            '?oauth2_access_token=%s' % access_token</pre></td></tr><tr><td>186</td><td><pre>        data = ""</pre></td></tr><tr><td>187</td><td><pre>        data += "&lt;share&gt;"</pre></td></tr><tr><td>188</td><td><pre>        data += "&lt;content&gt;"</pre></td></tr><tr><td>189</td><td><pre>        data += "&lt;description&gt;%s&lt;/description&gt;" % message</pre></td></tr><tr><td>190</td><td><pre>        data += "&lt;submitted-url&gt;%s&lt;/submitted-url&gt;" % link</pre></td></tr><tr><td>191</td><td><pre></pre></td></tr><tr><td>192</td><td><pre>        if image_url:</pre></td></tr><tr><td>193</td><td><pre>            data += "&lt;submitted-image-url&gt;%s&lt;/submitted-image-url&gt;" % image_url</pre></td></tr><tr><td>194</td><td><pre></pre></td></tr><tr><td>195</td><td><pre>        data += "&lt;/content&gt;"</pre></td></tr><tr><td>196</td><td><pre>        data += "&lt;visibility&gt;"</pre></td></tr><tr><td>197</td><td><pre>        data += "&lt;code&gt;anyone&lt;/code&gt;"</pre></td></tr><tr><td>198</td><td><pre>        data += "&lt;/visibility&gt;"</pre></td></tr><tr><td>199</td><td><pre>        data += "&lt;/share&gt;"</pre></td></tr><tr><td>200</td><td><pre></pre></td></tr><tr><td>201</td><td><pre>        headers = {'content-type': 'application/xml'}</pre></td></tr><tr><td>202</td><td><pre></pre></td></tr><tr><td>203</td><td><pre>        result = requests.post(</pre></td></tr><tr><td>204</td><td><pre>            url,</pre></td></tr><tr><td>205</td><td><pre>            data=data,</pre></td></tr><tr><td>206</td><td><pre>            headers=headers</pre></td></tr><tr><td>207</td><td><pre>        )</pre></td></tr><tr><td>208</td><td><pre></pre></td></tr><tr><td>209</td><td><pre>        if result.status_code == 201:</pre></td></tr><tr><td>210</td><td><pre>            return True</pre></td></tr><tr><td>211</td><td><pre>        else:</pre></td></tr><tr><td>212</td><td><pre>            return False</pre></td></tr><tr><td>213</td><td><pre>    except Exception, exc:</pre></td></tr><tr><td>214</td><td><pre>        return False</pre></td></tr><tr><td>215</td><td><pre></pre></td></tr><tr><td>216</td><td><pre></pre></td></tr><tr><td>217</td><td><pre>class QueryFollows(BaseAPI):</pre></td></tr><tr><td>218</td><td><pre>    """</pre></td></tr><tr><td>219</td><td><pre>    Class responsible for providing access to followers of a given user</pre></td></tr><tr><td>220</td><td><pre></pre></td></tr><tr><td>221</td><td><pre>    :link: /api/social/query/following</pre></td></tr><tr><td>222</td><td><pre>    :link: /api/social/query/followed-by</pre></td></tr><tr><td>223</td><td><pre>    """</pre></td></tr><tr><td>224</td><td><pre>    def POST(self, query_type):</pre></td></tr><tr><td>225</td><td><pre>        """ Depending on query_type returns</pre></td></tr><tr><td>226</td><td><pre>        a list of users, following or followed by current user</pre></td></tr><tr><td>227</td><td><pre></pre></td></tr><tr><td>228</td><td><pre>        :param str logintoken: Login token to authenticate current user</pre></td></tr><tr><td>229</td><td><pre>        :param str user_id: Quieried user id.</pre></td></tr><tr><td>230</td><td><pre></pre></td></tr><tr><td>231</td><td><pre>        :to test: curl --data "csid_from_client=1&amp;user_id=78&amp;logintoken=RxPu7fLYgv" http://localhost:8080/api/social/query/following</pre></td></tr><tr><td>232</td><td><pre>        :to test: curl --data "csid_from_client=1&amp;user_id=78&amp;logintoken=RxPu7fLYgv" http://localhost:8080/api/social/query/followed-by</pre></td></tr><tr><td>233</td><td><pre>        :response data: list of users</pre></td></tr><tr><td>234</td><td><pre>        """</pre></td></tr><tr><td>235</td><td><pre>        data = web.input()</pre></td></tr><tr><td>236</td><td><pre>        uid = data.get("user_id")</pre></td></tr><tr><td>237</td><td><pre>        logintoken = data.get("logintoken", "")</pre></td></tr><tr><td>238</td><td><pre>        status, response_or_user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>239</td><td><pre></pre></td></tr><tr><td>240</td><td><pre>        # Login was not successful</pre></td></tr><tr><td>241</td><td><pre>        if not status:</pre></td></tr><tr><td>242</td><td><pre>            return response_or_user</pre></td></tr><tr><td>243</td><td><pre>        if query_type == "followed-by":</pre></td></tr><tr><td>244</td><td><pre>            follows = UserProfile.query_followed_by(uid, response_or_user.id)</pre></td></tr><tr><td>245</td><td><pre>        else:</pre></td></tr><tr><td>246</td><td><pre>            follows = UserProfile.query_following(uid, response_or_user.id)</pre></td></tr><tr><td>247</td><td><pre>        csid_from_client = data.pop('csid_from_client')</pre></td></tr><tr><td>248</td><td><pre>        return api_response(data=follows, csid_from_client=csid_from_client,</pre></td></tr><tr><td>249</td><td><pre>                            csid_from_server="")</pre></td></tr><tr><td>250</td><td><pre></pre></td></tr><tr><td>251</td><td><pre></pre></td></tr><tr><td>252</td><td><pre>class SocialMessage(BaseAPI):</pre></td></tr><tr><td>253</td><td><pre>    """</pre></td></tr><tr><td>254</td><td><pre>    API method that sends message to user</pre></td></tr><tr><td>255</td><td><pre>    :link: /api/social/message</pre></td></tr><tr><td>256</td><td><pre>    """</pre></td></tr><tr><td>257</td><td><pre>    def POST(self):</pre></td></tr><tr><td>258</td><td><pre>        """</pre></td></tr><tr><td>259</td><td><pre>        :param str logintoken: Logintoken used fo authentication</pre></td></tr><tr><td>260</td><td><pre>        :param str content: Content of the message</pre></td></tr><tr><td>261</td><td><pre>        :param str user_id_list: List of user ids</pre></td></tr><tr><td>262</td><td><pre>        :param str csid_from_client: CSID from client</pre></td></tr><tr><td>263</td><td><pre></pre></td></tr><tr><td>264</td><td><pre>        :response data: empty</pre></td></tr><tr><td>265</td><td><pre>        """</pre></td></tr><tr><td>266</td><td><pre></pre></td></tr><tr><td>267</td><td><pre>        request_data = web.input(</pre></td></tr><tr><td>268</td><td><pre>            user_id_list=[],</pre></td></tr><tr><td>269</td><td><pre>        )</pre></td></tr><tr><td>270</td><td><pre></pre></td></tr><tr><td>271</td><td><pre>        data = {}</pre></td></tr><tr><td>272</td><td><pre>        status = 200</pre></td></tr><tr><td>273</td><td><pre>        csid_from_server = None</pre></td></tr><tr><td>274</td><td><pre>        error_code = ""</pre></td></tr><tr><td>275</td><td><pre></pre></td></tr><tr><td>276</td><td><pre>        # Get data from request</pre></td></tr><tr><td>277</td><td><pre>        user_id_list = map(int,</pre></td></tr><tr><td>278</td><td><pre>                           request_data.get("user_id_list"))</pre></td></tr><tr><td>279</td><td><pre>        content = request_data.get("content")</pre></td></tr><tr><td>280</td><td><pre></pre></td></tr><tr><td>281</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>282</td><td><pre>        logintoken = request_data.get('logintoken')</pre></td></tr><tr><td>283</td><td><pre>        user_status, user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>284</td><td><pre></pre></td></tr><tr><td>285</td><td><pre>        if not content:</pre></td></tr><tr><td>286</td><td><pre>            status = 400</pre></td></tr><tr><td>287</td><td><pre>            error_code = "Content cannot be empty"</pre></td></tr><tr><td>288</td><td><pre></pre></td></tr><tr><td>289</td><td><pre>        # User id contains error code</pre></td></tr><tr><td>290</td><td><pre>        if not user_status:</pre></td></tr><tr><td>291</td><td><pre>            return user</pre></td></tr><tr><td>292</td><td><pre></pre></td></tr><tr><td>293</td><td><pre>        csid_from_server = user['seriesid']</pre></td></tr><tr><td>294</td><td><pre>        from_user_id = user['id']</pre></td></tr><tr><td>295</td><td><pre></pre></td></tr><tr><td>296</td><td><pre>        if status == 200:</pre></td></tr><tr><td>297</td><td><pre>            for to_user_id in user_id_list:</pre></td></tr><tr><td>298</td><td><pre>                ids = sorted([to_user_id, from_user_id])</pre></td></tr><tr class="accepted"><td>299</td><td><pre>                convo = db.select('convos',</pre></td></tr><tr class="accepted"><td>300</td><td><pre>                                  where='id1 = $id1 and id2 = $id2',</pre></td></tr><tr class="accepted"><td>301</td><td><pre>                                  vars={'id1': ids[0], 'id2': ids[1]})\</pre></td></tr><tr class="accepted"><td>302</td><td><pre>                    .list()</pre></td></tr><tr class="accepted"><td>303</td><td><pre>                if convo:</pre></td></tr><tr class="accepted"><td>304</td><td><pre>                    convo_id = convo[0].id</pre></td></tr><tr class="accepted"><td>305</td><td><pre>                else:</pre></td></tr><tr class="accepted"><td>306</td><td><pre>                    convo_id = db.insert('convos', id1=ids[0], id2=ids[1])</pre></td></tr><tr class="accepted"><td>307</td><td><pre></pre></td></tr><tr class="accepted"><td>308</td><td><pre>                db.insert('messages', convo_id=convo_id, sender=from_user_id,</pre></td></tr><tr class="accepted"><td>309</td><td><pre>                          content=content)</pre></td></tr><tr><td>310</td><td><pre></pre></td></tr><tr><td>311</td><td><pre>        response = api_response(data=data,</pre></td></tr><tr><td>312</td><td><pre>                                status=status,</pre></td></tr><tr><td>313</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>314</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>315</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>316</td><td><pre>        return response</pre></td></tr><tr><td>317</td><td><pre></pre></td></tr><tr><td>318</td><td><pre></pre></td></tr><tr><td>319</td><td><pre>class SocialMessageToConversation(BaseAPI):</pre></td></tr><tr><td>320</td><td><pre>    """</pre></td></tr><tr><td>321</td><td><pre>    API method that sends message to conversation</pre></td></tr><tr><td>322</td><td><pre></pre></td></tr><tr><td>323</td><td><pre>    :link: /api/social/message_to_conversation</pre></td></tr><tr><td>324</td><td><pre>    """</pre></td></tr><tr><td>325</td><td><pre>    def POST(self):</pre></td></tr><tr><td>326</td><td><pre>        """</pre></td></tr><tr><td>327</td><td><pre>        :param str logintoken: Logintoken used fo authentication</pre></td></tr><tr><td>328</td><td><pre>        :param str content: Content of the message</pre></td></tr><tr><td>329</td><td><pre>        :param str user_id_list: List of conversation ids</pre></td></tr><tr><td>330</td><td><pre>        :param str csid_from_client: CSID from client</pre></td></tr><tr><td>331</td><td><pre></pre></td></tr><tr><td>332</td><td><pre>        :response data: empty</pre></td></tr><tr><td>333</td><td><pre>        """</pre></td></tr><tr><td>334</td><td><pre>        request_data = web.input(</pre></td></tr><tr><td>335</td><td><pre>            conversation_id_list=[],</pre></td></tr><tr><td>336</td><td><pre>        )</pre></td></tr><tr><td>337</td><td><pre></pre></td></tr><tr><td>338</td><td><pre>        data = {}</pre></td></tr><tr><td>339</td><td><pre>        status = 200</pre></td></tr><tr><td>340</td><td><pre>        csid_from_server = None</pre></td></tr><tr><td>341</td><td><pre>        error_code = ""</pre></td></tr><tr><td>342</td><td><pre></pre></td></tr><tr><td>343</td><td><pre>        # Get data from request</pre></td></tr><tr><td>344</td><td><pre>        conversation_id_list = map(int,</pre></td></tr><tr><td>345</td><td><pre>                           request_data.get("conversation_id_list"))</pre></td></tr><tr><td>346</td><td><pre>        content = request_data.get("content")</pre></td></tr><tr><td>347</td><td><pre></pre></td></tr><tr><td>348</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>349</td><td><pre>        logintoken = request_data.get('logintoken')</pre></td></tr><tr><td>350</td><td><pre>        user_status, user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>351</td><td><pre></pre></td></tr><tr><td>352</td><td><pre>        if not content:</pre></td></tr><tr><td>353</td><td><pre>            status = 400</pre></td></tr><tr><td>354</td><td><pre>            error_code = "Content cannot be empty"</pre></td></tr><tr><td>355</td><td><pre></pre></td></tr><tr><td>356</td><td><pre>        # User id contains error code</pre></td></tr><tr><td>357</td><td><pre>        if not user_status:</pre></td></tr><tr><td>358</td><td><pre>            return user</pre></td></tr><tr><td>359</td><td><pre></pre></td></tr><tr><td>360</td><td><pre>        csid_from_server = user['seriesid']</pre></td></tr><tr><td>361</td><td><pre>        from_user_id = user['id']</pre></td></tr><tr><td>362</td><td><pre></pre></td></tr><tr><td>363</td><td><pre>        if status == 200:</pre></td></tr><tr><td>364</td><td><pre>            for conversation_id in conversation_id_list:</pre></td></tr><tr class="accepted"><td>365</td><td><pre>                convo = db.select('convos',</pre></td></tr><tr class="accepted"><td>366</td><td><pre>                                  where='id = $id',</pre></td></tr><tr class="accepted"><td>367</td><td><pre>                                  vars={'id': conversation_id})\</pre></td></tr><tr class="accepted"><td>368</td><td><pre>                    .list()</pre></td></tr><tr class="accepted"><td>369</td><td><pre>                if len(convo) &gt; 0:</pre></td></tr><tr class="accepted"><td>370</td><td><pre>                    db.insert('messages',</pre></td></tr><tr class="accepted"><td>371</td><td><pre>                              convo_id=conversation_id,</pre></td></tr><tr class="accepted"><td>372</td><td><pre>                              sender=from_user_id,</pre></td></tr><tr class="accepted"><td>373</td><td><pre>                              content=content)</pre></td></tr><tr><td>374</td><td><pre></pre></td></tr><tr><td>375</td><td><pre>        response = api_response(data=data,</pre></td></tr><tr><td>376</td><td><pre>                                status=status,</pre></td></tr><tr><td>377</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>378</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>379</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>380</td><td><pre>        return response</pre></td></tr><tr><td>381</td><td><pre></pre></td></tr><tr><td>382</td><td><pre></pre></td></tr><tr><td>383</td><td><pre>class SocialQueryConversations(BaseAPI):</pre></td></tr><tr><td>384</td><td><pre>    """</pre></td></tr><tr><td>385</td><td><pre>    API method that allows to get conversations</pre></td></tr><tr><td>386</td><td><pre></pre></td></tr><tr><td>387</td><td><pre>    :link: /api/social/query/conversations</pre></td></tr><tr><td>388</td><td><pre>    """</pre></td></tr><tr><td>389</td><td><pre>    def POST(self):</pre></td></tr><tr><td>390</td><td><pre>        """</pre></td></tr><tr><td>391</td><td><pre>        :param str logintoken: Logintoken used fo authentication</pre></td></tr><tr><td>392</td><td><pre>        :param str csid_from_client: CSID from client</pre></td></tr><tr><td>393</td><td><pre></pre></td></tr><tr><td>394</td><td><pre>        :response data: returns a list of conversations</pre></td></tr><tr><td>395</td><td><pre>        """</pre></td></tr><tr><td>396</td><td><pre>        request_data = web.input(</pre></td></tr><tr><td>397</td><td><pre>        )</pre></td></tr><tr><td>398</td><td><pre></pre></td></tr><tr><td>399</td><td><pre>        data = {}</pre></td></tr><tr><td>400</td><td><pre>        status = 200</pre></td></tr><tr><td>401</td><td><pre>        csid_from_server = None</pre></td></tr><tr><td>402</td><td><pre>        error_code = ""</pre></td></tr><tr><td>403</td><td><pre></pre></td></tr><tr><td>404</td><td><pre>        # Get data from</pre></td></tr><tr><td>405</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>406</td><td><pre>        logintoken = request_data.get('logintoken')</pre></td></tr><tr><td>407</td><td><pre>        user_status, user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>408</td><td><pre></pre></td></tr><tr><td>409</td><td><pre>        # User id contains error code</pre></td></tr><tr><td>410</td><td><pre>        if not user_status:</pre></td></tr><tr><td>411</td><td><pre>            return user</pre></td></tr><tr><td>412</td><td><pre></pre></td></tr><tr><td>413</td><td><pre>        csid_from_server = user['seriesid']</pre></td></tr><tr><td>414</td><td><pre>        from_user_id = user['id']</pre></td></tr><tr><td>415</td><td><pre></pre></td></tr><tr class=""><td>416</td><td><pre>        if status == 200:</pre></td></tr><tr class="accepted"><td>417</td><td><pre>            convos = db.query('''</pre></td></tr><tr class="accepted"><td>418</td><td><pre>                select convos.*, users.name from convos</pre></td></tr><tr class="accepted"><td>419</td><td><pre>                    join users on users.id = (case</pre></td></tr><tr class="accepted"><td>420</td><td><pre>                        when convos.id1 = $id then convos.id2</pre></td></tr><tr class="accepted"><td>421</td><td><pre>                        else convos.id1</pre></td></tr><tr class="accepted"><td>422</td><td><pre>                    end)</pre></td></tr><tr class="accepted"><td>423</td><td><pre>                where id1 = $id or id2 = $id''', vars={'id': from_user_id})\</pre></td></tr><tr><td>424</td><td><pre>                .list()</pre></td></tr><tr><td>425</td><td><pre>            if len(convos) &gt; 0:</pre></td></tr><tr><td>426</td><td><pre>                data['conversations'] = convos</pre></td></tr><tr><td>427</td><td><pre>            else:</pre></td></tr><tr><td>428</td><td><pre>                data['conversations'] = []</pre></td></tr><tr><td>429</td><td><pre></pre></td></tr><tr><td>430</td><td><pre>        response = api_response(data=data,</pre></td></tr><tr><td>431</td><td><pre>                                status=status,</pre></td></tr><tr><td>432</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>433</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>434</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>435</td><td><pre>        return response</pre></td></tr><tr><td>436</td><td><pre></pre></td></tr><tr><td>437</td><td><pre></pre></td></tr><tr><td>438</td><td><pre>class SocialQueryMessages(BaseAPI):</pre></td></tr><tr><td>439</td><td><pre>    """</pre></td></tr><tr><td>440</td><td><pre>    API method that allows to get messages from conversation</pre></td></tr><tr><td>441</td><td><pre>    """</pre></td></tr><tr><td>442</td><td><pre>    def POST(self):</pre></td></tr><tr><td>443</td><td><pre>        """</pre></td></tr><tr><td>444</td><td><pre>        :param str logintoken: Logintoken used fo authentication</pre></td></tr><tr><td>445</td><td><pre>        :param str conversation_id: Conversation id</pre></td></tr><tr><td>446</td><td><pre>        :param str csid_from_client: CSID from client</pre></td></tr><tr><td>447</td><td><pre></pre></td></tr><tr><td>448</td><td><pre>        :response data: list of all messages, for a given conversation</pre></td></tr><tr><td>449</td><td><pre>        """</pre></td></tr><tr><td>450</td><td><pre>        request_data = web.input(</pre></td></tr><tr><td>451</td><td><pre>        )</pre></td></tr><tr><td>452</td><td><pre></pre></td></tr><tr><td>453</td><td><pre>        data = {}</pre></td></tr><tr><td>454</td><td><pre>        status = 200</pre></td></tr><tr><td>455</td><td><pre>        csid_from_server = None</pre></td></tr><tr><td>456</td><td><pre>        error_code = ""</pre></td></tr><tr><td>457</td><td><pre></pre></td></tr><tr><td>458</td><td><pre>        # Get data from</pre></td></tr><tr><td>459</td><td><pre>        conversation_id = request_data.get('conversation_id', False)</pre></td></tr><tr><td>460</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>461</td><td><pre>        logintoken = request_data.get('logintoken')</pre></td></tr><tr><td>462</td><td><pre>        user_status, user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>463</td><td><pre></pre></td></tr><tr><td>464</td><td><pre>        # User id contains error code</pre></td></tr><tr><td>465</td><td><pre>        if not user_status:</pre></td></tr><tr><td>466</td><td><pre>            return user</pre></td></tr><tr><td>467</td><td><pre></pre></td></tr><tr><td>468</td><td><pre>        csid_from_server = user['seriesid']</pre></td></tr><tr><td>469</td><td><pre>        from_user_id = user['id']</pre></td></tr><tr><td>470</td><td><pre></pre></td></tr><tr><td>471</td><td><pre>        if not conversation_id:</pre></td></tr><tr><td>472</td><td><pre>            status = 400</pre></td></tr><tr><td>473</td><td><pre>            error_code = "conversation_id cannot be empty"</pre></td></tr><tr><td>474</td><td><pre></pre></td></tr><tr><td>475</td><td><pre>        if status == 200:</pre></td></tr><tr class="accepted"><td>476</td><td><pre>            convo = db.query('''</pre></td></tr><tr class="accepted"><td>477</td><td><pre>                select convos.id, users.id as user_id, users.name from convos</pre></td></tr><tr class="accepted"><td>478</td><td><pre>                    join users on users.id = (case</pre></td></tr><tr class="accepted"><td>479</td><td><pre>                        when convos.id1 = $id then convos.id2</pre></td></tr><tr class="accepted"><td>480</td><td><pre>                        else convos.id1</pre></td></tr><tr class="accepted"><td>481</td><td><pre>                    end)</pre></td></tr><tr class="accepted"><td>482</td><td><pre>                where (convos.id = $convo_id and</pre></td></tr><tr class="accepted"><td>483</td><td><pre>                       convos.id1 = $id or convos.id2 = $id)''',</pre></td></tr><tr class="accepted"><td>484</td><td><pre>                vars={'convo_id': conversation_id, 'id': from_user_id})\</pre></td></tr><tr><td>485</td><td><pre>                .list()</pre></td></tr><tr><td>486</td><td><pre>            if not convo:</pre></td></tr><tr><td>487</td><td><pre>                status = 400</pre></td></tr><tr><td>488</td><td><pre>                error_code = "conversation not found"</pre></td></tr><tr><td>489</td><td><pre>            else:</pre></td></tr><tr><td>490</td><td><pre>                data['conversation'] = convo[0]</pre></td></tr><tr><td>491</td><td><pre></pre></td></tr><tr class="accepted"><td>492</td><td><pre>                messages = db.query('''</pre></td></tr><tr class="accepted"><td>493</td><td><pre>                    select messages.*, users.name from messages</pre></td></tr><tr class="accepted"><td>494</td><td><pre>                        join users on users.id = messages.sender</pre></td></tr><tr class="accepted"><td>495</td><td><pre>                    where messages.convo_id = $convo_id''',</pre></td></tr><tr class="accepted"><td>496</td><td><pre>                    vars={'convo_id': conversation_id})\</pre></td></tr><tr><td>497</td><td><pre>                    .list()</pre></td></tr><tr><td>498</td><td><pre>                if len(messages) &gt; 0:</pre></td></tr><tr><td>499</td><td><pre>                    data['messages'] = messages</pre></td></tr><tr><td>500</td><td><pre>                else:</pre></td></tr><tr><td>501</td><td><pre>                    data['messages'] = []</pre></td></tr><tr><td>502</td><td><pre></pre></td></tr><tr><td>503</td><td><pre>        response = api_response(data=data,</pre></td></tr><tr><td>504</td><td><pre>                                status=status,</pre></td></tr><tr><td>505</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>506</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>507</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>508</td><td><pre>        return response</pre></td></tr><tr><td>509</td><td><pre></pre></td></tr><tr><td>510</td><td><pre></pre></td></tr><tr><td>511</td><td><pre>class AddCommentToPicture(BaseAPI):</pre></td></tr><tr><td>512</td><td><pre>    """</pre></td></tr><tr><td>513</td><td><pre>    API method that adds comment to picture</pre></td></tr><tr><td>514</td><td><pre></pre></td></tr><tr><td>515</td><td><pre>    :link: /api/social/picture/add_comment</pre></td></tr><tr><td>516</td><td><pre>    """</pre></td></tr><tr><td>517</td><td><pre>    def POST(self):</pre></td></tr><tr><td>518</td><td><pre>        """</pre></td></tr><tr><td>519</td><td><pre>        :param str logintoken: Logintoken used fo authentication</pre></td></tr><tr><td>520</td><td><pre>        :param str comment: Comment body</pre></td></tr><tr><td>521</td><td><pre>        :param str picture_id: Id if the photo to comment</pre></td></tr><tr><td>522</td><td><pre>        :param str csid_from_client: CSID from client</pre></td></tr><tr><td>523</td><td><pre></pre></td></tr><tr><td>524</td><td><pre>        :response data: echoes given comment</pre></td></tr><tr><td>525</td><td><pre>        """</pre></td></tr><tr><td>526</td><td><pre>        request_data = web.input(</pre></td></tr><tr><td>527</td><td><pre>        )</pre></td></tr><tr><td>528</td><td><pre></pre></td></tr><tr><td>529</td><td><pre>        data = {}</pre></td></tr><tr><td>530</td><td><pre>        status = 200</pre></td></tr><tr><td>531</td><td><pre>        csid_from_server = None</pre></td></tr><tr><td>532</td><td><pre>        error_code = ""</pre></td></tr><tr><td>533</td><td><pre></pre></td></tr><tr><td>534</td><td><pre>        # Get data from request</pre></td></tr><tr><td>535</td><td><pre>        comment = request_data.get("comment")</pre></td></tr><tr><td>536</td><td><pre>        picture_id = request_data.get("picture_id")</pre></td></tr><tr><td>537</td><td><pre></pre></td></tr><tr><td>538</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>539</td><td><pre>        logintoken = request_data.get('logintoken')</pre></td></tr><tr><td>540</td><td><pre>        user_status, user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>541</td><td><pre></pre></td></tr><tr><td>542</td><td><pre>        if not comment:</pre></td></tr><tr><td>543</td><td><pre>            status = 400</pre></td></tr><tr><td>544</td><td><pre>            error_code = "Comment cannot be empty"</pre></td></tr><tr><td>545</td><td><pre></pre></td></tr><tr><td>546</td><td><pre>        if not picture_id:</pre></td></tr><tr><td>547</td><td><pre>            status = 400</pre></td></tr><tr><td>548</td><td><pre>            error_code = "picture_id cannot be empty"</pre></td></tr><tr><td>549</td><td><pre></pre></td></tr><tr><td>550</td><td><pre>        # User id contains error code</pre></td></tr><tr><td>551</td><td><pre>        if not user_status:</pre></td></tr><tr><td>552</td><td><pre>            return user</pre></td></tr><tr><td>553</td><td><pre></pre></td></tr><tr><td>554</td><td><pre>        csid_from_server = user['seriesid']</pre></td></tr><tr><td>555</td><td><pre>        from_user_id = user['id']</pre></td></tr><tr><td>556</td><td><pre></pre></td></tr><tr><td>557</td><td><pre>        if status == 200:</pre></td></tr><tr><td>558</td><td><pre>            comment = PictureComment(picture_id, from_user_id, comment)</pre></td></tr><tr><td>559</td><td><pre></pre></td></tr><tr><td>560</td><td><pre>            web.ctx.orm.add(comment)</pre></td></tr><tr><td>561</td><td><pre>            web.ctx.orm.commit()</pre></td></tr><tr><td>562</td><td><pre></pre></td></tr><tr><td>563</td><td><pre>            if comment.id:</pre></td></tr><tr><td>564</td><td><pre>                data['comment'] = comment.to_serializable_dict()</pre></td></tr><tr><td>565</td><td><pre></pre></td></tr><tr><td>566</td><td><pre>        response = api_response(data=data,</pre></td></tr><tr><td>567</td><td><pre>                                status=status,</pre></td></tr><tr><td>568</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>569</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>570</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>571</td><td><pre>        return response</pre></td></tr><tr><td>572</td><td><pre></pre></td></tr><tr><td>573</td><td><pre></pre></td></tr><tr><td>574</td><td><pre>class LikeDislikePicture(BaseAPI):</pre></td></tr><tr><td>575</td><td><pre>    """</pre></td></tr><tr><td>576</td><td><pre>    API method that adds likes to picture</pre></td></tr><tr><td>577</td><td><pre></pre></td></tr><tr><td>578</td><td><pre>    :link: /api/social/picture/like_dislike</pre></td></tr><tr><td>579</td><td><pre>    """</pre></td></tr><tr><td>580</td><td><pre>    def POST(self):</pre></td></tr><tr><td>581</td><td><pre>        """</pre></td></tr><tr><td>582</td><td><pre>        :param str logintoken: Logintoken used fo authentication</pre></td></tr><tr><td>583</td><td><pre>        :param str picture_id: Id if the photo to comment</pre></td></tr><tr><td>584</td><td><pre>        :param str csid_from_client: CSID from client</pre></td></tr><tr><td>585</td><td><pre>        :param str action: action for picture (like|dislike)</pre></td></tr><tr><td>586</td><td><pre></pre></td></tr><tr><td>587</td><td><pre>        :response data: returns list of likes and them quantity</pre></td></tr><tr><td>588</td><td><pre>        """</pre></td></tr><tr><td>589</td><td><pre>        request_data = web.input(</pre></td></tr><tr><td>590</td><td><pre>        )</pre></td></tr><tr><td>591</td><td><pre></pre></td></tr><tr><td>592</td><td><pre>        data = {}</pre></td></tr><tr><td>593</td><td><pre>        status = 200</pre></td></tr><tr><td>594</td><td><pre>        csid_from_server = None</pre></td></tr><tr><td>595</td><td><pre>        error_code = ""</pre></td></tr><tr><td>596</td><td><pre></pre></td></tr><tr><td>597</td><td><pre>        # Get data from request</pre></td></tr><tr><td>598</td><td><pre>        picture_id = request_data.get("picture_id")</pre></td></tr><tr><td>599</td><td><pre>        action = request_data.get("action", "like")</pre></td></tr><tr><td>600</td><td><pre></pre></td></tr><tr><td>601</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>602</td><td><pre>        logintoken = request_data.get('logintoken')</pre></td></tr><tr><td>603</td><td><pre>        user_status, user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>604</td><td><pre></pre></td></tr><tr><td>605</td><td><pre>        if not picture_id:</pre></td></tr><tr><td>606</td><td><pre>            status = 400</pre></td></tr><tr><td>607</td><td><pre>            error_code = "picture_id cannot be empty"</pre></td></tr><tr><td>608</td><td><pre></pre></td></tr><tr><td>609</td><td><pre>        # User id contains error code</pre></td></tr><tr><td>610</td><td><pre>        if not user_status:</pre></td></tr><tr><td>611</td><td><pre>            return user</pre></td></tr><tr><td>612</td><td><pre></pre></td></tr><tr><td>613</td><td><pre>        csid_from_server = user['seriesid']</pre></td></tr><tr><td>614</td><td><pre>        user_id = user['id']</pre></td></tr><tr><td>615</td><td><pre></pre></td></tr><tr><td>616</td><td><pre>        if status == 200:</pre></td></tr><tr><td>617</td><td><pre>            if not action or action == "like":</pre></td></tr><tr><td>618</td><td><pre>                likes = web.ctx.orm.query(PictureLike).filter(</pre></td></tr><tr><td>619</td><td><pre>                    PictureLike.picture_id == picture_id,</pre></td></tr><tr><td>620</td><td><pre>                    PictureLike.user_id == user_id</pre></td></tr><tr><td>621</td><td><pre>                ).all()</pre></td></tr><tr><td>622</td><td><pre></pre></td></tr><tr><td>623</td><td><pre>                if len(likes) == 0:</pre></td></tr><tr><td>624</td><td><pre>                    like = PictureLike(picture_id, user_id)</pre></td></tr><tr><td>625</td><td><pre></pre></td></tr><tr><td>626</td><td><pre>                    web.ctx.orm.add(like)</pre></td></tr><tr><td>627</td><td><pre>                    web.ctx.orm.commit()</pre></td></tr><tr><td>628</td><td><pre></pre></td></tr><tr><td>629</td><td><pre>                    data['action'] = 'like'</pre></td></tr><tr><td>630</td><td><pre>            else:</pre></td></tr><tr><td>631</td><td><pre>                likes = web.ctx.orm.query(PictureLike).filter(</pre></td></tr><tr><td>632</td><td><pre>                    PictureLike.picture_id == picture_id,</pre></td></tr><tr><td>633</td><td><pre>                    PictureLike.user_id == user_id</pre></td></tr><tr><td>634</td><td><pre>                ).all()</pre></td></tr><tr><td>635</td><td><pre></pre></td></tr><tr><td>636</td><td><pre>                for like in likes:</pre></td></tr><tr><td>637</td><td><pre>                    web.ctx.orm.delete(like)</pre></td></tr><tr><td>638</td><td><pre>                </pre></td></tr><tr><td>639</td><td><pre>                web.ctx.orm.commit()</pre></td></tr><tr><td>640</td><td><pre></pre></td></tr><tr><td>641</td><td><pre>                data['action'] = 'dislike'</pre></td></tr><tr><td>642</td><td><pre></pre></td></tr><tr><td>643</td><td><pre>            likes = web.ctx.orm.query(PictureLike).filter(</pre></td></tr><tr><td>644</td><td><pre>                PictureLike.picture_id == picture_id</pre></td></tr><tr><td>645</td><td><pre>            ).all()</pre></td></tr><tr><td>646</td><td><pre></pre></td></tr><tr><td>647</td><td><pre>            data['likes'] = \</pre></td></tr><tr><td>648</td><td><pre>                [like.to_serializable_dict() for like in likes]</pre></td></tr><tr><td>649</td><td><pre>            data['count_likes'] = len(likes)</pre></td></tr><tr><td>650</td><td><pre></pre></td></tr><tr><td>651</td><td><pre>        response = api_response(data=data,</pre></td></tr><tr><td>652</td><td><pre>                                status=status,</pre></td></tr><tr><td>653</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>654</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>655</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>656</td><td><pre>        return response</pre></td></tr><tr><td>657</td><td><pre></pre></td></tr><tr><td>658</td><td><pre></pre></td></tr><tr><td>659</td><td><pre># class GetCommentsToPhoto(BaseAPI):</pre></td></tr><tr><td>660</td><td><pre>#     """</pre></td></tr><tr><td>661</td><td><pre>#     API method that allows to get comments to photo</pre></td></tr><tr><td>662</td><td><pre>#     """</pre></td></tr><tr><td>663</td><td><pre>#     def POST(self):</pre></td></tr><tr><td>664</td><td><pre>#         request_data = web.input(</pre></td></tr><tr><td>665</td><td><pre>#         )</pre></td></tr><tr><td>666</td><td><pre></pre></td></tr><tr><td>667</td><td><pre>#         data = {}</pre></td></tr><tr><td>668</td><td><pre>#         status = 200</pre></td></tr><tr><td>669</td><td><pre>#         csid_from_server = None</pre></td></tr><tr><td>670</td><td><pre>#         error_code = ""</pre></td></tr><tr><td>671</td><td><pre></pre></td></tr><tr><td>672</td><td><pre>#         # Get data from</pre></td></tr><tr><td>673</td><td><pre>#         photo_id = request_data.get("photo_id")</pre></td></tr><tr><td>674</td><td><pre></pre></td></tr><tr><td>675</td><td><pre>#         csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>676</td><td><pre></pre></td></tr><tr><td>677</td><td><pre>#         if not photo_id:</pre></td></tr><tr><td>678</td><td><pre>#             status = 400</pre></td></tr><tr><td>679</td><td><pre>#             error_code = "photo_id cannot be empty"</pre></td></tr><tr><td>680</td><td><pre></pre></td></tr><tr><td>681</td><td><pre>#         if status == 200:</pre></td></tr><tr><td>682</td><td><pre>#             data['comments'] = get_comments_to_photo(photo_id)</pre></td></tr><tr><td>683</td><td><pre></pre></td></tr><tr><td>684</td><td><pre>#         response = api_response(data=data,</pre></td></tr><tr><td>685</td><td><pre>#                                 status=status,</pre></td></tr><tr><td>686</td><td><pre>#                                 error_code=error_code,</pre></td></tr><tr><td>687</td><td><pre>#                                 csid_from_client=csid_from_client,</pre></td></tr><tr><td>688</td><td><pre>#                                 csid_from_server=csid_from_server)</pre></td></tr><tr><td>689</td><td><pre>#         return response</pre></td></tr><tr><td>690</td><td><pre></pre></td></tr><tr><td>691</td><td><pre></pre></td></tr><tr><td>692</td><td><pre>def get_comments_to_photo(photo_id):</pre></td></tr><tr class="accepted"><td>693</td><td><pre>    comments = db.query('''</pre></td></tr><tr class="accepted"><td>694</td><td><pre>        select profile_photo_comments.*,</pre></td></tr><tr class="accepted"><td>695</td><td><pre>        users.id as user_id, users.name, photos.*</pre></td></tr><tr class="accepted"><td>696</td><td><pre>        from profile_photo_comments</pre></td></tr><tr class="accepted"><td>697</td><td><pre>        LEFT join users</pre></td></tr><tr class="accepted"><td>698</td><td><pre>        on users.id = profile_photo_comments.user_id</pre></td></tr><tr class="accepted"><td>699</td><td><pre>        LEFT join photos</pre></td></tr><tr class="accepted"><td>700</td><td><pre>        on photos.id = users.pic</pre></td></tr><tr class="accepted"><td>701</td><td><pre>        where profile_photo_comments.photo_id = $id''',</pre></td></tr><tr class="accepted"><td>702</td><td><pre>        vars={'id': photo_id})\</pre></td></tr><tr><td>703</td><td><pre>        .list()</pre></td></tr><tr><td>704</td><td><pre></pre></td></tr><tr><td>705</td><td><pre>    return comments</pre></td></tr><tr><td>706</td><td><pre></pre></td></tr><tr><td>707</td><td><pre># class GetLikesToPhoto(BaseAPI):</pre></td></tr><tr><td>708</td><td><pre>#     """</pre></td></tr><tr><td>709</td><td><pre>#     API method that allows to get likes to photo</pre></td></tr><tr><td>710</td><td><pre>#     """</pre></td></tr><tr><td>711</td><td><pre>#     def POST(self):</pre></td></tr><tr><td>712</td><td><pre>#         request_data = web.input(</pre></td></tr><tr><td>713</td><td><pre>#         )</pre></td></tr><tr><td>714</td><td><pre></pre></td></tr><tr><td>715</td><td><pre>#         data = {}</pre></td></tr><tr><td>716</td><td><pre>#         status = 200</pre></td></tr><tr><td>717</td><td><pre>#         csid_from_server = None</pre></td></tr><tr><td>718</td><td><pre>#         error_code = ""</pre></td></tr><tr><td>719</td><td><pre></pre></td></tr><tr><td>720</td><td><pre>#         # Get data from</pre></td></tr><tr><td>721</td><td><pre>#         photo_id = request_data.get("photo_id")</pre></td></tr><tr><td>722</td><td><pre></pre></td></tr><tr><td>723</td><td><pre>#         csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>724</td><td><pre></pre></td></tr><tr><td>725</td><td><pre>#         user_id = None</pre></td></tr><tr><td>726</td><td><pre>#         logintoken = request_data.get('logintoken', None)</pre></td></tr><tr><td>727</td><td><pre>#         if logintoken:</pre></td></tr><tr><td>728</td><td><pre>#             user_status, user = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>729</td><td><pre>#             if user_status:</pre></td></tr><tr><td>730</td><td><pre>#                 user_id = user['id']</pre></td></tr><tr><td>731</td><td><pre></pre></td></tr><tr><td>732</td><td><pre>#         if not photo_id:</pre></td></tr><tr><td>733</td><td><pre>#             status = 400</pre></td></tr><tr><td>734</td><td><pre>#             error_code = "photo_id cannot be empty"</pre></td></tr><tr><td>735</td><td><pre></pre></td></tr><tr><td>736</td><td><pre>#         if status == 200:</pre></td></tr><tr><td>737</td><td><pre>#             likes = db.query('''</pre></td></tr><tr><td>738</td><td><pre>#                 select profile_photo_likes.*,</pre></td></tr><tr><td>739</td><td><pre>#                 users.name, photos.*</pre></td></tr><tr><td>740</td><td><pre>#                 from profile_photo_likes</pre></td></tr><tr><td>741</td><td><pre>#                 left join users</pre></td></tr><tr><td>742</td><td><pre>#                 on users.id = profile_photo_likes.user_id</pre></td></tr><tr><td>743</td><td><pre>#                 left join photos</pre></td></tr><tr><td>744</td><td><pre>#                 on photos.id = users.pic</pre></td></tr><tr><td>745</td><td><pre>#                 where profile_photo_likes.photo_id = $id''',</pre></td></tr><tr><td>746</td><td><pre>#                 vars={'id': photo_id})\</pre></td></tr><tr><td>747</td><td><pre>#                 .list()</pre></td></tr><tr><td>748</td><td><pre></pre></td></tr><tr><td>749</td><td><pre>#             data['likes'] = likes</pre></td></tr><tr><td>750</td><td><pre>#             data['count_likes'] = len(likes)</pre></td></tr><tr><td>751</td><td><pre></pre></td></tr><tr><td>752</td><td><pre>#             data['liked'] = False</pre></td></tr><tr><td>753</td><td><pre>#             if user_id:</pre></td></tr><tr><td>754</td><td><pre>#                 for like in likes:</pre></td></tr><tr><td>755</td><td><pre>#                     if like['user_id'] == user_id:</pre></td></tr><tr><td>756</td><td><pre>#                         data['liked'] = True</pre></td></tr><tr><td>757</td><td><pre>#                         break</pre></td></tr><tr><td>758</td><td><pre></pre></td></tr><tr><td>759</td><td><pre>#         response = api_response(data=data,</pre></td></tr><tr><td>760</td><td><pre>#                                 status=status,</pre></td></tr><tr><td>761</td><td><pre>#                                 error_code=error_code,</pre></td></tr><tr><td>762</td><td><pre>#                                 csid_from_client=csid_from_client,</pre></td></tr><tr><td>763</td><td><pre>#                                 csid_from_server=csid_from_server)</pre></td></tr><tr><td>764</td><td><pre>#         return response</pre></td></tr><tr><td>765</td><td><pre></pre></td></tr><tr><td>766</td><td><pre>class LikeOrUnlikePin(BaseAPI):</pre></td></tr><tr><td>767</td><td><pre>    """</pre></td></tr><tr><td>768</td><td><pre>    Adds like to a certain pin.</pre></td></tr><tr><td>769</td><td><pre></pre></td></tr><tr><td>770</td><td><pre>    :link: /api/social/pin/like</pre></td></tr><tr><td>771</td><td><pre>    """</pre></td></tr><tr><td>772</td><td><pre>    def POST(self):</pre></td></tr><tr><td>773</td><td><pre>        """</pre></td></tr><tr><td>774</td><td><pre>        :param str logintoken: Logintoken used fo authentication</pre></td></tr><tr><td>775</td><td><pre>        :param str csid_from_client: CSID from client</pre></td></tr><tr><td>776</td><td><pre>        :param str pin_id: Identifier of the pin</pre></td></tr><tr><td>777</td><td><pre></pre></td></tr><tr><td>778</td><td><pre>        :response data: returns status: success, if like was added</pre></td></tr><tr><td>779</td><td><pre></pre></td></tr><tr><td>780</td><td><pre>        :example usage: curl --data "csid_from_client=1&amp;logintoken=RxPu7fLYgv&amp;pin_id=46" http://localhost:8080/api/social/pin/like-unlike</pre></td></tr><tr><td>781</td><td><pre>        """</pre></td></tr><tr><td>782</td><td><pre>        request_data = web.input()</pre></td></tr><tr><td>783</td><td><pre>        csid_from_client = request_data.get('csid_from_client')</pre></td></tr><tr><td>784</td><td><pre></pre></td></tr><tr><td>785</td><td><pre>        logintoken = request_data.get('logintoken')</pre></td></tr><tr><td>786</td><td><pre>        status, user_or_response = self.authenticate_by_token(logintoken)</pre></td></tr><tr><td>787</td><td><pre>        if not status:</pre></td></tr><tr><td>788</td><td><pre>            return user_or_response</pre></td></tr><tr><td>789</td><td><pre>        csid_from_server = user_or_response['seriesid']</pre></td></tr><tr><td>790</td><td><pre></pre></td></tr><tr><td>791</td><td><pre>        pin_id = request_data.get('pin_id')</pre></td></tr><tr><td>792</td><td><pre>        if not pin_id:</pre></td></tr><tr><td>793</td><td><pre>            error_code = "Pin id can't be empty"</pre></td></tr><tr><td>794</td><td><pre>            return api_response(data={},</pre></td></tr><tr><td>795</td><td><pre>                                error_code=error_code,</pre></td></tr><tr><td>796</td><td><pre>                                csid_from_client=csid_from_client,</pre></td></tr><tr><td>797</td><td><pre>                                csid_from_server=csid_from_server)</pre></td></tr><tr><td>798</td><td><pre>        try:</pre></td></tr><tr class="accepted"><td>799</td><td><pre>            db.insert('likes', user_id=user_or_response["id"], pin_id=pin_id)</pre></td></tr><tr class="accepted"><td>800</td><td><pre>        except Exception:</pre></td></tr><tr class="accepted"><td>801</td><td><pre>            db.delete('likes', where='user_id = $uid and pin_id = $pid',</pre></td></tr><tr class="accepted"><td>802</td><td><pre>                      vars={'uid': user_or_response["id"],</pre></td></tr><tr class="accepted"><td>803</td><td><pre>                            'pid': pin_id})</pre></td></tr><tr><td>804</td><td><pre>        return api_response(data={'status': 'success'},</pre></td></tr><tr><td>805</td><td><pre>                            csid_from_client=csid_from_client,</pre></td></tr><tr><td>806</td><td><pre>                            csid_from_server=csid_from_server)</pre></td></tr><tr><td>807</td><td><pre></pre></td></tr></tbody></table>
</article></body></html>